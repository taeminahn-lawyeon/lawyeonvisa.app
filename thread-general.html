<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ì“°ë ˆë“œ - ë²•ë¬´ë²•ì¸ ë¡œì—°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/ui-components.css">
    
    <!-- Tally ì„¤ë¬¸ ìœ„ì ¯ -->
    <script src="https://tally.so/widgets/embed.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .thread-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            background: white;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }

        /* Thread Header */
        .thread-header {
            padding: 20px 24px;
            border-bottom: 2px solid #f3f4f6;
            background: white;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #f3f4f6;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #e5e7eb;
        }

        .thread-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .service-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .service-meta {
            color: #6b7280;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Thread Main */
        .thread-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            flex-shrink: 0;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            line-height: 1.6;
            color: #1f2937;
            font-size: 15px;
            word-break: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
            align-self: flex-start;
        }

        .message-file {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 280px;
        }

        .message-file:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .file-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 13px;
            color: #1f2937;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* System Message */
        .system-message {
            text-align: center;
            margin: 30px 0;
        }

        .system-message-content {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: white;
            border-top: 2px solid #f3f4f6;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center; /* ì¤‘ì•™ ì •ë ¬ë¡œ ë²„íŠ¼ê³¼ ì…ë ¥ì°½ ë†’ì´ ë§ì¶¤ */
        }

        .input-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-btn {
            width: 42px;
            height: 42px;
            min-height: 42px; /* ìµœì†Œ ë†’ì´ ê³ ì • */
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .input-btn:hover {
            background: #f3f4f6;
            border-color: #3182F6;
            color: #3182F6;
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            min-height: 42px; /* ë²„íŠ¼ê³¼ ë™ì¼í•œ ìµœì†Œ ë†’ì´ */
            max-height: 120px;
            transition: all 0.3s ease;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .message-input:focus {
            outline: none;
            border-color: #3182F6;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 42px;
            height: 42px;
            min-height: 42px; /* ìµœì†Œ ë†’ì´ ê³ ì • */
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* ë²„íŠ¼ í¬ê¸° ê³ ì • */
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            transform: none;
        }

        /* Sidebar */
        .thread-sidebar {
            width: 320px;
            background: #f9fafb;
            border-left: 2px solid #f3f4f6;
            overflow-y: auto;
            padding: 24px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-size: 15px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .document-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            border-color: #3182F6;
            background: #f0f4ff;
        }

        .document-icon {
            width: 36px;
            height: 36px;
            background: #3182F6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .document-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        /* ì •ë³´ í† ê¸€ ë²„íŠ¼ (ëª¨ë°”ì¼ìš©) */
        .info-toggle-btn {
            display: none; /* ë°ìŠ¤í¬í†±ì—ì„œëŠ” ìˆ¨ê¹€ */
            padding: 8px 12px;
            background: #EEF2FF;
            border: 2px solid #C7D2FE;
            border-radius: 8px;
            color: #4F46E5;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            align-items: center;
            gap: 6px;
        }

        .info-toggle-btn:hover {
            background: #E0E7FF;
            border-color: #6366F1;
        }

        .info-toggle-btn.active {
            background: #4F46E5;
            color: white;
            border-color: #4F46E5;
        }
        
        /* ì²¨ë¶€íŒŒì¼ í† ê¸€ ë²„íŠ¼ (ëª¨ë°”ì¼ìš©) */
        .docs-toggle-btn {
            display: none; /* ë°ìŠ¤í¬í†±ì—ì„œëŠ” ìˆ¨ê¹€ */
            padding: 10px 16px;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
        }

        .docs-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(49, 130, 246, 0.4);
        }

        .docs-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .docs-toggle-btn.active i.fa-chevron-down {
            transform: rotate(180deg);
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 968px) {
            /* ê¸€ë¡œë²Œ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ - í•œê¸€ ë‹¨ì–´ ë‹¨ìœ„ */
            * {
                word-break: keep-all;
                overflow-wrap: break-word;
            }
            
            body {
                overflow-y: auto;
                height: auto;
            }

            .thread-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                max-width: 100%;
            }

            /* ì‚¬ì´ë“œë°” - ëª¨ë°”ì¼ì—ì„œ ê¸°ë³¸ ìˆ¨ê¹€ (í† ê¸€ë¡œ í‘œì‹œ) */
            .thread-sidebar {
                display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
                width: 100%;
                border-left: none;
                border-top: 2px solid #f3f4f6;
                padding: 16px;
                order: 2; /* ë©”ì‹œì§€ ì˜ì—­ ì•„ë˜ë¡œ ë°°ì¹˜ */
                background: #f9fafb;
            }
            
            .thread-sidebar.mobile-visible {
                display: block;
                animation: slideDown 0.3s ease;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* ì²¨ë¶€íŒŒì¼ í† ê¸€ ë²„íŠ¼ - ëª¨ë°”ì¼ì—ì„œ í‘œì‹œ */
            .docs-toggle-btn {
                display: flex !important;
            }
            
            /* ì •ë³´ í† ê¸€ ë²„íŠ¼ - ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹€ (ëŒ€ì‹  ì²¨ë¶€íŒŒì¼ ë²„íŠ¼ ì‚¬ìš©) */
            .info-toggle-btn {
                display: none !important;
            }
            
            /* ì‚¬ì´ë“œë°” ì„¹ì…˜ ëª¨ë°”ì¼ ìµœì í™” */
            .sidebar-section {
                margin-bottom: 20px;
            }
            
            .sidebar-section h3 {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .info-item {
                padding: 10px;
                margin-bottom: 6px;
            }
            
            .info-label {
                font-size: 11px;
            }
            
            .info-value {
                font-size: 13px;
            }

            .thread-header {
                padding: 16px;
            }

            .header-top {
                flex-wrap: wrap;
                gap: 10px;
            }

            .back-btn {
                padding: 8px 12px;
                font-size: 14px;
                word-break: keep-all;
            }

            .service-title {
                font-size: 18px;
                line-height: 1.4;
                word-break: keep-all;
            }

            .service-meta {
                font-size: 13px;
                flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
                gap: 10px;
                white-space: nowrap; /* ë‚ ì§œ ì¤„ë°”ê¿ˆ ë°©ì§€ */
            }
            
            .service-meta span {
                white-space: nowrap; /* ê° í•­ëª© ì¤„ë°”ê¿ˆ ë°©ì§€ */
            }

            .status-badge {
                padding: 5px 12px;
                font-size: 12px;
                word-break: keep-all;
            }

            .messages-area {
                padding: 16px 12px;
                min-height: 50vh;
                order: 1; /* ë©”ì‹œì§€ ì˜ì—­ ìš°ì„  */
            }

            .message {
                gap: 8px;
                margin-bottom: 20px;
            }

            .message-content {
                max-width: 80%;
                min-width: 0;
            }

            .message-bubble {
                padding: 10px 14px;
                font-size: 14px;
                border-radius: 16px;
                line-height: 1.6;
                word-break: keep-all;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
                flex-shrink: 0;
            }

            .message-sender {
                font-size: 11px;
                word-break: keep-all;
            }

            .message-time {
                font-size: 10px;
            }

            /* ì…ë ¥ ì˜ì—­ - ëª¨ë°”ì¼ ìµœì í™” (í•˜ë‹¨ ê³ ì •) */
            .input-area {
                padding: 12px !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white;
                z-index: 100;
                border-top: 1px solid #e5e7eb;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            }
            
            /* ì…ë ¥ ì˜ì—­ ê³ ì •ìœ¼ë¡œ ì¸í•œ í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
            .messages-area {
                padding-bottom: 140px !important; /* ì…ë ¥ ì˜ì—­ + í† ê¸€ ë²„íŠ¼ ë†’ì´ */
            }

            .input-wrapper {
                gap: 8px !important;
                flex-wrap: nowrap !important;
                align-items: center !important;
            }

            /* ë²„íŠ¼ë“¤ ê°€ë¡œ ì •ë ¬ ìœ ì§€ */
            .input-controls {
                flex-direction: row !important;
                gap: 6px !important;
                flex-shrink: 0;
                align-items: center !important;
            }

            .input-btn {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                min-height: 40px !important;
                font-size: 16px !important;
                border-radius: 8px;
                flex-shrink: 0;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* ë©”ì‹œì§€ ì…ë ¥ì°½ - ëª¨ë°”ì¼ ìµœì í™” */
            .message-input-wrapper {
                flex: 1;
                min-width: 0; /* ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
                display: flex;
                align-items: center;
            }

            .message-input {
                font-size: 14px !important;
                padding: 10px 12px !important;
                height: 40px !important;
                min-height: 40px !important;
                max-height: 80px !important;
                border-radius: 10px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* í”Œë ˆì´ìŠ¤í™€ë” ìŠ¤íƒ€ì¼ */
            .message-input::placeholder {
                font-size: 13px;
                color: #9ca3af;
            }

            .send-btn {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                min-height: 40px !important;
                font-size: 16px !important;
                border-radius: 8px;
                flex-shrink: 0;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* íŒŒì¼ ì²¨ë¶€ ë©”ì‹œì§€ - ëª¨ë°”ì¼ ìµœì í™” */
            .message-file {
                padding: 10px;
                max-width: 100%;
                box-sizing: border-box;
            }

            .file-icon {
                width: 36px;
                height: 36px;
                font-size: 16px;
                flex-shrink: 0;
            }

            .file-name {
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .file-size {
                font-size: 11px;
            }

            .system-message {
                margin: 20px 0;
            }

            .system-message-content {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            /* ì²¨ë¶€íŒŒì¼ ë²„íŠ¼ ëª©ë¡ - ëª¨ë°”ì¼ */
            #documentsList button {
                font-size: 13px !important;
                padding: 10px !important;
            }
        }

        /* ============================================
           Tally ì„¤ë¬¸ ì„ë² ë“œ ìŠ¤íƒ€ì¼
           ============================================ */
        .tally-survey-card {
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border: 2px solid #C7D2FE;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            animation: fadeIn 0.4s ease;
        }

        .tally-survey-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .tally-survey-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .tally-survey-title {
            flex: 1;
        }

        .tally-survey-title h4 {
            font-size: 16px;
            font-weight: 700;
            color: #3730A3;
            margin-bottom: 4px;
        }

        .tally-survey-title p {
            font-size: 13px;
            color: #6366F1;
        }

        .tally-survey-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .tally-survey-status.pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .tally-survey-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .tally-survey-body {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .tally-survey-body iframe {
            display: block;
            width: 100%;
            border: none;
        }

        .tally-survey-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .tally-survey-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tally-survey-btn.primary {
            background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
            color: white;
        }

        .tally-survey-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .tally-survey-btn.secondary {
            background: white;
            color: #6366F1;
            border: 2px solid #C7D2FE;
        }

        .tally-survey-btn.secondary:hover {
            background: #EEF2FF;
        }

        .tally-survey-collapsed .tally-survey-body {
            display: none;
        }

        .tally-survey-completed {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border-color: #6EE7B7;
        }

        .tally-survey-completed .tally-survey-icon {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .tally-survey-completed .tally-survey-title h4 {
            color: #065F46;
        }

        .tally-survey-completed .tally-survey-title p {
            color: #10B981;
        }

        /* ì´ˆì†Œí˜• ëª¨ë°”ì¼ (iPhone SE ë“±) */
        @media (max-width: 375px) {
            .thread-header {
                padding: 12px;
            }

            .service-title {
                font-size: 16px;
            }

            .service-meta {
                font-size: 11px;
                gap: 8px;
                white-space: nowrap;
                overflow-x: auto;
            }
            
            .service-meta span {
                white-space: nowrap;
                flex-shrink: 0;
            }

            .messages-area {
                padding: 12px 10px;
                padding-bottom: 120px !important; /* ì…ë ¥ ì˜ì—­ ë†’ì´ */
            }

            .message {
                gap: 6px;
                margin-bottom: 16px;
            }

            .message-content {
                max-width: 78%;
            }

            .message-bubble {
                padding: 9px 12px;
                font-size: 13px;
                border-radius: 14px;
            }

            .message-avatar {
                width: 30px;
                height: 30px;
                font-size: 11px;
            }

            .message-file {
                padding: 8px 10px;
                max-width: 100%;
            }

            .file-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            /* ì…ë ¥ ì˜ì—­ - ì´ˆì†Œí˜• ëª¨ë°”ì¼ */
            .input-area {
                padding: 10px !important;
            }
            
            .input-wrapper {
                gap: 6px !important;
            }
            
            .input-controls {
                gap: 4px !important;
            }

            .input-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                min-height: 36px !important;
                font-size: 14px !important;
                border-radius: 6px;
            }

            .send-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                min-height: 36px !important;
                font-size: 14px !important;
                border-radius: 6px;
            }
            
            .message-input {
                font-size: 13px !important;
                padding: 8px 10px !important;
                height: 36px !important;
                min-height: 36px !important;
            }
            
            .message-input::placeholder {
                font-size: 12px;
            }
            
            /* ì‚¬ì´ë“œë°” - ì´ˆì†Œí˜• ëª¨ë°”ì¼ */
            .thread-sidebar {
                padding: 12px;
            }
            
            .sidebar-section h3 {
                font-size: 13px;
            }
            
            .info-item {
                padding: 8px;
            }
            
            .info-label {
                font-size: 10px;
            }
            
            .info-value {
                font-size: 12px;
            }
            
            #documentsList button {
                font-size: 12px !important;
                padding: 8px !important;
            }
            
            /* ì²¨ë¶€íŒŒì¼ í† ê¸€ ë²„íŠ¼ - ì´ˆì†Œí˜• ëª¨ë°”ì¼ */
            .docs-toggle-btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
                margin-top: 6px !important;
            }
            
            .docs-toggle-btn i {
                font-size: 11px;
            }

            /* Tally ì„¤ë¬¸ ëª¨ë°”ì¼ */
            .tally-survey-card {
                padding: 16px;
                margin: 16px 0;
            }

            .tally-survey-header {
                flex-wrap: wrap;
            }

            .tally-survey-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .tally-survey-title h4 {
                font-size: 14px;
            }

            .tally-survey-title p {
                font-size: 12px;
            }

            .tally-survey-actions {
                flex-direction: column;
            }

            .tally-survey-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="thread-container">
        <div class="thread-main">
            <div class="thread-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> ëŒì•„ê°€ê¸°
                    </button>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="info-toggle-btn" id="infoToggleBtn" onclick="toggleSidebar()" title="ì •ë³´ ë³´ê¸°">
                            <i class="fas fa-info-circle"></i> <span class="info-toggle-text">ì •ë³´</span>
                        </button>
                        <div class="status-badge processing" id="statusBadge">ì§„í–‰ì¤‘</div>
                    </div>
                </div>
                <div class="thread-info">
                    <div>
                        <div class="service-title" id="serviceTitle">ë¡œë”© ì¤‘...</div>
                        <div class="service-meta">
                            <span><i class="fas fa-calendar"></i> <span id="threadDate">-</span></span>
                            <span><i class="fas fa-building"></i> ì„¼í„° ë‹´ë‹¹ì</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="system-message">
                    <div class="system-message-content">
                        <i class="fas fa-check-circle"></i> ìƒë‹´ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                </div>

                <!-- ë©”ì‹œì§€ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-controls">
                        <button class="input-btn" onclick="attachFile()" title="íŒŒì¼ ì²¨ë¶€">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-btn" onclick="attachImage()" title="ì´ë¯¸ì§€ ì²¨ë¶€">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="message-input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="ë©”ì‹œì§€ ì…ë ¥..."
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="ì „ì†¡">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
                
                <!-- ëª¨ë°”ì¼ ì²¨ë¶€íŒŒì¼ í† ê¸€ ë²„íŠ¼ -->
                <button class="docs-toggle-btn" id="docsToggleBtn" onclick="toggleDocsPanel()">
                    <i class="fas fa-file-alt"></i>
                    <span>ì²¨ë¶€ì„œë¥˜ ë° ì§„í–‰í˜„í™© ë³´ê¸°</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>

        <div class="thread-sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-info-circle"></i> ì‹ ì²­ ì •ë³´</h3>
                <div class="info-item">
                    <div class="info-label">ì‹ ì²­ ë²ˆí˜¸</div>
                    <div class="info-value" id="applicationId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì‹ ì²­ì¼</div>
                    <div class="info-value" id="applicationDate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê²°ì œ ê¸ˆì•¡</div>
                    <div class="info-value" id="amount">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì„¼í„° ë‹´ë‹¹ì</div>
                    <div class="info-value">ë²•ë¬´ë²•ì¸ ë¡œì—°</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-file-alt"></i> ì²¨ë¶€ ì„œë¥˜</h3>
                <div id="documentsList">
                    <p style="color: #6B7280; font-size: 14px; padding: 12px 0;">ì•„ì§ ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-clock"></i> ì§„í–‰ í˜„í™©</h3>
                <div class="info-item">
                    <div class="info-label">í˜„ì¬ ë‹¨ê³„</div>
                    <div class="info-value" id="currentStatus">ì ‘ìˆ˜ ì™„ë£Œ</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì˜ˆìƒ ì™„ë£Œì¼</div>
                    <div class="info-value" id="expectedDate">-</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

    <script src="js/ui-components.js?v=20251218"></script>
    <script>
        // Toast ì•Œë¦¼ í•¨ìˆ˜ (ui-components.js ë¡œë“œ ì‹¤íŒ¨ ëŒ€ë¹„)
        function showToast(message, type = 'info', duration = 3000) {
            // ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´ (ui-components.js ë¡œë“œ ì‹¤íŒ¨ ì‹œ)
            if (typeof ToastNotification === 'undefined') {
                console.log(`[Toast ${type}] ${message}`);
                return;
            }
            
            // ì‹¤ì œ Toast í‘œì‹œ
            const toast = new ToastNotification();
            toast.show(message, type, duration);
        }
        
        // í˜ì´ì§€ ë¡œë“œ
        let threadId = null;
        let currentUser = null;
        let messageChannel = null;  // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… ì±„ë„

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ” [ì“°ë ˆë“œ] í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            
            // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
            if (typeof supabaseClient === 'undefined') {
                console.error('âŒ [ì“°ë ˆë“œ] supabaseClientê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }
            console.log('âœ… [ì“°ë ˆë“œ] supabaseClient í™•ì¸ë¨');
            
            const urlParams = new URLSearchParams(window.location.search);
            threadId = urlParams.get('thread_id') || urlParams.get('id');
            console.log('ğŸ” [ì“°ë ˆë“œ] URL íŒŒë¼ë¯¸í„°:', { thread_id: threadId });

            if (!threadId) {
                console.error('âŒ [ì“°ë ˆë“œ] ì“°ë ˆë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤');
                alert('ì“°ë ˆë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤.\n\në©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            // Supabase ì„¸ì…˜ í™•ì¸
            console.log('ğŸ” [ì“°ë ˆë“œ] ì„¸ì…˜ í™•ì¸ ì¤‘...');
            let session;
            try {
                session = await checkSession();
                console.log('âœ… [ì“°ë ˆë“œ] ì„¸ì…˜ í™•ì¸ ì™„ë£Œ:', session ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨');
            } catch (error) {
                console.error('âŒ [ì“°ë ˆë“œ] ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = 'index.html';
                return;
            }
            
            if (!session || !session.user) {
                console.error('âŒ [ì“°ë ˆë“œ] ì„¸ì…˜ ì—†ìŒ');
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                window.location.href = 'index.html';
                return;
            }
            console.log('âœ… [ì“°ë ˆë“œ] ì‚¬ìš©ì ì´ë©”ì¼:', session.user.email);
            
            // í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const profileResult = await getUserProfile(session.user.id);
            if (profileResult.success && profileResult.data) {
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: profileResult.data.name || session.user.email,
                    arc_front_url: profileResult.data.arc_front_url,
                    arc_back_url: profileResult.data.arc_back_url,
                    passport_url: profileResult.data.passport_url,
                    signature_url: profileResult.data.signature_url
                };
            } else {
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.email
                };
            }

            loadThread();
            loadMessages();
            loadMyDocuments(); // ë‚´ ì œì¶œ ì„œë¥˜ ë¡œë“œ
            
            // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… ì‹œì‘
            subscribeToMessages();
            
            // ìë™ ë¦¬ì‚¬ì´ì¦ˆ
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        });

        // ì“°ë ˆë“œ ì •ë³´ ë¡œë“œ
        async function loadThread() {
            if (!threadId) {
                console.error('âŒ [loadThread] threadIdê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            console.log('ğŸ” [loadThread] ì“°ë ˆë“œ ë¡œë“œ ì‹œì‘, ID:', threadId);
            
            try {
                // í˜„ì¬ ì‚¬ìš©ì í”„ë¡œí•„ í™•ì¸ (ê´€ë¦¬ì ê¶Œí•œ ì²´í¬)
                console.log('ğŸ” [loadThread] í”„ë¡œí•„ í™•ì¸ ì¤‘...');
                const profileResult = await getUserProfile(currentUser.id);
                const isAdmin = profileResult.success && 
                               profileResult.data && 
                               (profileResult.data.role === 'super_admin' || profileResult.data.role === 'partner_admin');
                console.log('âœ… [loadThread] ê´€ë¦¬ì ê¶Œí•œ:', isAdmin);
                
                // Supabaseì—ì„œ ì“°ë ˆë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                console.log('ğŸ” [loadThread] Supabaseì—ì„œ ì“°ë ˆë“œ ì¡°íšŒ ì¤‘...');
                let query = supabaseClient
                    .from('threads')
                    .select(`
                        *,
                        profiles!threads_user_id_fkey (
                            name,
                            email,
                            phone
                        )
                    `)
                    .eq('id', threadId);
                
                // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ user_id í•„í„° ì¶”ê°€ ë° archived ìƒíƒœ ì œì™¸
                if (!isAdmin) {
                    query = query
                        .eq('user_id', currentUser.id)
                        .neq('status', 'archived'); // ê³ ê°ì€ ë³´ê´€ëœ ì“°ë ˆë“œ ë³¼ ìˆ˜ ì—†ìŒ
                    console.log('ğŸ” [loadThread] ì¼ë°˜ ì‚¬ìš©ì í•„í„° ì ìš©');
                }
                
                const { data: thread, error } = await query.single();
                
                if (error || !thread) {
                    console.error('âŒ [loadThread] ì“°ë ˆë“œ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    console.error('âŒ [loadThread] ì—ëŸ¬ ìƒì„¸:', {
                        code: error?.code,
                        message: error?.message,
                        details: error?.details,
                        hint: error?.hint
                    });
                    console.error('âŒ [loadThread] ì¿¼ë¦¬ ì •ë³´:', {
                        threadId: threadId,
                        currentUserId: currentUser.id,
                        isAdmin: isAdmin
                    });
                    
                    let errorMessage = 'ì“°ë ˆë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n';
                    let redirectUrl = 'index.html';
                    
                    if (error?.code === 'PGRST116') {
                        errorMessage += 'ì´ìœ : ì“°ë ˆë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n';
                        errorMessage += 'â€¢ ì“°ë ˆë“œê°€ ì‚­ì œë˜ì—ˆê±°ë‚˜\n';
                        errorMessage += 'â€¢ ì˜ëª»ëœ ì“°ë ˆë“œ IDì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n';
                        errorMessage += 'ì‹ ì²­ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    } else if (error?.message) {
                        errorMessage += 'ì˜¤ë¥˜ ë‚´ìš©: ' + error.message + '\n\n';
                        errorMessage += 'ì‹ ì²­ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    } else {
                        errorMessage += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n';
                        errorMessage += 'ì‹ ì²­ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    }
                    
                    alert(errorMessage);
                    
                    // ì¼ë°˜ ì‚¬ìš©ììš© index.htmlë¡œ ì´ë™
                    window.location.href = redirectUrl;
                    return;
                }
                
                console.log('âœ… [loadThread] ì“°ë ˆë“œ ì¡°íšŒ ì„±ê³µ:', thread);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('serviceTitle').textContent = thread.service_name || 'ì„œë¹„ìŠ¤ëª… ì—†ìŒ';
                document.getElementById('threadDate').textContent = new Date(thread.created_at).toLocaleDateString('ko-KR');
                document.getElementById('applicationId').textContent = thread.order_id || thread.id;
                document.getElementById('applicationDate').textContent = new Date(thread.created_at).toLocaleDateString('ko-KR');
                
                // ë¹„ì ì‚¬ì „ì§„ë‹¨ì˜ ê²½ìš° 55,000ì›ìœ¼ë¡œ ê³ ì • í‘œì‹œ
                if (thread.service_name && thread.service_name.includes('ë¹„ì ì‚¬ì „ì§„ë‹¨')) {
                    document.getElementById('amount').textContent = 'â‚©55,000';
                } else if (thread.amount > 0) {
                    document.getElementById('amount').textContent = 'â‚©' + thread.amount.toLocaleString();
                } else {
                    document.getElementById('amount').textContent = '-';
                }
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                const statusMap = {
                    'document': 'ì„œë¥˜ ëŒ€ê¸°',
                    'payment': 'ê²°ì œ ì™„ë£Œ',
                    'processing': 'ì§„í–‰ ì¤‘',
                    'completed': 'ì™„ë£Œ'
                };
                document.getElementById('currentStatus').textContent = statusMap[thread.status] || 'ì ‘ìˆ˜ ì™„ë£Œ';
                
                // ì˜ˆìƒ ì™„ë£Œì¼ ì œê±°
                const expectedDate = document.getElementById('expectedDate');
                if (expectedDate) {
                    expectedDate.textContent = '-';
                }
            
                // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
                const statusBadge = document.getElementById('statusBadge');
                const statusMapBadge = {
                    'payment': { text: 'ê²°ì œ ì™„ë£Œ', class: 'processing' },
                    'document': { text: 'ì„œë¥˜ ìˆ˜ì§‘ ì¤‘', class: 'pending' },
                    'processing': { text: 'ì‹ ì²­ ì§„í–‰ ì¤‘', class: 'processing' },
                    'completed': { text: 'ì²˜ë¦¬ ì™„ë£Œ', class: 'completed' },
                    'archived': { text: 'ì™„ë£Œ (ë³´ê´€)', class: 'completed' }
                };
                
                const status = statusMapBadge[thread.status] || { text: 'ì§„í–‰ ì¤‘', class: 'processing' };
                statusBadge.textContent = status.text;
                statusBadge.className = 'status-badge ' + status.class;
            } catch (error) {
                console.error('âŒ ì“°ë ˆë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì“°ë ˆë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'index.html';
            }
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages() {
            const messagesArea = document.getElementById('messagesArea');
            
            if (!threadId) return;
            
            try {
                // Supabaseì—ì„œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                console.log('ğŸ“¨ [loadMessages] ë©”ì‹œì§€ ì¡°íšŒ ì‹œì‘, threadId:', threadId);
                const result = await getThreadMessages(threadId);
                console.log('ğŸ“¨ [loadMessages] ì¡°íšŒ ê²°ê³¼:', result);
                console.log('ğŸ“¨ [loadMessages] ë©”ì‹œì§€ ê°œìˆ˜:', result.data?.length || 0);
                
                if (result.success && result.data && result.data.length > 0) {
                    console.log('ğŸ“¨ [loadMessages] ë©”ì‹œì§€ ëª©ë¡:', result.data);
                    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œì™¸í•˜ê³  ë™ì  ë©”ì‹œì§€ë§Œ ì œê±°
                    const systemMessage = messagesArea.querySelector('.system-message');
                    messagesArea.innerHTML = '';
                    if (systemMessage) {
                        messagesArea.appendChild(systemMessage);
                    }
                    
                    // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€ (ì²« ë©”ì‹œì§€ë¡œ)
                    const welcomeMessage = {
                        sender: 'admin',
                        name: 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                        content: 'ì•ˆë…•í•˜ì„¸ìš”! ë²•ë¬´ë²•ì¸ ë¡œì—° ì¶œì…êµ­ì´ë¯¼ì§€ì›ì„¼í„°ì…ë‹ˆë‹¤.\n\nì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¼í„° ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                        time: new Date(result.data[0].created_at).toLocaleTimeString('ko-KR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        avatar: 'ë¡œ'
                    };
                    appendMessage(welcomeMessage);
                    
                    // ë‚˜ë¨¸ì§€ ë©”ì‹œì§€ í‘œì‹œ
                    result.data.forEach(msg => {
                        // ì„¤ë¬¸ ìš”ì²­ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                        if (msg.content && msg.content.includes('---TALLY_SURVEY_DATA---')) {
                            processSurveyMessage(msg);
                            return;
                        }
                        
                        const messageData = {
                            sender: msg.sender_type,
                            name: msg.sender_type === 'user' ? 'ë³¸ì¸' : 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                            content: msg.content,
                            time: new Date(msg.created_at).toLocaleTimeString('ko-KR', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            }),
                            avatar: msg.sender_type === 'user' ? 'ë‚˜' : 'ë¡œ',
                            file_url: msg.file_url,
                            file_name: msg.file_name,
                            file_type: msg.file_type
                        };
                        appendMessage(messageData);
                    });
                } else {
                    // ë©”ì‹œì§€ ì—†ì„ ë•Œë„ í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
                    const welcomeMessage = {
                        sender: 'admin',
                        name: 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                        content: 'ì•ˆë…•í•˜ì„¸ìš”! ë²•ë¬´ë²•ì¸ ë¡œì—° ì¶œì…êµ­ì´ë¯¼ì§€ì›ì„¼í„°ì…ë‹ˆë‹¤.\n\nì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¼í„° ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                        time: new Date().toLocaleTimeString('ko-KR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        avatar: 'ë¡œ'
                    };
                    appendMessage(welcomeMessage);
                }
                
                scrollToBottom();
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë’¤ë¡œ ê°€ê¸° í•¨ìˆ˜
        async function goBack() {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ from í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const from = urlParams.get('from');
            
            // from íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ê·¸ê³³ìœ¼ë¡œ ì´ë™
            if (from === 'admin') {
                window.location.href = 'admin-dashboard.html';
                return;
            }
            
            // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¼ë°˜ ì‚¬ìš©ì í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = 'index.html';
        }

        // ============================================
        // ë‚´ ì œì¶œ ì„œë¥˜ í‘œì‹œ
        // ============================================
        async function loadMyDocuments() {
            const documentsList = document.getElementById('documentsList');
            if (!documentsList || !currentUser) return;
            
            const documents = [];
            
            // ì²¨ë¶€íŒŒì¼ ëª©ë¡ êµ¬ì„±
            if (currentUser.arc_front_url) {
                documents.push({ name: 'ì™¸êµ­ì¸ë“±ë¡ì¦ (ì•ë©´)', path: currentUser.arc_front_url, icon: 'fa-id-card' });
            }
            if (currentUser.arc_back_url) {
                documents.push({ name: 'ì™¸êµ­ì¸ë“±ë¡ì¦ (ë’·ë©´)', path: currentUser.arc_back_url, icon: 'fa-id-card' });
            }
            if (currentUser.passport_url) {
                documents.push({ name: 'ì—¬ê¶Œ', path: currentUser.passport_url, icon: 'fa-passport' });
            }
            if (currentUser.signature_url) {
                documents.push({ name: 'ì „ìì„œëª…', path: currentUser.signature_url, icon: 'fa-signature' });
            }
            
            if (documents.length === 0) {
                documentsList.innerHTML = '<p style="color: #6B7280; font-size: 14px; padding: 12px 0;">ì•„ì§ ì œì¶œëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            documentsList.innerHTML = '';
            
            for (const doc of documents) {
                const btn = document.createElement('button');
                btn.style.cssText = 'display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 8px; background: #F9FAFB; cursor: pointer; font-size: 14px; color: #374151; transition: all 0.2s;';
                btn.innerHTML = `
                    <i class="fas ${doc.icon}" style="color: #3182F6;"></i>
                    <span style="flex: 1; text-align: left;">${doc.name}</span>
                    <i class="fas fa-download" style="color: #6B7280;"></i>
                `;
                btn.onmouseover = () => { btn.style.background = '#EFF6FF'; btn.style.borderColor = '#3182F6'; };
                btn.onmouseout = () => { btn.style.background = '#F9FAFB'; btn.style.borderColor = '#E5E7EB'; };
                btn.onclick = async () => {
                    try {
                        btn.disabled = true;
                        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...`;
                        
                        const result = await getProfileDocumentUrl(doc.path);
                        
                        if (result.success) {
                            window.open(result.url, '_blank');
                        } else {
                            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + result.error);
                        }
                    } catch (error) {
                        console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                        alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = `
                            <i class="fas ${doc.icon}" style="color: #3182F6;"></i>
                            <span style="flex: 1; text-align: left;">${doc.name}</span>
                            <i class="fas fa-download" style="color: #6B7280;"></i>
                        `;
                    }
                };
                documentsList.appendChild(btn);
            }
            
            console.log('âœ… ë‚´ ì œì¶œ ì„œë¥˜ í‘œì‹œ ì™„ë£Œ:', documents.length, 'ê°œ');
        }

        // ============================================
        // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… (Supabase Realtime)
        // ============================================
        function subscribeToMessages() {
            if (!threadId) {
                console.error('âŒ [Realtime] threadIdê°€ ì—†ì–´ êµ¬ë… ë¶ˆê°€');
                return;
            }
            
            console.log('ğŸ”” [Realtime] ë©”ì‹œì§€ êµ¬ë… ì‹œì‘, threadId:', threadId);
            
            // ê¸°ì¡´ ì±„ë„ì´ ìˆìœ¼ë©´ ì œê±°
            if (messageChannel) {
                supabaseClient.removeChannel(messageChannel);
            }
            
            // ìƒˆ ë©”ì‹œì§€ êµ¬ë…
            messageChannel = supabaseClient
                .channel(`thread-messages-${threadId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `thread_id=eq.${threadId}`
                }, (payload) => {
                    console.log('ğŸ“© [Realtime] ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', payload.new);
                    
                    const newMessage = payload.new;
                    
                    // ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì´ë¯¸ UIì— ì¶”ê°€ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ìŠ¤í‚µ
                    if (currentUser && newMessage.sender_id === currentUser.id) {
                        console.log('â­ï¸ [Realtime] ë³¸ì¸ ë©”ì‹œì§€ ìŠ¤í‚µ');
                        return;
                    }
                    
                    // ìƒˆ ë©”ì‹œì§€ UIì— ì¶”ê°€
                    const messageTime = new Date(newMessage.created_at).toLocaleTimeString('ko-KR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // ì„¤ë¬¸ ìš”ì²­ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                    if (newMessage.content && newMessage.content.includes('---TALLY_SURVEY_DATA---')) {
                        processSurveyMessage(newMessage);
                        showToast('ìƒˆë¡œìš´ ì„¤ë¬¸ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!', 'info', 5000);
                        scrollToBottom();
                        return;
                    }
                    
                    const msg = {
                        sender: newMessage.sender_type === 'admin' ? 'admin' : 'user',
                        name: newMessage.sender_name || (newMessage.sender_type === 'admin' ? 'ë²•ë¬´ë²•ì¸ ë¡œì—°' : 'ìƒëŒ€ë°©'),
                        content: newMessage.content,
                        time: messageTime,
                        avatar: newMessage.sender_type === 'admin' ? 'ë¡œ' : 'ë‚˜',
                        file_url: newMessage.file_url,
                        file_name: newMessage.file_name,
                        file_type: newMessage.file_type
                    };
                    
                    appendMessage(msg);
                    scrollToBottom();
                    
                    // ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼
                    showToast('ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.', 'info', 3000);
                    
                    // ë¸Œë¼ìš°ì € ì•Œë¦¼ (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°)
                    if (Notification.permission === 'granted') {
                        new Notification('ë²•ë¬´ë²•ì¸ ë¡œì—°', {
                            body: newMessage.content.substring(0, 50) + (newMessage.content.length > 50 ? '...' : ''),
                            icon: '/favicon.svg'
                        });
                    }
                })
                .subscribe((status) => {
                    console.log('ğŸ”” [Realtime] êµ¬ë… ìƒíƒœ:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('âœ… [Realtime] ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… ì„±ê³µ!');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('âŒ [Realtime] êµ¬ë… ì˜¤ë¥˜');
                    }
                });
        }
        
        // í˜ì´ì§€ ë– ë‚  ë•Œ êµ¬ë… í•´ì œ
        window.addEventListener('beforeunload', () => {
            if (messageChannel) {
                console.log('ğŸ”• [Realtime] êµ¬ë… í•´ì œ');
                supabaseClient.removeChannel(messageChannel);
            }
        });
        
        // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function appendMessage(msg) {
            const messagesArea = document.getElementById('messagesArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender}`;
            
            // íŒŒì¼ ì²¨ë¶€ ì—¬ë¶€ í™•ì¸
            let fileHtml = '';
            if (msg.file_url && msg.file_name) {
                const fileIcon = getFileIcon(msg.file_type);
                fileHtml = `
                    <div class="message-file" onclick="downloadFile('${msg.file_url}', '${msg.file_name}')">
                        <div class="file-icon">${fileIcon}</div>
                        <div class="file-info">
                            <div class="file-name">${msg.file_name}</div>
                            <div class="file-size">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</div>
                        </div>
                    </div>
                `;
            }
            
            // ì„¤ë¬¸ ìš”ì²­ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ (survey_url í¬í•¨ ì—¬ë¶€ ë˜ëŠ” íŠ¹ì • í‚¤ì›Œë“œ)
            let surveyHtml = '';
            let contentHtml = msg.content;
            
            // survey_urlì´ ìˆê±°ë‚˜ ë©”ì‹œì§€ì— ì„¤ë¬¸ ë§í¬ê°€ í¬í•¨ëœ ê²½ìš°
            if (msg.survey_url || (msg.content && msg.content.includes('tally.so'))) {
                const surveyUrl = msg.survey_url || extractTallyUrl(msg.content);
                const surveyTitle = msg.survey_title || 'ğŸ“‹ ë¹„ì ì‚¬ì „ì§„ë‹¨ ì„¤ë¬¸';
                
                if (surveyUrl) {
                    surveyHtml = `
                        <button class="survey-request-btn" onclick="openSurveyModal('${surveyUrl}', '${surveyTitle}')">
                            <i class="fas fa-clipboard-list"></i>
                            ${surveyTitle} ì‘ì„±í•˜ê¸°
                        </button>
                    `;
                    // ì›ë³¸ URLì„ ìˆ¨ê¸°ê³  ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                    contentHtml = msg.content.replace(/https?:\/\/tally\.so\/r\/[^\s]+/g, '').trim();
                    if (!contentHtml) {
                        contentHtml = 'ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„¤ë¬¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.';
                    }
                }
            }
            
            // ì„¤ë¬¸ ì™„ë£Œ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            if (msg.content && msg.content.includes('ì„¤ë¬¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤')) {
                contentHtml = `<span class="survey-completed-badge"><i class="fas fa-check-circle"></i> ${msg.content}</span>`;
                surveyHtml = '';
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${msg.avatar}</div>
                <div class="message-content">
                    <div class="message-sender">${msg.name}</div>
                    <div class="message-bubble">${contentHtml}</div>
                    ${surveyHtml}
                    ${fileHtml}
                    <div class="message-time">${msg.time}</div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
        }
        
        // Tally URL ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜
        function extractTallyUrl(content) {
            if (!content) return null;
            const match = content.match(/https?:\/\/tally\.so\/r\/[^\s]+/);
            return match ? match[0] : null;
        }
        
        // íŒŒì¼ íƒ€ì…ë³„ ì•„ì´ì½˜ ë°˜í™˜
        function getFileIcon(fileType) {
            if (!fileType) return 'ğŸ“„';
            
            if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (fileType.includes('pdf')) return 'ğŸ“•';
            if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“';
            if (fileType.includes('excel') || fileType.includes('sheet')) return 'ğŸ“Š';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'ğŸ“¦';
            
            return 'ğŸ“„';
        }
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadFile(fileUrl, fileName) {
            try {
                // ìƒˆ íƒ­ì—ì„œ íŒŒì¼ ì—´ê¸°
                window.open(fileUrl, '_blank');
                showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success', 2000);
            } catch (error) {
                console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 2000);
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                return;
            }

            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');

            try {
                // Supabaseì— ë©”ì‹œì§€ ì €ì¥
                const result = await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: content
                });
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // UIì— ë©”ì‹œì§€ ì¶”ê°€
                const message = {
                    sender: 'user',
                    name: 'ë³¸ì¸',
                    content: content,
                    time: time,
                    avatar: 'ë‚˜'
                };
                
                appendMessage(message);
                input.value = '';
                input.style.height = 'auto';
                scrollToBottom();
                
                showToast('ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 2000);
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                showToast('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 2000);
            }
        }

        // íŒŒì¼ ì²¨ë¶€
        function attachFile() {
            document.getElementById('fileInput').click();
        }

        function attachImage() {
            const input = document.getElementById('fileInput');
            input.accept = 'image/*';
            input.click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error', 3000);
                return;
            }
            
            showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info', 2000);
            
            try {
                // Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ
                const uploadResult = await uploadThreadDocument(threadId, file);
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error);
                }
                
                console.log('âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', uploadResult.data);
                
                // ë©”ì‹œì§€ë¡œ íŒŒì¼ ì •ë³´ ì „ì†¡
                const messageResult = await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: `íŒŒì¼ ì²¨ë¶€: ${file.name}`,
                    file_url: uploadResult.data.signedUrl,
                    file_name: file.name,
                    file_type: file.type
                });
                
                if (!messageResult.success) {
                    throw new Error(messageResult.error);
                }
                
                showToast(`${file.name} íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success', 3000);
                
                // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMessages();
                
                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                event.target.value = '';
                
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 3000);
            }
        }

        // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Enter í‚¤ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // ëª¨ë°”ì¼ ì²¨ë¶€íŒŒì¼/ì •ë³´ íŒ¨ë„ í† ê¸€
        function toggleDocsPanel() {
            const sidebar = document.querySelector('.thread-sidebar');
            const toggleBtn = document.getElementById('docsToggleBtn');
            
            if (sidebar.classList.contains('mobile-visible')) {
                sidebar.classList.remove('mobile-visible');
                toggleBtn.classList.remove('active');
                toggleBtn.querySelector('span').textContent = 'ì²¨ë¶€ì„œë¥˜ ë° ì§„í–‰í˜„í™© ë³´ê¸°';
            } else {
                sidebar.classList.add('mobile-visible');
                toggleBtn.classList.add('active');
                toggleBtn.querySelector('span').textContent = 'ì²¨ë¶€ì„œë¥˜ ë° ì§„í–‰í˜„í™© ë‹«ê¸°';
                
                // ì‚¬ì´ë“œë°”ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
                setTimeout(() => {
                    sidebar.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }
        
        // ê¸°ì¡´ ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
        function toggleSidebar() {
            toggleDocsPanel();
        }

        // ============================================
        // Tally ì„¤ë¬¸ ì„ë² ë“œ ê¸°ëŠ¥
        // ============================================
        
        // ì„¤ë¬¸ ìš”ì²­ ë©”ì‹œì§€ ì²˜ë¦¬
        function processSurveyMessage(msg) {
            try {
                // ë©”ì‹œì§€ì—ì„œ ì„¤ë¬¸ ë°ì´í„° ì¶”ì¶œ
                const parts = msg.content.split('---TALLY_SURVEY_DATA---');
                const textContent = parts[0].trim();
                const surveyDataStr = parts[1]?.trim();
                
                if (!surveyDataStr) {
                    console.error('ì„¤ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const surveyData = JSON.parse(surveyDataStr);
                console.log('ğŸ“‹ ì„¤ë¬¸ ë°ì´í„° íŒŒì‹±ë¨:', surveyData);
                
                // ë¨¼ì € ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                const messageTime = new Date(msg.created_at).toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                appendMessage({
                    sender: 'admin',
                    name: 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                    content: textContent,
                    time: messageTime,
                    avatar: 'ë¡œ'
                });
                
                // ì„¤ë¬¸ ì¹´ë“œ ì¶”ê°€
                appendTallySurvey({
                    formId: surveyData.formId,
                    title: surveyData.title || 'ì„¤ë¬¸ ì‘ë‹µ ìš”ì²­',
                    description: 'ì„¼í„° ë‹´ë‹¹ìê°€ ì„¤ë¬¸ ì‘ë‹µì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤',
                    status: 'pending',
                    surveyId: surveyData.surveyId
                });
                
            } catch (error) {
                console.error('ì„¤ë¬¸ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ì‹œ ì¼ë°˜ ë©”ì‹œì§€ë¡œ í‘œì‹œ
                appendMessage({
                    sender: msg.sender_type,
                    name: msg.sender_type === 'user' ? 'ë³¸ì¸' : 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                    content: msg.content.split('---TALLY_SURVEY_DATA---')[0],
                    time: new Date(msg.created_at).toLocaleTimeString('ko-KR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    avatar: msg.sender_type === 'user' ? 'ë‚˜' : 'ë¡œ'
                });
            }
        }
        
        // ì„¤ë¬¸ ì¹´ë“œë¥¼ ë©”ì‹œì§€ ì˜ì—­ì— ì¶”ê°€
        function appendTallySurvey(surveyConfig) {
            const messagesArea = document.getElementById('messagesArea');
            
            // ê¸°ë³¸ ì„¤ì •
            const config = {
                formId: surveyConfig.formId || '7RLOo9',
                title: surveyConfig.title || 'ë¹„ì ì§„ë‹¨ ì„¤ë¬¸',
                description: surveyConfig.description || 'ì„¼í„° ë‹´ë‹¹ìê°€ ì„¤ë¬¸ ì‘ë‹µì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤',
                status: surveyConfig.status || 'pending', // pending, completed
                surveyId: surveyConfig.surveyId || `survey_${Date.now()}`,
                height: surveyConfig.height || 600
            };
            
            // Hidden Fieldsì— ì „ë‹¬í•  íŒŒë¼ë¯¸í„° êµ¬ì„±
            const hiddenParams = new URLSearchParams({
                thread_id: threadId || '',
                user_id: currentUser?.id || '',
                user_email: currentUser?.email || '',
                user_name: currentUser?.name || '',
                survey_id: config.surveyId
            });
            
            // Tally ì„ë² ë“œ URL ìƒì„±
            const tallyUrl = `https://tally.so/embed/${config.formId}?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1&${hiddenParams.toString()}`;
            
            // ì„¤ë¬¸ ì¹´ë“œ HTML ìƒì„±
            const surveyCard = document.createElement('div');
            surveyCard.className = `tally-survey-card ${config.status === 'completed' ? 'tally-survey-completed' : ''}`;
            surveyCard.id = `tally-survey-${config.surveyId}`;
            surveyCard.dataset.surveyId = config.surveyId;
            surveyCard.dataset.formId = config.formId;
            
            const statusText = config.status === 'completed' ? 'ì‘ë‹µ ì™„ë£Œ' : 'ì‘ë‹µ ëŒ€ê¸°';
            const statusClass = config.status === 'completed' ? 'completed' : 'pending';
            const iconClass = config.status === 'completed' ? 'fa-check-circle' : 'fa-clipboard-list';
            
            surveyCard.innerHTML = `
                <div class="tally-survey-header">
                    <div class="tally-survey-icon">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="tally-survey-title">
                        <h4>${config.title}</h4>
                        <p>${config.description}</p>
                    </div>
                    <div class="tally-survey-status ${statusClass}">${statusText}</div>
                </div>
                <div class="tally-survey-body">
                    <iframe 
                        data-tally-src="${tallyUrl}"
                        loading="lazy" 
                        width="100%" 
                        height="${config.height}" 
                        frameborder="0" 
                        marginheight="0" 
                        marginwidth="0" 
                        title="${config.title}">
                    </iframe>
                </div>
                <div class="tally-survey-actions">
                    <button class="tally-survey-btn secondary" onclick="toggleSurveyView('${config.surveyId}')">
                        <i class="fas fa-chevron-up"></i> ì ‘ê¸°/í¼ì¹˜ê¸°
                    </button>
                    ${config.status !== 'completed' ? `
                    <button class="tally-survey-btn primary" onclick="openSurveyFullscreen('${config.formId}', '${hiddenParams.toString()}')">
                        <i class="fas fa-external-link-alt"></i> ìƒˆ ì°½ì—ì„œ ì—´ê¸°
                    </button>
                    ` : ''}
                </div>
            `;
            
            messagesArea.appendChild(surveyCard);
            
            // Tally ì„ë² ë“œ ë¡œë“œ
            if (typeof Tally !== 'undefined') {
                Tally.loadEmbeds();
            } else {
                // Tallyê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ iframe src ì„¤ì •
                const iframe = surveyCard.querySelector('iframe');
                if (iframe && iframe.dataset.tallySrc) {
                    iframe.src = iframe.dataset.tallySrc;
                }
            }
            
            scrollToBottom();
            
            console.log('âœ… Tally ì„¤ë¬¸ ì¹´ë“œ ì¶”ê°€ë¨:', config);
            return config.surveyId;
        }
        
        // ì„¤ë¬¸ ì ‘ê¸°/í¼ì¹˜ê¸°
        function toggleSurveyView(surveyId) {
            const surveyCard = document.getElementById(`tally-survey-${surveyId}`);
            if (surveyCard) {
                surveyCard.classList.toggle('tally-survey-collapsed');
                
                const btn = surveyCard.querySelector('.tally-survey-btn.secondary i');
                if (surveyCard.classList.contains('tally-survey-collapsed')) {
                    btn.className = 'fas fa-chevron-down';
                } else {
                    btn.className = 'fas fa-chevron-up';
                }
            }
        }
        
        // ì„¤ë¬¸ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
        function openSurveyFullscreen(formId, params) {
            const url = `https://tally.so/r/${formId}?${params}`;
            window.open(url, '_blank', 'width=800,height=900');
        }
        
        // ì„¤ë¬¸ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
        function markSurveyCompleted(surveyId) {
            const surveyCard = document.getElementById(`tally-survey-${surveyId}`);
            if (surveyCard) {
                surveyCard.classList.add('tally-survey-completed');
                
                // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
                const statusBadge = surveyCard.querySelector('.tally-survey-status');
                if (statusBadge) {
                    statusBadge.textContent = 'ì‘ë‹µ ì™„ë£Œ';
                    statusBadge.className = 'tally-survey-status completed';
                }
                
                // ì•„ì´ì½˜ ë³€ê²½
                const icon = surveyCard.querySelector('.tally-survey-icon i');
                if (icon) {
                    icon.className = 'fas fa-check-circle';
                }
                
                // ìƒˆ ì°½ ì—´ê¸° ë²„íŠ¼ ì œê±°
                const primaryBtn = surveyCard.querySelector('.tally-survey-btn.primary');
                if (primaryBtn) {
                    primaryBtn.remove();
                }
                
                console.log('âœ… ì„¤ë¬¸ ì™„ë£Œ ì²˜ë¦¬:', surveyId);
            }
        }
        
        // Tally ì„¤ë¬¸ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', function(event) {
            // Tallyì—ì„œ ì˜¤ëŠ” ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            if (event.origin !== 'https://tally.so') return;
            
            try {
                const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                
                // Tally í¼ ì œì¶œ ì™„ë£Œ ì´ë²¤íŠ¸
                if (data.event === 'Tally.FormSubmitted') {
                    console.log('ğŸ“‹ Tally ì„¤ë¬¸ ì œì¶œë¨:', data);
                    
                    // í•´ë‹¹ ì„¤ë¬¸ ì¹´ë“œ ì°¾ì•„ì„œ ì™„ë£Œ í‘œì‹œ
                    const surveyCards = document.querySelectorAll('.tally-survey-card');
                    surveyCards.forEach(card => {
                        if (card.dataset.formId === data.formId) {
                            markSurveyCompleted(card.dataset.surveyId);
                            
                            // ì“°ë ˆë“œì— ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
                            sendSurveyCompletionMessage(card.dataset.surveyId);
                        }
                    });
                    
                    showToast('ì„¤ë¬¸ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!', 'success', 3000);
                }
            } catch (e) {
                // JSON íŒŒì‹± ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ë‹¤ë¥¸ ë©”ì‹œì§€ì¼ ìˆ˜ ìˆìŒ)
            }
        });
        
        // ì„¤ë¬¸ ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
        async function sendSurveyCompletionMessage(surveyId) {
            try {
                await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: `ğŸ“‹ ì„¤ë¬¸ ì‘ë‹µì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. (ì„¤ë¬¸ ID: ${surveyId})`
                });
                
                // UIì— ë©”ì‹œì§€ ì¶”ê°€
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' + 
                            now.getMinutes().toString().padStart(2, '0');
                
                appendMessage({
                    sender: 'user',
                    name: 'ë³¸ì¸',
                    content: 'ğŸ“‹ ì„¤ë¬¸ ì‘ë‹µì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.',
                    time: time,
                    avatar: 'ë‚˜'
                });
                
                scrollToBottom();
            } catch (error) {
                console.error('ì„¤ë¬¸ ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
            }
        }
        
        // í…ŒìŠ¤íŠ¸ìš©: ì„¤ë¬¸ ì¶”ê°€ í•¨ìˆ˜ (ê°œë°œì ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        window.addTestSurvey = function() {
            appendTallySurvey({
                formId: '7RLOo9',
                title: '26ë…„ 2ì›” ì™¸êµ­ì¸ìœ í•™ìƒ ë¹„ì ì§„ë‹¨ ì„¤ë¬¸',
                description: 'ë¹„ì ìƒíƒœ ì ê²€ì„ ìœ„í•œ ì„¤ë¬¸ì…ë‹ˆë‹¤. ì‘ë‹µí•´ ì£¼ì„¸ìš”.',
                status: 'pending'
            });
        };
        
        console.log('âœ… Tally ì„¤ë¬¸ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ’¡ í…ŒìŠ¤íŠ¸: ì½˜ì†”ì—ì„œ addTestSurvey() ì‹¤í–‰');
    </script>
    
    <!-- ì„¤ë¬¸ ëª¨ë‹¬ -->
    <div id="surveyModal" class="survey-modal" style="display: none;">
        <div class="survey-modal-overlay" onclick="closeSurveyModal()"></div>
        <div class="survey-modal-content">
            <div class="survey-modal-header">
                <h3 id="surveyModalTitle">ğŸ“‹ ë¹„ì ì‚¬ì „ì§„ë‹¨ ì„¤ë¬¸</h3>
                <button class="survey-modal-close" onclick="closeSurveyModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="survey-modal-body">
                <iframe 
                    id="surveyIframe"
                    src=""
                    frameborder="0"
                    allowfullscreen
                ></iframe>
            </div>
        </div>
    </div>

    <style>
        /* ì„¤ë¬¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .survey-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .survey-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .survey-modal-content {
            position: relative;
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .survey-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .survey-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .survey-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .survey-modal-close:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .survey-modal-body {
            height: 70vh;
            max-height: 600px;
        }
        
        .survey-modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* ì„¤ë¬¸ ìš”ì²­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .survey-request-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .survey-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .survey-request-btn i {
            font-size: 16px;
        }
        
        .survey-completed-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .survey-completed-badge i {
            color: #10b981;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 640px) {
            .survey-modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 12px;
            }
            
            .survey-modal-body {
                height: 75vh;
            }
            
            .survey-request-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>

    <script>
        // ì„¤ë¬¸ ëª¨ë‹¬ ì—´ê¸°
        function openSurveyModal(surveyUrl, title = 'ğŸ“‹ ë¹„ì ì‚¬ì „ì§„ë‹¨ ì„¤ë¬¸') {
            const modal = document.getElementById('surveyModal');
            const iframe = document.getElementById('surveyIframe');
            const modalTitle = document.getElementById('surveyModalTitle');
            
            // Tally íˆ¬ëª… ë°°ê²½ ë° ìˆ¨ê¹€ ì œëª© íŒŒë¼ë¯¸í„° ì¶”ê°€
            const urlWithParams = surveyUrl + (surveyUrl.includes('?') ? '&' : '?') + 'transparentBackground=1&hideTitle=1';
            
            modalTitle.textContent = title;
            iframe.src = urlWithParams;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            console.log('ğŸ“‹ [ì„¤ë¬¸] ëª¨ë‹¬ ì—´ë¦¼:', surveyUrl);
        }
        
        // ì„¤ë¬¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeSurveyModal() {
            const modal = document.getElementById('surveyModal');
            const iframe = document.getElementById('surveyIframe');
            
            modal.style.display = 'none';
            iframe.src = '';
            document.body.style.overflow = '';
            
            console.log('ğŸ“‹ [ì„¤ë¬¸] ëª¨ë‹¬ ë‹«í˜');
        }
        
        // Tally ì„¤ë¬¸ ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', async function(event) {
            // Tallyì—ì„œ ì˜¤ëŠ” ë©”ì‹œì§€ì¸ì§€ í™•ì¸
            if (event.data && event.data.type === 'tally.formSubmitted') {
                console.log('âœ… [ì„¤ë¬¸] Tally ì„¤ë¬¸ ì™„ë£Œ:', event.data);
                
                // ëª¨ë‹¬ ë‹«ê¸°
                closeSurveyModal();
                
                // ì“°ë ˆë“œì— ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
                try {
                    if (threadId && typeof createMessage === 'function') {
                        await createMessage({
                            thread_id: threadId,
                            sender_type: 'user',
                            content: 'âœ… ë¹„ì ì‚¬ì „ì§„ë‹¨ ì„¤ë¬¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n\nì„¼í„°ì—ì„œ ì„¤ë¬¸ ë‚´ìš©ì„ ê²€í†  í›„ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.'
                        });
                        
                        // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        if (typeof loadMessages === 'function') {
                            await loadMessages();
                        }
                        
                        showToast('ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', 3000);
                    }
                } catch (error) {
                    console.error('ì„¤ë¬¸ ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                    showToast('ì„¤ë¬¸ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 3000);
                }
            }
        });
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('surveyModal');
                if (modal && modal.style.display !== 'none') {
                    closeSurveyModal();
                }
            }
        });
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js?v=20250119"></script>
    
    <!-- ë‹¤êµ­ì–´ ì‹œìŠ¤í…œ -->
    <script src="js/translations.js"></script>
    <script src="js/i18n.js"></script>
</body>
</html>
