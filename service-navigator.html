<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Navigator - Lawyeon Visa & Immigration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F5F6F8;
            min-height: 100vh;
            color: #191F28;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 100%);
            padding: 20px 25px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 3px solid #3182F6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px 40px;
        }

        .progress-section {
            margin-bottom: 24px;
        }

        .progress-text {
            font-size: 14px;
            color: #8B95A1;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .progress-bar {
            height: 6px;
            background: #E5E8EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182F6, #1B64DA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .question-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid #E2E8F0;
        }

        .question-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
            line-height: 1.4;
            letter-spacing: -0.5px;
        }

        .question-subtitle {
            font-size: 15px;
            color: #8B95A1;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .option-btn {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }

        .option-btn:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .option-btn .option-title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .option-btn .option-desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.4;
        }

        .nav-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #F2F4F6;
        }

        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.secondary {
            background: #F2F4F6;
            border: none;
            color: #4E5968;
        }

        .nav-btn.secondary:hover {
            background: #E5E8EB;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-section {
            display: none;
        }

        .result-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .result-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
        }

        .result-subtitle {
            font-size: 15px;
            color: #8B95A1;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .service-item {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 110px;
        }

        .service-item:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .service-item .title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .service-item .desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.5;
        }

        .restart-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 32px;
            background: #F2F4F6;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: #E5E8EB;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 18px;
            border: 2px solid #E5E8EB;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: #3182F6;
            color: #3182F6;
        }

        .category-btn.active {
            background: #3182F6;
            border-color: #3182F6;
            color: white;
        }

        @media (max-width: 1024px) {
            .options-grid,
            .services-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px 16px 32px;
            }

            .question-card {
                padding: 24px 20px;
                border-radius: 20px;
            }

            .question-title {
                font-size: 20px;
            }

            .options-grid,
            .services-grid {
                grid-template-columns: 1fr;
            }

            .option-btn,
            .service-item {
                min-height: auto;
                padding: 20px;
            }

            .option-btn .option-title,
            .service-item .title {
                font-size: 15px;
            }

            .nav-section {
                flex-direction: column-reverse;
                gap: 12px;
            }

            .nav-btn {
                width: 100%;
                text-align: center;
            }

            .category-filter {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 8px;
            }

            .category-btn {
                flex-shrink: 0;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="header-title" data-i18n="navigator.header">Service Navigator</h1>
        </div>
    </div>

    <div class="container">
        <div class="progress-section">
            <div class="progress-text" id="progressText">Step 1 of 3</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
        </div>

        <div class="question-card" id="questionSection">
            <h2 class="question-title" id="questionTitle"></h2>
            <p class="question-subtitle" id="questionSubtitle"></p>
            <div class="options-grid" id="optionsGrid"></div>
            <div class="nav-section">
                <button class="nav-btn secondary" id="prevBtn" onclick="prevStep()" disabled>
                    <i class="fas fa-arrow-left"></i> <span data-i18n="navigator.back">Back</span>
                </button>
                <button class="nav-btn secondary" onclick="restart()">
                    <span data-i18n="navigator.startOver">Start Over</span>
                </button>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="question-card">
                <div class="result-header">
                    <h2 class="result-title" data-i18n="navigator.recommendedServices">Recommended Services</h2>
                    <p class="result-subtitle" data-i18n="navigator.resultSubtitle">Based on your selections, here are the available services:</p>
                </div>
                <div class="category-filter" id="categoryFilter"></div>
                <div class="services-grid" id="servicesGrid"></div>
                <button class="restart-btn" onclick="restart()">
                    <i class="fas fa-redo"></i> <span data-i18n="navigator.startOver">Start Over</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // 다국어 지원 헬퍼 함수
        // ============================================================
        function t(key, fallback) {
            if (typeof i18n !== 'undefined' && i18n.translate) {
                const result = i18n.translate(key);
                return result !== key ? result : fallback || key;
            }
            return fallback || key;
        }

        // ============================================================
        // 서비스 목록 - 서비스 ID만 저장, 이름/설명은 translations.js 참조
        // ============================================================
        const allServices = {
            // Premium Services (2)
            'visa-prediagnosis': { nameKey: 'service.visa_prediagnosis', descKey: 'service.visa_prediagnosis.desc', category: 'premium' },
            'emergency-legal': { nameKey: 'service.emergency_legal', descKey: 'service.emergency_legal.desc', category: 'premium' },

            // Education & Job Search (10)
            'd4-to-d2-change': { nameKey: 'service.d4_d2_change', descKey: 'service.d4_d2_change.desc', category: 'education' },
            'd10-1-change': { nameKey: 'service.d10_1_change', descKey: 'service.d10_1_change.desc', category: 'education' },
            'd10-2-change': { nameKey: 'service.d10_2_change', descKey: 'service.d10_2_change.desc', category: 'education' },
            'd10-3-change': { nameKey: 'service.d10_3_change', descKey: 'service.d10_3_change.desc', category: 'education' },
            'd10-t-change': { nameKey: 'service.d10_t_change', descKey: 'service.d10_t_change.desc', category: 'education' },
            'd2-d4-extension': { nameKey: 'service.d2_d4_extension', descKey: 'service.d2_d4_extension.desc', category: 'education' },
            'd10-extension': { nameKey: 'service.d10_extension', descKey: 'service.d10_extension.desc', category: 'education' },
            'parttime-permit': { nameKey: 'service.parttime_permit', descKey: 'service.parttime_permit.desc', category: 'education' },
            'intern-report': { nameKey: 'service.intern_report', descKey: 'service.intern_report.desc', category: 'education' },
            'parent-invite': { nameKey: 'service.parent_invite', descKey: 'service.parent_invite.desc', category: 'education' },

            // Employment (18)
            'e7-4-change': { nameKey: 'service.e7_4_change', descKey: 'service.e7_4_change.desc', category: 'employment' },
            'e7-4r-change': { nameKey: 'service.e7_4r_change', descKey: 'service.e7_4r_change.desc', category: 'employment' },
            'e7-change': { nameKey: 'service.e7_change', descKey: 'service.e7_change.desc', category: 'employment' },
            'f2-7-change': { nameKey: 'service.f2_7_change', descKey: 'service.f2_7_change.desc', category: 'employment' },
            'f2-r-change': { nameKey: 'service.f2_r_change', descKey: 'service.f2_r_change.desc', category: 'employment' },
            'e7-st-change': { nameKey: 'service.e7_st_change', descKey: 'service.e7_st_change.desc', category: 'employment' },
            'e1-e6-change': { nameKey: 'service.e1_e6_change', descKey: 'service.e1_e6_change.desc', category: 'employment' },
            'e7-extension': { nameKey: 'service.e7_extension', descKey: 'service.e7_extension.desc', category: 'employment' },
            'e9-workplace-change': { nameKey: 'service.e9_workplace_change', descKey: 'service.e9_workplace_change.desc', category: 'employment' },
            'workplace-change-permit': { nameKey: 'service.workplace_change_permit', descKey: 'service.workplace_change_permit.desc', category: 'employment' },
            'outside-activity': { nameKey: 'service.outside_activity', descKey: 'service.outside_activity.desc', category: 'employment' },
            'h2-work-start': { nameKey: 'service.h2_work_start', descKey: 'service.h2_work_start.desc', category: 'employment' },
            'workplace-change-report': { nameKey: 'service.workplace_change_report', descKey: 'service.workplace_change_report.desc', category: 'employment' },
            'employment-info-change': { nameKey: 'service.employment_info_change', descKey: 'service.employment_info_change.desc', category: 'employment' },
            'dispatch-report': { nameKey: 'service.dispatch_report', descKey: 'service.dispatch_report.desc', category: 'employment' },
            'income-report': { nameKey: 'service.income_report', descKey: 'service.income_report.desc', category: 'employment' },
            'foreign-worker-change': { nameKey: 'service.foreign_worker_change', descKey: 'service.foreign_worker_change.desc', category: 'employment' },

            // Business & Investment (12)
            'd8-1-change': { nameKey: 'service.d8_1_change', descKey: 'service.d8_1_change.desc', category: 'business' },
            'd8-2-change': { nameKey: 'service.d8_2_change', descKey: 'service.d8_2_change.desc', category: 'business' },
            'd8-3-change': { nameKey: 'service.d8_3_change', descKey: 'service.d8_3_change.desc', category: 'business' },
            'd8-4-change': { nameKey: 'service.d8_4_change', descKey: 'service.d8_4_change.desc', category: 'business' },
            'd9-1-change': { nameKey: 'service.d9_1_change', descKey: 'service.d9_1_change.desc', category: 'business' },
            'd9-2-change': { nameKey: 'service.d9_2_change', descKey: 'service.d9_2_change.desc', category: 'business' },
            'd9-3-change': { nameKey: 'service.d9_3_change', descKey: 'service.d9_3_change.desc', category: 'business' },
            'd9-4-change': { nameKey: 'service.d9_4_change', descKey: 'service.d9_4_change.desc', category: 'business' },
            'd9-5-change': { nameKey: 'service.d9_5_change', descKey: 'service.d9_5_change.desc', category: 'business' },
            'business-extension': { nameKey: 'service.business_extension', descKey: 'service.business_extension.desc', category: 'business' },
            'fic-registration': { nameKey: 'service.fic_registration', descKey: 'service.fic_registration.desc', category: 'business' },
            'fi-report': { nameKey: 'service.fi_report', descKey: 'service.fi_report.desc', category: 'business' },

            // Ethnic Korean & Family (13)
            'h2-to-f4-change': { nameKey: 'service.h2_f4_change', descKey: 'service.h2_f4_change.desc', category: 'family' },
            'f4-change': { nameKey: 'service.f4_change', descKey: 'service.f4_change.desc', category: 'family' },
            'f4-registration': { nameKey: 'service.f4_registration', descKey: 'service.f4_registration.desc', category: 'family' },
            'f4-extension': { nameKey: 'service.f4_extension', descKey: 'service.f4_extension.desc', category: 'family' },
            'h2-extension': { nameKey: 'service.h2_extension', descKey: 'service.h2_extension.desc', category: 'family' },
            'f6-change': { nameKey: 'service.f6_change', descKey: 'service.f6_change.desc', category: 'family' },
            'f6-extension': { nameKey: 'service.f6_extension', descKey: 'service.f6_extension.desc', category: 'family' },
            'f3-change': { nameKey: 'service.f3_change', descKey: 'service.f3_change.desc', category: 'family' },
            'f1-change': { nameKey: 'service.f1_change', descKey: 'service.f1_change.desc', category: 'family' },
            'visa-grant-child': { nameKey: 'service.visa_grant_child', descKey: 'service.visa_grant_child.desc', category: 'family' },
            'visa-grant-f6-child': { nameKey: 'service.visa_grant_f6_child', descKey: 'service.visa_grant_f6_child.desc', category: 'family' },
            'family-invite': { nameKey: 'service.family_invite', descKey: 'service.family_invite.desc', category: 'family' },
            'housework-report': { nameKey: 'service.housework_report', descKey: 'service.housework_report.desc', category: 'family' },

            // Residence & Citizenship (11)
            'f5-change': { nameKey: 'service.f5_change', descKey: 'service.f5_change.desc', category: 'residence' },
            'f5-reissue': { nameKey: 'service.f5_reissue', descKey: 'service.f5_reissue.desc', category: 'residence' },
            'f2-extension': { nameKey: 'service.f2_extension', descKey: 'service.f2_extension.desc', category: 'residence' },
            'naturalization': { nameKey: 'service.naturalization', descKey: 'service.naturalization.desc', category: 'residence' },
            'nationality-recovery': { nameKey: 'service.nationality_recovery', descKey: 'service.nationality_recovery.desc', category: 'residence' },
            'nationality-selection': { nameKey: 'service.nationality_selection', descKey: 'service.nationality_selection.desc', category: 'residence' },
            'nationality-renounce': { nameKey: 'service.nationality_renounce', descKey: 'service.nationality_renounce.desc', category: 'residence' },
            'nationality-loss': { nameKey: 'service.nationality_loss', descKey: 'service.nationality_loss.desc', category: 'residence' },
            'nationality-retention': { nameKey: 'service.nationality_retention', descKey: 'service.nationality_retention.desc', category: 'residence' },
            'nationality-acquisition': { nameKey: 'service.nationality_acquisition', descKey: 'service.nationality_acquisition.desc', category: 'residence' },
            'nationality-judgment': { nameKey: 'service.nationality_judgment', descKey: 'service.nationality_judgment.desc', category: 'residence' },

            // General Registration & Certificates (13)
            'arc-registration': { nameKey: 'service.arc_registration', descKey: 'service.arc_registration.desc', category: 'registration' },
            'arc-reissue': { nameKey: 'service.arc_reissue', descKey: 'service.arc_reissue.desc', category: 'registration' },
            'address-change': { nameKey: 'service.address_change', descKey: 'service.address_change.desc', category: 'registration' },
            'f4-address-change': { nameKey: 'service.f4_address_change', descKey: 'service.f4_address_change.desc', category: 'registration' },
            'passport-change': { nameKey: 'service.passport_change', descKey: 'service.passport_change.desc', category: 'registration' },
            'reentry-permit-multiple': { nameKey: 'service.reentry_multiple', descKey: 'service.reentry_multiple.desc', category: 'registration' },
            'reentry-permit-single': { nameKey: 'service.reentry_single', descKey: 'service.reentry_single.desc', category: 'registration' },
            'cert-entry-exit': { nameKey: 'service.cert_entry_exit', descKey: 'service.cert_entry_exit.desc', category: 'registration' },
            'cert-arc': { nameKey: 'service.cert_arc', descKey: 'service.cert_arc.desc', category: 'registration' },
            'cert-residence': { nameKey: 'service.cert_residence', descKey: 'service.cert_residence.desc', category: 'registration' },
            'cert-realestate': { nameKey: 'service.cert_realestate', descKey: 'service.cert_realestate.desc', category: 'registration' },
            'cert-arc-number-change': { nameKey: 'service.cert_number_change', descKey: 'service.cert_number_change.desc', category: 'registration' },
            'cert-nationality': { nameKey: 'service.cert_nationality', descKey: 'service.cert_nationality.desc', category: 'registration' }
        };

        // 카테고리 키 (번역 키로 사용)
        const categoryKeys = {
            'all': 'navigator.category.all',
            'premium': 'navigator.category.premium',
            'education': 'navigator.category.education',
            'employment': 'navigator.category.employment',
            'business': 'navigator.category.business',
            'family': 'navigator.category.family',
            'residence': 'navigator.category.residence',
            'registration': 'navigator.category.registration'
        };

        // 카테고리 이름 가져오기
        function getCategoryName(cat) {
            return t(categoryKeys[cat], cat);
        }

        // ============================================================
        // 질문 흐름 정의 - 번역 키 사용
        // ============================================================
        const questions = {
            step1: {
                titleKey: "navigator.step1.title",
                subtitleKey: "navigator.step1.subtitle",
                options: [
                    { id: "change_visa", titleKey: "navigator.step1.change_visa", descKey: "navigator.step1.change_visa.desc" },
                    { id: "extend_visa", titleKey: "navigator.step1.extend_visa", descKey: "navigator.step1.extend_visa.desc" },
                    { id: "register_report", titleKey: "navigator.step1.register_report", descKey: "navigator.step1.register_report.desc" },
                    { id: "get_certificate", titleKey: "navigator.step1.get_certificate", descKey: "navigator.step1.get_certificate.desc" },
                    { id: "residence_citizenship", titleKey: "navigator.step1.residence_citizenship", descKey: "navigator.step1.residence_citizenship.desc" },
                    { id: "need_consultation", titleKey: "navigator.step1.need_consultation", descKey: "navigator.step1.need_consultation.desc" }
                ]
            },
            step2: {
                change_visa: {
                    titleKey: "navigator.step2.change_visa.title",
                    subtitleKey: "navigator.step2.change_visa.subtitle",
                    options: [
                        { id: "visa_work", titleKey: "navigator.step2.visa_work", descKey: "navigator.step2.visa_work.desc" },
                        { id: "visa_skilled", titleKey: "navigator.step2.visa_skilled", descKey: "navigator.step2.visa_skilled.desc" },
                        { id: "visa_business", titleKey: "navigator.step2.visa_business", descKey: "navigator.step2.visa_business.desc" },
                        { id: "visa_student", titleKey: "navigator.step2.visa_student", descKey: "navigator.step2.visa_student.desc" },
                        { id: "visa_jobseeker", titleKey: "navigator.step2.visa_jobseeker", descKey: "navigator.step2.visa_jobseeker.desc" },
                        { id: "visa_family", titleKey: "navigator.step2.visa_family", descKey: "navigator.step2.visa_family.desc" },
                        { id: "visa_korean", titleKey: "navigator.step2.visa_korean", descKey: "navigator.step2.visa_korean.desc" },
                        { id: "visa_residence", titleKey: "navigator.step2.visa_residence", descKey: "navigator.step2.visa_residence.desc" }
                    ]
                },
                extend_visa: {
                    titleKey: "navigator.step2.extend_visa.title",
                    subtitleKey: "navigator.step2.extend_visa.subtitle",
                    options: [
                        { id: "ext_student", titleKey: "navigator.step2.ext_student", descKey: "navigator.step2.ext_student.desc" },
                        { id: "ext_jobseeker", titleKey: "navigator.step2.ext_jobseeker", descKey: "navigator.step2.ext_jobseeker.desc" },
                        { id: "ext_work", titleKey: "navigator.step2.ext_work", descKey: "navigator.step2.ext_work.desc" },
                        { id: "ext_business", titleKey: "navigator.step2.ext_business", descKey: "navigator.step2.ext_business.desc" },
                        { id: "ext_family", titleKey: "navigator.step2.ext_family", descKey: "navigator.step2.ext_family.desc" },
                        { id: "ext_korean", titleKey: "navigator.step2.ext_korean", descKey: "navigator.step2.ext_korean.desc" },
                        { id: "ext_residence", titleKey: "navigator.step2.ext_residence", descKey: "navigator.step2.ext_residence.desc" }
                    ]
                },
                register_report: {
                    titleKey: "navigator.step2.register_report.title",
                    subtitleKey: "navigator.step2.register_report.subtitle",
                    options: [
                        { id: "reg_arc", titleKey: "navigator.step2.reg_arc", descKey: "navigator.step2.reg_arc.desc" },
                        { id: "reg_address", titleKey: "navigator.step2.reg_address", descKey: "navigator.step2.reg_address.desc" },
                        { id: "reg_passport", titleKey: "navigator.step2.reg_passport", descKey: "navigator.step2.reg_passport.desc" },
                        { id: "reg_workplace", titleKey: "navigator.step2.reg_workplace", descKey: "navigator.step2.reg_workplace.desc" },
                        { id: "reg_employment", titleKey: "navigator.step2.reg_employment", descKey: "navigator.step2.reg_employment.desc" },
                        { id: "reg_student", titleKey: "navigator.step2.reg_student", descKey: "navigator.step2.reg_student.desc" },
                        { id: "reg_family", titleKey: "navigator.step2.reg_family", descKey: "navigator.step2.reg_family.desc" },
                        { id: "reg_investment", titleKey: "navigator.step2.reg_investment", descKey: "navigator.step2.reg_investment.desc" }
                    ]
                },
                get_certificate: {
                    titleKey: "navigator.step2.get_certificate.title",
                    subtitleKey: "navigator.step2.get_certificate.subtitle",
                    options: [
                        { id: "cert_arc", titleKey: "navigator.step2.cert_arc", descKey: "navigator.step2.cert_arc.desc" },
                        { id: "cert_travel", titleKey: "navigator.step2.cert_travel", descKey: "navigator.step2.cert_travel.desc" },
                        { id: "cert_reentry", titleKey: "navigator.step2.cert_reentry", descKey: "navigator.step2.cert_reentry.desc" },
                        { id: "cert_residence", titleKey: "navigator.step2.cert_residence", descKey: "navigator.step2.cert_residence.desc" },
                        { id: "cert_other", titleKey: "navigator.step2.cert_other", descKey: "navigator.step2.cert_other.desc" }
                    ]
                },
                residence_citizenship: {
                    titleKey: "navigator.step2.residence_citizenship.title",
                    subtitleKey: "navigator.step2.residence_citizenship.subtitle",
                    options: [
                        { id: "res_f5", titleKey: "navigator.step2.res_f5", descKey: "navigator.step2.res_f5.desc" },
                        { id: "res_f2", titleKey: "navigator.step2.res_f2", descKey: "navigator.step2.res_f2.desc" },
                        { id: "res_naturalize", titleKey: "navigator.step2.res_naturalize", descKey: "navigator.step2.res_naturalize.desc" },
                        { id: "res_nationality", titleKey: "navigator.step2.res_nationality", descKey: "navigator.step2.res_nationality.desc" },
                        { id: "res_f5_renew", titleKey: "navigator.step2.res_f5_renew", descKey: "navigator.step2.res_f5_renew.desc" }
                    ]
                },
                need_consultation: {
                    titleKey: "navigator.step2.need_consultation.title",
                    subtitleKey: "navigator.step2.need_consultation.subtitle",
                    options: [
                        { id: "consult_diagnosis", titleKey: "navigator.step2.consult_diagnosis", descKey: "navigator.step2.consult_diagnosis.desc" },
                        { id: "consult_emergency", titleKey: "navigator.step2.consult_emergency", descKey: "navigator.step2.consult_emergency.desc" },
                        { id: "consult_browse", titleKey: "navigator.step2.consult_browse", descKey: "navigator.step2.consult_browse.desc" }
                    ]
                }
            }
        };

        // ============================================================
        // 서비스 매핑 (각 선택에 해당하는 서비스 ID 배열)
        // ============================================================
        const serviceMapping = {
            // Step 2: Change Visa
            visa_work: ['e7-change', 'e1-e6-change', 'e7-st-change'],
            visa_skilled: ['e7-4-change', 'e7-4r-change'],
            visa_business: ['d8-1-change', 'd8-2-change', 'd8-3-change', 'd8-4-change', 'd9-1-change', 'd9-2-change', 'd9-3-change', 'd9-4-change', 'd9-5-change'],
            visa_student: ['d4-to-d2-change', 'd2-d4-extension'],
            visa_jobseeker: ['d10-1-change', 'd10-2-change', 'd10-3-change', 'd10-t-change'],
            visa_family: ['f6-change', 'f3-change', 'f1-change', 'family-invite', 'visa-grant-child', 'visa-grant-f6-child'],
            visa_korean: ['f4-change', 'h2-to-f4-change'],
            visa_residence: ['f2-7-change', 'f2-r-change'],

            // Step 2: Extend Visa
            ext_student: ['d2-d4-extension'],
            ext_jobseeker: ['d10-extension'],
            ext_work: ['e7-extension'],
            ext_business: ['business-extension'],
            ext_family: ['f6-extension', 'f1-change', 'f3-change'],
            ext_korean: ['f4-extension', 'h2-extension'],
            ext_residence: ['f2-extension'],

            // Step 2: Registration & Reports
            reg_arc: ['arc-registration', 'arc-reissue'],
            reg_address: ['address-change', 'f4-address-change'],
            reg_passport: ['passport-change'],
            reg_workplace: ['workplace-change-permit', 'workplace-change-report', 'e9-workplace-change', 'outside-activity'],
            reg_employment: ['employment-info-change', 'dispatch-report', 'income-report', 'foreign-worker-change', 'h2-work-start'],
            reg_student: ['parttime-permit', 'intern-report', 'parent-invite'],
            reg_family: ['housework-report', 'f4-address-change', 'f4-registration'],
            reg_investment: ['fic-registration', 'fi-report'],

            // Step 2: Certificates
            cert_arc: ['cert-arc', 'cert-arc-number-change'],
            cert_travel: ['cert-entry-exit'],
            cert_reentry: ['reentry-permit-multiple', 'reentry-permit-single'],
            cert_residence: ['cert-residence'],
            cert_other: ['cert-realestate', 'cert-nationality'],

            // Step 2: Residence & Citizenship
            res_f5: ['f5-change'],
            res_f2: ['f2-7-change', 'f2-r-change', 'f2-extension'],
            res_naturalize: ['naturalization'],
            res_nationality: ['nationality-recovery', 'nationality-selection', 'nationality-renounce', 'nationality-loss', 'nationality-retention', 'nationality-acquisition', 'nationality-judgment'],
            res_f5_renew: ['f5-reissue'],

            // Step 2: Consultation
            consult_diagnosis: ['visa-prediagnosis'],
            consult_emergency: ['emergency-legal', 'visa-prediagnosis'],
            consult_browse: Object.keys(allServices) // 전체 서비스
        };

        // ============================================================
        // 상태 관리
        // ============================================================
        let currentStep = 1;
        let selections = [];
        let history = [];

        // 초기화
        function init() {
            renderStep();
        }

        // 현재 단계 렌더링
        function renderStep() {
            const questionSection = document.getElementById('questionSection');
            const resultSection = document.getElementById('resultSection');

            questionSection.classList.remove('hidden');
            resultSection.style.display = 'none';

            let stepData;
            if (currentStep === 1) {
                stepData = questions.step1;
            } else if (currentStep === 2) {
                stepData = questions.step2[selections[0]];
            }

            if (!stepData) {
                showResults();
                return;
            }

            // 진행률 업데이트 (다국어)
            const stepText = t('navigator.stepOf', 'Step {0} of {1}')
                .replace('{0}', currentStep)
                .replace('{1}', '3');
            document.getElementById('progressText').textContent = stepText;
            document.getElementById('progressFill').style.width = `${currentStep * 33}%`;

            // 질문 업데이트 (다국어)
            document.getElementById('questionTitle').textContent = t(stepData.titleKey, stepData.title || '');
            document.getElementById('questionSubtitle').textContent = t(stepData.subtitleKey, stepData.subtitle || '');

            // 옵션 렌더링 (다국어)
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = stepData.options.map(opt => {
                const title = t(opt.titleKey, opt.title || '');
                const desc = t(opt.descKey, opt.desc || '');
                return `
                <button class="option-btn" onclick="selectOption('${opt.id}')">
                    <div class="option-title">${title}</div>
                    ${desc ? `<div class="option-desc">${desc}</div>` : ''}
                </button>
            `;
            }).join('');

            // 뒤로가기 버튼
            document.getElementById('prevBtn').disabled = currentStep === 1;
        }

        // 옵션 선택
        function selectOption(optionId) {
            history.push({ step: currentStep, selections: [...selections] });
            selections[currentStep - 1] = optionId;
            currentStep++;

            if (currentStep > 2 || !questions.step2[selections[0]]) {
                showResults();
            } else {
                renderStep();
            }
        }

        // 결과 표시
        function showResults() {
            document.getElementById('questionSection').classList.add('hidden');
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';

            document.getElementById('progressText').textContent = t('navigator.results', 'Results');
            document.getElementById('progressFill').style.width = '100%';

            // 마지막 선택에 해당하는 서비스 가져오기
            const lastSelection = selections[selections.length - 1];
            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);

            // 카테고리 필터 생성 (다국어)
            const categories = new Set(['all']);
            serviceIds.forEach(id => {
                if (allServices[id]) {
                    categories.add(allServices[id].category);
                }
            });

            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = Array.from(categories).map(cat => `
                <button class="category-btn ${cat === 'all' ? 'active' : ''}" onclick="filterCategory('${cat}', '${lastSelection}')">
                    ${getCategoryName(cat)}
                </button>
            `).join('');

            renderServices(serviceIds, 'all');
        }

        // 서비스 렌더링 (다국어)
        function renderServices(serviceIds, category) {
            const servicesContainer = document.getElementById('servicesGrid');

            let filteredIds = serviceIds;
            if (category !== 'all') {
                filteredIds = serviceIds.filter(id => allServices[id] && allServices[id].category === category);
            }

            servicesContainer.innerHTML = filteredIds.map(id => {
                const svc = allServices[id];
                if (!svc) return '';

                // 다국어 서비스명/설명
                const name = t(svc.nameKey, svc.name || id);
                const desc = t(svc.descKey, svc.desc || '');

                return `
                    <div class="service-item" onclick="applyService('${id}')">
                        <div class="title">${name}</div>
                        <div class="desc">${desc}</div>
                    </div>
                `;
            }).join('');
        }

        // 카테고리 필터 (다국어)
        function filterCategory(category, lastSelection) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === getCategoryName(category)) {
                    btn.classList.add('active');
                }
            });

            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);
            renderServices(serviceIds, category);
        }

        // 서비스 신청
        function applyService(code) {
            window.location.href = `service-apply-general.html?service=${code}`;
        }

        // 이전 단계
        function prevStep() {
            if (history.length > 0) {
                const prev = history.pop();
                currentStep = prev.step;
                selections = prev.selections;
                renderStep();
            }
        }

        // 뒤로가기
        function goBack() {
            if (currentStep > 1) {
                prevStep();
            } else {
                window.location.href = 'index.html';
            }
        }

        // 다시 시작
        function restart() {
            currentStep = 1;
            selections = [];
            history = [];
            renderStep();
        }

        // 다국어 변경 시 화면 갱신
        function refreshForLanguage() {
            // 정적 요소 i18n 적용
            if (typeof i18n !== 'undefined' && i18n.applyTranslations) {
                i18n.applyTranslations();
            }
            // 동적 콘텐츠 재렌더링
            const resultSection = document.getElementById('resultSection');
            if (resultSection && resultSection.style.display !== 'none') {
                // 결과 페이지일 때
                const lastSelection = selections[selections.length - 1];
                showResults();
            } else {
                // 질문 페이지일 때
                renderStep();
            }
        }

        // 언어 변경 이벤트 리스너
        document.addEventListener('languageChanged', refreshForLanguage);

        // 초기화 실행 (i18n 로드 후)
        function initWhenReady() {
            if (typeof i18n !== 'undefined') {
                init();
            } else {
                // i18n 로드 대기
                setTimeout(initWhenReady, 50);
            }
        }
    </script>

    <!-- i18n 다국어 지원 -->
    <script src="js/translations.js?v=20250128"></script>
    <script src="js/i18n.js?v=20250128"></script>
    <script>
        // i18n 로드 후 초기화
        initWhenReady();
    </script>
</body>
</html>
