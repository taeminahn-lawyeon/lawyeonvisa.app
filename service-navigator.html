<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Navigator - Lawyeon Visa & Immigration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F5F6F8;
            min-height: 100vh;
            color: #191F28;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 100%);
            padding: 20px 25px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 3px solid #3182F6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px 40px;
        }

        .progress-section {
            margin-bottom: 24px;
        }

        .progress-text {
            font-size: 14px;
            color: #8B95A1;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .progress-bar {
            height: 6px;
            background: #E5E8EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182F6, #1B64DA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .question-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid #E2E8F0;
        }

        .question-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
            line-height: 1.4;
            letter-spacing: -0.5px;
        }

        .question-subtitle {
            font-size: 15px;
            color: #8B95A1;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .option-btn {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }

        .option-btn:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .option-btn .option-title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .option-btn .option-desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.4;
        }

        .nav-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #F2F4F6;
        }

        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.secondary {
            background: #F2F4F6;
            border: none;
            color: #4E5968;
        }

        .nav-btn.secondary:hover {
            background: #E5E8EB;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-section {
            display: none;
        }

        .result-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .result-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
        }

        .result-subtitle {
            font-size: 15px;
            color: #8B95A1;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .service-item {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 110px;
        }

        .service-item:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .service-item .title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .service-item .desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.5;
        }

        .restart-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 32px;
            background: #F2F4F6;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: #E5E8EB;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 18px;
            border: 2px solid #E5E8EB;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: #3182F6;
            color: #3182F6;
        }

        .category-btn.active {
            background: #3182F6;
            border-color: #3182F6;
            color: white;
        }

        @media (max-width: 1024px) {
            .options-grid,
            .services-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px 16px 32px;
            }

            .question-card {
                padding: 24px 20px;
                border-radius: 20px;
            }

            .question-title {
                font-size: 20px;
            }

            .options-grid,
            .services-grid {
                grid-template-columns: 1fr;
            }

            .option-btn,
            .service-item {
                min-height: auto;
                padding: 20px;
            }

            .option-btn .option-title,
            .service-item .title {
                font-size: 15px;
            }

            .nav-section {
                flex-direction: column-reverse;
                gap: 12px;
            }

            .nav-btn {
                width: 100%;
                text-align: center;
            }

            .category-filter {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 8px;
            }

            .category-btn {
                flex-shrink: 0;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="header-title" data-i18n="navigator.header">Service Navigator</h1>
        </div>
    </div>

    <div class="container">
        <div class="progress-section">
            <div class="progress-text" id="progressText">Step 1 of 3</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
        </div>

        <div class="question-card" id="questionSection">
            <h2 class="question-title" id="questionTitle"></h2>
            <p class="question-subtitle" id="questionSubtitle"></p>
            <div class="options-grid" id="optionsGrid"></div>
            <div class="nav-section">
                <button class="nav-btn secondary" id="prevBtn" onclick="prevStep()" disabled>
                    <i class="fas fa-arrow-left"></i> <span data-i18n="navigator.back">Back</span>
                </button>
                <button class="nav-btn secondary" onclick="restart()">
                    <span data-i18n="navigator.startOver">Start Over</span>
                </button>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="question-card">
                <div class="result-header">
                    <h2 class="result-title" data-i18n="navigator.recommendedServices">Recommended Services</h2>
                    <p class="result-subtitle" data-i18n="navigator.resultSubtitle">Based on your selections, here are the available services:</p>
                </div>
                <div class="category-filter" id="categoryFilter"></div>
                <div class="services-grid" id="servicesGrid"></div>
                <button class="restart-btn" onclick="restart()">
                    <i class="fas fa-redo"></i> <span data-i18n="navigator.startOver">Start Over</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // 다국어 지원 헬퍼 함수
        // ============================================================
        function t(key, fallback) {
            if (typeof i18n !== 'undefined' && i18n.translate) {
                const result = i18n.translate(key);
                return result !== key ? result : fallback || key;
            }
            return fallback || key;
        }

        // ============================================================
        // 서비스 목록 - 서비스 ID만 저장, 이름/설명은 translations.js 참조
        // ============================================================
        const allServices = {
            // Premium Services (2)
            'visa-prediagnosis': { nameKey: 'service.visa_prediagnosis', descKey: 'service.visa_prediagnosis.desc', category: 'premium' },
            'emergency-legal': { nameKey: 'service.emergency_legal', descKey: 'service.emergency_legal.desc', category: 'premium' },

            // Education & Job Search (10)
            'd4-to-d2-change': { nameKey: 'service.d4_d2_change', descKey: 'service.d4_d2_change.desc', category: 'education' },
            'd10-1-change': { nameKey: 'service.d10_1_change', descKey: 'service.d10_1_change.desc', category: 'education' },
            'd10-2-change': { nameKey: 'service.d10_2_change', descKey: 'service.d10_2_change.desc', category: 'education' },
            'd10-3-change': { nameKey: 'service.d10_3_change', descKey: 'service.d10_3_change.desc', category: 'education' },
            'd10-t-change': { nameKey: 'service.d10_t_change', descKey: 'service.d10_t_change.desc', category: 'education' },
            'd2-d4-extension': { nameKey: 'service.d2_d4_extension', descKey: 'service.d2_d4_extension.desc', category: 'education' },
            'd10-extension': { nameKey: 'service.d10_extension', descKey: 'service.d10_extension.desc', category: 'education' },
            'parttime-permit': { nameKey: 'service.parttime_permit', descKey: 'service.parttime_permit.desc', category: 'education' },
            'intern-report': { nameKey: 'service.intern_report', descKey: 'service.intern_report.desc', category: 'education' },
            'parent-invite': { nameKey: 'service.parent_invite', descKey: 'service.parent_invite.desc', category: 'education' },

            // Employment (18)
            'e7-4-change': { nameKey: 'service.e7_4_change', descKey: 'service.e7_4_change.desc', category: 'employment' },
            'e7-4r-change': { nameKey: 'service.e7_4r_change', descKey: 'service.e7_4r_change.desc', category: 'employment' },
            'e7-change': { nameKey: 'service.e7_change', descKey: 'service.e7_change.desc', category: 'employment' },
            'f2-7-change': { nameKey: 'service.f2_7_change', descKey: 'service.f2_7_change.desc', category: 'employment' },
            'f2-r-change': { nameKey: 'service.f2_r_change', descKey: 'service.f2_r_change.desc', category: 'employment' },
            'e7-st-change': { nameKey: 'service.e7_st_change', descKey: 'service.e7_st_change.desc', category: 'employment' },
            'e1-e6-change': { nameKey: 'service.e1_e6_change', descKey: 'service.e1_e6_change.desc', category: 'employment' },
            'e7-extension': { nameKey: 'service.e7_extension', descKey: 'service.e7_extension.desc', category: 'employment' },
            'e9-workplace-change': { nameKey: 'service.e9_workplace_change', descKey: 'service.e9_workplace_change.desc', category: 'employment' },
            'workplace-change-permit': { nameKey: 'service.workplace_change_permit', descKey: 'service.workplace_change_permit.desc', category: 'employment' },
            'outside-activity': { nameKey: 'service.outside_activity', descKey: 'service.outside_activity.desc', category: 'employment' },
            'h2-work-start': { nameKey: 'service.h2_work_start', descKey: 'service.h2_work_start.desc', category: 'employment' },
            'workplace-change-report': { nameKey: 'service.workplace_change_report', descKey: 'service.workplace_change_report.desc', category: 'employment' },
            'employment-info-change': { nameKey: 'service.employment_info_change', descKey: 'service.employment_info_change.desc', category: 'employment' },
            'dispatch-report': { nameKey: 'service.dispatch_report', descKey: 'service.dispatch_report.desc', category: 'employment' },
            'income-report': { nameKey: 'service.income_report', descKey: 'service.income_report.desc', category: 'employment' },
            'foreign-worker-change': { nameKey: 'service.foreign_worker_change', descKey: 'service.foreign_worker_change.desc', category: 'employment' },

            // Business & Investment (12)
            'd8-1-change': { nameKey: 'service.d8_1_change', descKey: 'service.d8_1_change.desc', category: 'business' },
            'd8-2-change': { nameKey: 'service.d8_2_change', descKey: 'service.d8_2_change.desc', category: 'business' },
            'd8-3-change': { nameKey: 'service.d8_3_change', descKey: 'service.d8_3_change.desc', category: 'business' },
            'd8-4-change': { nameKey: 'service.d8_4_change', descKey: 'service.d8_4_change.desc', category: 'business' },
            'd9-1-change': { nameKey: 'service.d9_1_change', descKey: 'service.d9_1_change.desc', category: 'business' },
            'd9-2-change': { nameKey: 'service.d9_2_change', descKey: 'service.d9_2_change.desc', category: 'business' },
            'd9-3-change': { nameKey: 'service.d9_3_change', descKey: 'service.d9_3_change.desc', category: 'business' },
            'd9-4-change': { nameKey: 'service.d9_4_change', descKey: 'service.d9_4_change.desc', category: 'business' },
            'd9-5-change': { nameKey: 'service.d9_5_change', descKey: 'service.d9_5_change.desc', category: 'business' },
            'business-extension': { nameKey: 'service.business_extension', descKey: 'service.business_extension.desc', category: 'business' },
            'fic-registration': { nameKey: 'service.fic_registration', descKey: 'service.fic_registration.desc', category: 'business' },
            'fi-report': { nameKey: 'service.fi_report', descKey: 'service.fi_report.desc', category: 'business' },

            // Ethnic Korean & Family (13)
            'h2-to-f4-change': { nameKey: 'service.h2_f4_change', descKey: 'service.h2_f4_change.desc', category: 'family' },
            'f4-change': { nameKey: 'service.f4_change', descKey: 'service.f4_change.desc', category: 'family' },
            'f4-registration': { nameKey: 'service.f4_registration', descKey: 'service.f4_registration.desc', category: 'family' },
            'f4-extension': { nameKey: 'service.f4_extension', descKey: 'service.f4_extension.desc', category: 'family' },
            'h2-extension': { nameKey: 'service.h2_extension', descKey: 'service.h2_extension.desc', category: 'family' },
            'f6-change': { nameKey: 'service.f6_change', descKey: 'service.f6_change.desc', category: 'family' },
            'f6-extension': { nameKey: 'service.f6_extension', descKey: 'service.f6_extension.desc', category: 'family' },
            'f3-change': { nameKey: 'service.f3_change', descKey: 'service.f3_change.desc', category: 'family' },
            'f1-change': { nameKey: 'service.f1_change', descKey: 'service.f1_change.desc', category: 'family' },
            'visa-grant-child': { nameKey: 'service.visa_grant_child', descKey: 'service.visa_grant_child.desc', category: 'family' },
            'visa-grant-f6-child': { nameKey: 'service.visa_grant_f6_child', descKey: 'service.visa_grant_f6_child.desc', category: 'family' },
            'family-invite': { nameKey: 'service.family_invite', descKey: 'service.family_invite.desc', category: 'family' },
            'housework-report': { nameKey: 'service.housework_report', descKey: 'service.housework_report.desc', category: 'family' },

            // Residence & Citizenship (11)
            'f5-change': { nameKey: 'service.f5_change', descKey: 'service.f5_change.desc', category: 'residence' },
            'f5-reissue': { nameKey: 'service.f5_reissue', descKey: 'service.f5_reissue.desc', category: 'residence' },
            'f2-extension': { nameKey: 'service.f2_extension', descKey: 'service.f2_extension.desc', category: 'residence' },
            'naturalization': { nameKey: 'service.naturalization', descKey: 'service.naturalization.desc', category: 'residence' },
            'nationality-recovery': { nameKey: 'service.nationality_recovery', descKey: 'service.nationality_recovery.desc', category: 'residence' },
            'nationality-selection': { nameKey: 'service.nationality_selection', descKey: 'service.nationality_selection.desc', category: 'residence' },
            'nationality-renounce': { nameKey: 'service.nationality_renounce', descKey: 'service.nationality_renounce.desc', category: 'residence' },
            'nationality-loss': { nameKey: 'service.nationality_loss', descKey: 'service.nationality_loss.desc', category: 'residence' },
            'nationality-retention': { nameKey: 'service.nationality_retention', descKey: 'service.nationality_retention.desc', category: 'residence' },
            'nationality-acquisition': { nameKey: 'service.nationality_acquisition', descKey: 'service.nationality_acquisition.desc', category: 'residence' },
            'nationality-judgment': { nameKey: 'service.nationality_judgment', descKey: 'service.nationality_judgment.desc', category: 'residence' },

            // General Registration & Certificates (13)
            'arc-registration': { nameKey: 'service.arc_registration', descKey: 'service.arc_registration.desc', category: 'registration' },
            'arc-reissue': { nameKey: 'service.arc_reissue', descKey: 'service.arc_reissue.desc', category: 'registration' },
            'address-change': { nameKey: 'service.address_change', descKey: 'service.address_change.desc', category: 'registration' },
            'f4-address-change': { nameKey: 'service.f4_address_change', descKey: 'service.f4_address_change.desc', category: 'registration' },
            'passport-change': { nameKey: 'service.passport_change', descKey: 'service.passport_change.desc', category: 'registration' },
            'reentry-permit-multiple': { nameKey: 'service.reentry_multiple', descKey: 'service.reentry_multiple.desc', category: 'registration' },
            'reentry-permit-single': { nameKey: 'service.reentry_single', descKey: 'service.reentry_single.desc', category: 'registration' },
            'cert-entry-exit': { nameKey: 'service.cert_entry_exit', descKey: 'service.cert_entry_exit.desc', category: 'registration' },
            'cert-arc': { nameKey: 'service.cert_arc', descKey: 'service.cert_arc.desc', category: 'registration' },
            'cert-residence': { nameKey: 'service.cert_residence', descKey: 'service.cert_residence.desc', category: 'registration' },
            'cert-realestate': { nameKey: 'service.cert_realestate', descKey: 'service.cert_realestate.desc', category: 'registration' },
            'cert-arc-number-change': { nameKey: 'service.cert_number_change', descKey: 'service.cert_number_change.desc', category: 'registration' },
            'cert-nationality': { nameKey: 'service.cert_nationality', descKey: 'service.cert_nationality.desc', category: 'registration' }
        };

        // 카테고리 키 (번역 키로 사용)
        const categoryKeys = {
            'all': 'navigator.category.all',
            'premium': 'navigator.category.premium',
            'education': 'navigator.category.education',
            'employment': 'navigator.category.employment',
            'business': 'navigator.category.business',
            'family': 'navigator.category.family',
            'residence': 'navigator.category.residence',
            'registration': 'navigator.category.registration'
        };

        // 카테고리 이름 가져오기
        function getCategoryName(cat) {
            return t(categoryKeys[cat], cat);
        }

        // ============================================================
        // 3단계 분류 체계 - STEP 1: 현재 비자 유형
        // ============================================================
        const questions = {
            step1: {
                titleKey: "navigator.step1.title",
                subtitleKey: "navigator.step1.subtitle",
                options: [
                    { id: "student", titleKey: "navigator.step1.student", descKey: "navigator.step1.student.desc" },
                    { id: "jobseeker", titleKey: "navigator.step1.jobseeker", descKey: "navigator.step1.jobseeker.desc" },
                    { id: "worker", titleKey: "navigator.step1.worker", descKey: "navigator.step1.worker.desc" },
                    { id: "business", titleKey: "navigator.step1.business", descKey: "navigator.step1.business.desc" },
                    { id: "korean_diaspora", titleKey: "navigator.step1.korean_diaspora", descKey: "navigator.step1.korean_diaspora.desc" },
                    { id: "family", titleKey: "navigator.step1.family", descKey: "navigator.step1.family.desc" },
                    { id: "resident", titleKey: "navigator.step1.resident", descKey: "navigator.step1.resident.desc" },
                    { id: "corporate_hr", titleKey: "navigator.step1.corporate_hr", descKey: "navigator.step1.corporate_hr.desc" },
                    { id: "short_term", titleKey: "navigator.step1.short_term", descKey: "navigator.step1.short_term.desc" },
                    { id: "d7_expat", titleKey: "navigator.step1.d7_expat", descKey: "navigator.step1.d7_expat.desc" }
                ]
            },
            // STEP 2: 하고 싶은 일 (비자 유형별)
            step2: {
                // 유학생 (D-2, D-4)
                student: {
                    titleKey: "navigator.step2.student.title",
                    subtitleKey: "navigator.step2.student.subtitle",
                    options: [
                        { id: "stu_upgrade", titleKey: "navigator.step2.stu_upgrade", descKey: "navigator.step2.stu_upgrade.desc" },
                        { id: "stu_extend", titleKey: "navigator.step2.stu_extend", descKey: "navigator.step2.stu_extend.desc" },
                        { id: "stu_parttime", titleKey: "navigator.step2.stu_parttime", descKey: "navigator.step2.stu_parttime.desc" },
                        { id: "stu_jobsearch", titleKey: "navigator.step2.stu_jobsearch", descKey: "navigator.step2.stu_jobsearch.desc" },
                        { id: "stu_employment", titleKey: "navigator.step2.stu_employment", descKey: "navigator.step2.stu_employment.desc" },
                        { id: "stu_startup", titleKey: "navigator.step2.stu_startup", descKey: "navigator.step2.stu_startup.desc" },
                        { id: "stu_family", titleKey: "navigator.step2.stu_family", descKey: "navigator.step2.stu_family.desc" },
                        { id: "stu_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 구직자 (D-10)
                jobseeker: {
                    titleKey: "navigator.step2.jobseeker.title",
                    subtitleKey: "navigator.step2.jobseeker.subtitle",
                    options: [
                        { id: "job_extend", titleKey: "navigator.step2.job_extend", descKey: "navigator.step2.job_extend.desc" },
                        { id: "job_employment", titleKey: "navigator.step2.job_employment", descKey: "navigator.step2.job_employment.desc" },
                        { id: "job_intern", titleKey: "navigator.step2.job_intern", descKey: "navigator.step2.job_intern.desc" },
                        { id: "job_startup", titleKey: "navigator.step2.job_startup", descKey: "navigator.step2.job_startup.desc" },
                        { id: "job_family", titleKey: "navigator.step2.job_family", descKey: "navigator.step2.job_family.desc" },
                        { id: "job_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 취업자 (E-1~E-7)
                worker: {
                    titleKey: "navigator.step2.worker.title",
                    subtitleKey: "navigator.step2.worker.subtitle",
                    options: [
                        { id: "work_extend", titleKey: "navigator.step2.work_extend", descKey: "navigator.step2.work_extend.desc" },
                        { id: "work_change_job", titleKey: "navigator.step2.work_change_job", descKey: "navigator.step2.work_change_job.desc" },
                        { id: "work_outside", titleKey: "navigator.step2.work_outside", descKey: "navigator.step2.work_outside.desc" },
                        { id: "work_skilled", titleKey: "navigator.step2.work_skilled", descKey: "navigator.step2.work_skilled.desc" },
                        { id: "work_f27", titleKey: "navigator.step2.work_f27", descKey: "navigator.step2.work_f27.desc" },
                        { id: "work_d10", titleKey: "navigator.step2.work_d10", descKey: "navigator.step2.work_d10.desc" },
                        { id: "work_family", titleKey: "navigator.step2.work_family", descKey: "navigator.step2.work_family.desc" },
                        { id: "work_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 사업자/투자자 (D-8, D-9)
                business: {
                    titleKey: "navigator.step2.business.title",
                    subtitleKey: "navigator.step2.business.subtitle",
                    options: [
                        { id: "biz_extend", titleKey: "navigator.step2.biz_extend", descKey: "navigator.step2.biz_extend.desc" },
                        { id: "biz_e7", titleKey: "navigator.step2.biz_e7", descKey: "navigator.step2.biz_e7.desc" },
                        { id: "biz_f27", titleKey: "navigator.step2.biz_f27", descKey: "navigator.step2.biz_f27.desc" },
                        { id: "biz_report", titleKey: "navigator.step2.biz_report", descKey: "navigator.step2.biz_report.desc" },
                        { id: "biz_family", titleKey: "navigator.step2.biz_family", descKey: "navigator.step2.biz_family.desc" },
                        { id: "biz_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 재외동포 (F-4, H-2)
                korean_diaspora: {
                    titleKey: "navigator.step2.korean_diaspora.title",
                    subtitleKey: "navigator.step2.korean_diaspora.subtitle",
                    options: [
                        { id: "kd_f4_extend", titleKey: "navigator.step2.kd_f4_extend", descKey: "navigator.step2.kd_f4_extend.desc" },
                        { id: "kd_h2_extend", titleKey: "navigator.step2.kd_h2_extend", descKey: "navigator.step2.kd_h2_extend.desc" },
                        { id: "kd_h2_to_f4", titleKey: "navigator.step2.kd_h2_to_f4", descKey: "navigator.step2.kd_h2_to_f4.desc" },
                        { id: "kd_work_start", titleKey: "navigator.step2.kd_work_start", descKey: "navigator.step2.kd_work_start.desc" },
                        { id: "kd_f5", titleKey: "navigator.step2.kd_f5", descKey: "navigator.step2.kd_f5.desc" },
                        { id: "kd_registration", titleKey: "navigator.step2.kd_registration", descKey: "navigator.step2.kd_registration.desc" },
                        { id: "kd_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 가족/결혼 (F-3, F-6, F-1)
                family: {
                    titleKey: "navigator.step2.family.title",
                    subtitleKey: "navigator.step2.family.subtitle",
                    options: [
                        { id: "fam_f6_extend", titleKey: "navigator.step2.fam_f6_extend", descKey: "navigator.step2.fam_f6_extend.desc" },
                        { id: "fam_f3_change", titleKey: "navigator.step2.fam_f3_change", descKey: "navigator.step2.fam_f3_change.desc" },
                        { id: "fam_f1_change", titleKey: "navigator.step2.fam_f1_change", descKey: "navigator.step2.fam_f1_change.desc" },
                        { id: "fam_f5", titleKey: "navigator.step2.fam_f5", descKey: "navigator.step2.fam_f5.desc" },
                        { id: "fam_child", titleKey: "navigator.step2.fam_child", descKey: "navigator.step2.fam_child.desc" },
                        { id: "fam_housework", titleKey: "navigator.step2.fam_housework", descKey: "navigator.step2.fam_housework.desc" },
                        { id: "fam_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 영주권자/장기체류 (F-5, F-2)
                resident: {
                    titleKey: "navigator.step2.resident.title",
                    subtitleKey: "navigator.step2.resident.subtitle",
                    options: [
                        { id: "res_f2_extend", titleKey: "navigator.step2.res_f2_extend", descKey: "navigator.step2.res_f2_extend.desc" },
                        { id: "res_f5_reissue", titleKey: "navigator.step2.res_f5_reissue", descKey: "navigator.step2.res_f5_reissue.desc" },
                        { id: "res_naturalize", titleKey: "navigator.step2.res_naturalize", descKey: "navigator.step2.res_naturalize.desc" },
                        { id: "res_nationality", titleKey: "navigator.step2.res_nationality", descKey: "navigator.step2.res_nationality.desc" },
                        { id: "res_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // 기업 HR
                corporate_hr: {
                    titleKey: "navigator.step2.corporate_hr.title",
                    subtitleKey: "navigator.step2.corporate_hr.subtitle",
                    options: [
                        { id: "hr_e7", titleKey: "navigator.step2.hr_e7", descKey: "navigator.step2.hr_e7.desc" },
                        { id: "hr_f3", titleKey: "navigator.step2.hr_f3", descKey: "navigator.step2.hr_f3.desc" },
                        { id: "hr_intern", titleKey: "navigator.step2.hr_intern", descKey: "navigator.step2.hr_intern.desc" },
                        { id: "hr_worker_change", titleKey: "navigator.step2.hr_worker_change", descKey: "navigator.step2.hr_worker_change.desc" },
                        { id: "hr_short_visit", titleKey: "navigator.step2.hr_short_visit", descKey: "navigator.step2.hr_short_visit.desc" },
                        { id: "hr_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // C비자 (C-3, C-4)
                short_term: {
                    titleKey: "navigator.step2.short_term.title",
                    subtitleKey: "navigator.step2.short_term.subtitle",
                    options: [
                        { id: "st_d9_invest", titleKey: "navigator.step2.st_d9_invest", descKey: "navigator.step2.st_d9_invest.desc" },
                        { id: "st_e7_work", titleKey: "navigator.step2.st_e7_work", descKey: "navigator.step2.st_e7_work.desc" },
                        { id: "st_d2_study", titleKey: "navigator.step2.st_d2_study", descKey: "navigator.step2.st_d2_study.desc" },
                        { id: "st_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                },
                // D-7 주재
                d7_expat: {
                    titleKey: "navigator.step2.d7_expat.title",
                    subtitleKey: "navigator.step2.d7_expat.subtitle",
                    options: [
                        { id: "d7_e7", titleKey: "navigator.step2.d7_e7", descKey: "navigator.step2.d7_e7.desc" },
                        { id: "d7_f27", titleKey: "navigator.step2.d7_f27", descKey: "navigator.step2.d7_f27.desc" },
                        { id: "d7_family", titleKey: "navigator.step2.d7_family", descKey: "navigator.step2.d7_family.desc" },
                        { id: "d7_general", titleKey: "navigator.step2.general", descKey: "navigator.step2.general.desc" }
                    ]
                }
            },
            // STEP 3: 세부 선택이 필요한 경우
            step3: {
                // 유학생 → 창업
                stu_startup: {
                    titleKey: "navigator.step3.startup.title",
                    subtitleKey: "navigator.step3.startup.subtitle",
                    options: [
                        { id: "startup_tech", titleKey: "navigator.step3.startup_tech", descKey: "navigator.step3.startup_tech.desc" },
                        { id: "startup_personal", titleKey: "navigator.step3.startup_personal", descKey: "navigator.step3.startup_personal.desc" }
                    ]
                },
                // 구직자 → 창업
                job_startup: {
                    titleKey: "navigator.step3.startup.title",
                    subtitleKey: "navigator.step3.startup.subtitle",
                    options: [
                        { id: "startup_tech", titleKey: "navigator.step3.startup_tech", descKey: "navigator.step3.startup_tech.desc" },
                        { id: "startup_personal", titleKey: "navigator.step3.startup_personal", descKey: "navigator.step3.startup_personal.desc" }
                    ]
                },
                // C비자 → 투자
                st_d9_invest: {
                    titleKey: "navigator.step3.c_invest.title",
                    subtitleKey: "navigator.step3.c_invest.subtitle",
                    options: [
                        { id: "c_d8_corporate", titleKey: "navigator.step3.c_d8_corporate", descKey: "navigator.step3.c_d8_corporate.desc" },
                        { id: "c_d9_trade", titleKey: "navigator.step3.c_d9_trade", descKey: "navigator.step3.c_d9_trade.desc" },
                        { id: "c_d92_machine", titleKey: "navigator.step3.c_d92_machine", descKey: "navigator.step3.c_d92_machine.desc" },
                        { id: "c_d93_ship", titleKey: "navigator.step3.c_d93_ship", descKey: "navigator.step3.c_d93_ship.desc" }
                    ]
                }
            }
        };

        // ============================================================
        // 서비스 매핑 (각 선택에 해당하는 서비스 ID 배열)
        // ============================================================
        const serviceMapping = {
            // === 유학생 (D-2, D-4) ===
            stu_upgrade: ['d4-to-d2-change'],
            stu_extend: ['d2-d4-extension'],
            stu_parttime: ['parttime-permit'],
            stu_jobsearch: ['d10-1-change', 'd10-2-change', 'd10-3-change', 'd10-t-change'],
            stu_employment: ['e7-change', 'e7-st-change'],
            stu_family: ['parent-invite', 'family-invite'],
            stu_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],
            // 유학생 창업 - STEP 3
            startup_tech: ['d8-4-change', 'd9-5-change'],
            startup_personal: ['d9-4-change'],

            // === 구직자 (D-10) ===
            job_extend: ['d10-extension'],
            job_employment: ['e7-change', 'e7-st-change'],
            job_intern: ['intern-report'],
            job_family: ['family-invite'],
            job_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],

            // === 취업자 (E-1~E-7) ===
            work_extend: ['e7-extension'],
            work_change_job: ['workplace-change-permit', 'workplace-change-report'],
            work_outside: ['outside-activity'],
            work_skilled: ['e7-4-change', 'e7-4r-change'],
            work_f27: ['f2-7-change', 'f2-r-change'],
            work_d10: ['d10-1-change', 'd10-2-change', 'd10-3-change', 'd10-t-change'],
            work_family: ['f3-change', 'family-invite'],
            work_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'employment-info-change', 'dispatch-report', 'income-report', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],

            // === 사업자/투자자 (D-8, D-9) ===
            biz_extend: ['business-extension'],
            biz_e7: ['e7-change'],
            biz_f27: ['f2-7-change', 'f2-r-change'],
            biz_report: ['fic-registration', 'fi-report'],
            biz_family: ['f3-change', 'family-invite'],
            biz_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],

            // === 재외동포 (F-4, H-2) ===
            kd_f4_extend: ['f4-extension'],
            kd_h2_extend: ['h2-extension'],
            kd_h2_to_f4: ['h2-to-f4-change', 'f4-change'],
            kd_work_start: ['h2-work-start'],
            kd_f5: ['f5-change'],
            kd_registration: ['f4-registration', 'f4-address-change'],
            kd_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'housework-report', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],

            // === 가족/결혼 (F-3, F-6, F-1) ===
            fam_f6_extend: ['f6-extension'],
            fam_f3_change: ['f3-change'],
            fam_f1_change: ['f1-change', 'f6-change'],
            fam_f5: ['f5-change'],
            fam_child: ['visa-grant-child', 'visa-grant-f6-child'],
            fam_housework: ['housework-report'],
            fam_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],

            // === 영주권자/장기체류 (F-5, F-2) ===
            res_f2_extend: ['f2-extension'],
            res_f5_reissue: ['f5-reissue'],
            res_naturalize: ['naturalization'],
            res_nationality: ['nationality-recovery', 'nationality-selection', 'nationality-renounce', 'nationality-loss', 'nationality-retention', 'nationality-acquisition', 'nationality-judgment'],
            res_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence', 'cert-realestate', 'cert-arc-number-change', 'cert-nationality'],

            // === 기업 HR ===
            hr_e7: ['e7-change', 'e1-e6-change', 'e7-st-change'],
            hr_f3: ['f3-change'],
            hr_intern: ['intern-report'],
            hr_worker_change: ['foreign-worker-change', 'employment-info-change', 'dispatch-report', 'income-report', 'workplace-change-report', 'e9-workplace-change'],
            hr_short_visit: ['visa-prediagnosis'],
            hr_general: ['visa-prediagnosis', 'emergency-legal'],

            // === C비자 (C-3, C-4) → STEP 3 세부 ===
            c_d8_corporate: ['d8-1-change', 'd8-2-change', 'd8-3-change'],
            c_d9_trade: ['d9-1-change', 'd9-4-change'],
            c_d92_machine: ['d9-2-change'],
            c_d93_ship: ['d9-3-change'],
            st_e7_work: ['e7-change', 'e1-e6-change'],
            st_d2_study: ['d4-to-d2-change'],
            st_general: ['visa-prediagnosis', 'emergency-legal'],

            // === D-7 주재 ===
            d7_e7: ['e7-change'],
            d7_f27: ['f2-7-change', 'f2-r-change'],
            d7_family: ['f3-change', 'family-invite'],
            d7_general: ['arc-registration', 'arc-reissue', 'address-change', 'passport-change', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence'],

            // === 상담 (마지막 폴백) ===
            need_consultation: ['visa-prediagnosis', 'emergency-legal']
        };

        // ============================================================
        // 상태 관리
        // ============================================================
        let currentStep = 1;
        let selections = [];
        let history = [];

        // 초기화
        function init() {
            renderStep();
        }

        // 현재 단계 렌더링
        function renderStep() {
            const questionSection = document.getElementById('questionSection');
            const resultSection = document.getElementById('resultSection');

            questionSection.classList.remove('hidden');
            resultSection.style.display = 'none';

            let stepData;
            let totalSteps = 3;

            if (currentStep === 1) {
                stepData = questions.step1;
            } else if (currentStep === 2) {
                stepData = questions.step2[selections[0]];
            } else if (currentStep === 3) {
                // STEP 3는 특정 경로에서만 필요
                const step2Selection = selections[1];
                stepData = questions.step3[step2Selection];
            }

            if (!stepData) {
                showResults();
                return;
            }

            // 진행률 업데이트 (다국어)
            const stepText = t('navigator.stepOf', 'Step {0} of {1}')
                .replace('{0}', currentStep)
                .replace('{1}', totalSteps);
            document.getElementById('progressText').textContent = stepText;
            document.getElementById('progressFill').style.width = `${currentStep * 33}%`;

            // 질문 업데이트 (다국어)
            document.getElementById('questionTitle').textContent = t(stepData.titleKey, stepData.title || '');
            document.getElementById('questionSubtitle').textContent = t(stepData.subtitleKey, stepData.subtitle || '');

            // 옵션 렌더링 (다국어)
            const optionsGrid = document.getElementById('optionsGrid');
            let optionsHtml = stepData.options.map(opt => {
                const title = t(opt.titleKey, opt.title || '');
                const desc = t(opt.descKey, opt.desc || '');
                return `
                <button class="option-btn" onclick="selectOption('${opt.id}')">
                    <div class="option-title">${title}</div>
                    ${desc ? `<div class="option-desc">${desc}</div>` : ''}
                </button>
            `;
            }).join('');

            // STEP 2, 3에서만 "상담이 필요해요" 옵션 추가
            if (currentStep >= 2) {
                const consultTitle = t('navigator.need_consultation', '상담이 필요해요');
                const consultDesc = t('navigator.need_consultation.desc', '어떤 서비스가 필요한지 모르겠어요');
                optionsHtml += `
                <button class="option-btn" onclick="openConsultation()" style="border: 2px dashed #8B95A1;">
                    <div class="option-title">${consultTitle}</div>
                    <div class="option-desc">${consultDesc}</div>
                </button>
                `;
            }

            optionsGrid.innerHTML = optionsHtml;

            // 뒤로가기 버튼
            document.getElementById('prevBtn').disabled = currentStep === 1;
        }

        // 옵션 선택
        function selectOption(optionId) {
            history.push({ step: currentStep, selections: [...selections] });
            selections[currentStep - 1] = optionId;

            // STEP 3가 필요한지 확인
            if (currentStep === 2 && questions.step3[optionId]) {
                currentStep = 3;
                renderStep();
                return;
            }

            // 서비스 매핑이 있으면 결과 표시
            if (serviceMapping[optionId]) {
                showResults();
            } else {
                currentStep++;
                if (currentStep > 3) {
                    showResults();
                } else {
                    renderStep();
                }
            }
        }

        // 상담 신청 (결제 없이 쓰레드 열기)
        function openConsultation() {
            // consultation 파라미터로 service-apply-general로 이동
            window.location.href = 'service-apply-general.html?service=consultation&mode=free';
        }

        // 결과 표시
        function showResults() {
            document.getElementById('questionSection').classList.add('hidden');
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';

            document.getElementById('progressText').textContent = t('navigator.results', 'Results');
            document.getElementById('progressFill').style.width = '100%';

            // 마지막 선택에 해당하는 서비스 가져오기
            const lastSelection = selections[selections.length - 1];
            let serviceIds = serviceMapping[lastSelection];

            // 매핑이 없으면 상담 서비스로 폴백
            if (!serviceIds || serviceIds.length === 0) {
                serviceIds = ['visa-prediagnosis', 'emergency-legal'];
            }

            // 카테고리 필터 생성 (다국어)
            const categories = new Set(['all']);
            serviceIds.forEach(id => {
                if (allServices[id]) {
                    categories.add(allServices[id].category);
                }
            });

            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = Array.from(categories).map(cat => `
                <button class="category-btn ${cat === 'all' ? 'active' : ''}" onclick="filterCategory('${cat}', '${lastSelection}')">
                    ${getCategoryName(cat)}
                </button>
            `).join('');

            renderServices(serviceIds, 'all');
        }

        // 서비스 렌더링 (다국어)
        function renderServices(serviceIds, category) {
            const servicesContainer = document.getElementById('servicesGrid');

            let filteredIds = serviceIds;
            if (category !== 'all') {
                filteredIds = serviceIds.filter(id => allServices[id] && allServices[id].category === category);
            }

            servicesContainer.innerHTML = filteredIds.map(id => {
                const svc = allServices[id];
                if (!svc) return '';

                // 다국어 서비스명/설명
                const name = t(svc.nameKey, svc.name || id);
                const desc = t(svc.descKey, svc.desc || '');

                return `
                    <div class="service-item" onclick="applyService('${id}')">
                        <div class="title">${name}</div>
                        <div class="desc">${desc}</div>
                    </div>
                `;
            }).join('');
        }

        // 카테고리 필터 (다국어)
        function filterCategory(category, lastSelection) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === getCategoryName(category)) {
                    btn.classList.add('active');
                }
            });

            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);
            renderServices(serviceIds, category);
        }

        // 서비스 신청
        function applyService(code) {
            window.location.href = `service-apply-general.html?service=${code}`;
        }

        // 이전 단계
        function prevStep() {
            if (history.length > 0) {
                const prev = history.pop();
                currentStep = prev.step;
                selections = prev.selections;
                renderStep();
            }
        }

        // 뒤로가기
        function goBack() {
            if (currentStep > 1) {
                prevStep();
            } else {
                window.location.href = 'index.html';
            }
        }

        // 다시 시작
        function restart() {
            currentStep = 1;
            selections = [];
            history = [];
            renderStep();
        }

        // 다국어 변경 시 화면 갱신
        function refreshForLanguage() {
            // 정적 요소 i18n 적용
            if (typeof i18n !== 'undefined' && i18n.applyTranslations) {
                i18n.applyTranslations();
            }
            // 동적 콘텐츠 재렌더링
            const resultSection = document.getElementById('resultSection');
            if (resultSection && resultSection.style.display !== 'none') {
                // 결과 페이지일 때
                const lastSelection = selections[selections.length - 1];
                showResults();
            } else {
                // 질문 페이지일 때
                renderStep();
            }
        }

        // 언어 변경 이벤트 리스너
        document.addEventListener('languageChanged', refreshForLanguage);

        // 초기화 실행 (i18n 로드 후)
        function initWhenReady() {
            if (typeof i18n !== 'undefined') {
                init();
            } else {
                // i18n 로드 대기
                setTimeout(initWhenReady, 50);
            }
        }
    </script>

    <!-- i18n 다국어 지원 -->
    <script src="js/translations.js?v=20250128"></script>
    <script src="js/i18n.js?v=20250128"></script>
    <script>
        // i18n 로드 후 초기화
        initWhenReady();
    </script>
</body>
</html>
