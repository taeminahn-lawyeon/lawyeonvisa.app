<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Navigator - Lawyeon Visa & Immigration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F5F6F8;
            min-height: 100vh;
            color: #191F28;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 100%);
            padding: 20px 25px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 3px solid #3182F6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px 40px;
        }

        .progress-section {
            margin-bottom: 24px;
        }

        .progress-text {
            font-size: 14px;
            color: #8B95A1;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .progress-bar {
            height: 6px;
            background: #E5E8EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182F6, #1B64DA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .question-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid #E2E8F0;
        }

        .question-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
            line-height: 1.4;
            letter-spacing: -0.5px;
        }

        .question-subtitle {
            font-size: 15px;
            color: #8B95A1;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .option-btn {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }

        .option-btn:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .option-btn .option-title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .option-btn .option-desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.4;
        }

        .nav-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #F2F4F6;
        }

        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.secondary {
            background: #F2F4F6;
            border: none;
            color: #4E5968;
        }

        .nav-btn.secondary:hover {
            background: #E5E8EB;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-section {
            display: none;
        }

        .result-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .result-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
        }

        .result-subtitle {
            font-size: 15px;
            color: #8B95A1;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .service-item {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 110px;
        }

        .service-item:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .service-item .title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .service-item .desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.5;
        }

        .restart-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 32px;
            background: #F2F4F6;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: #E5E8EB;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 18px;
            border: 2px solid #E5E8EB;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: #3182F6;
            color: #3182F6;
        }

        .category-btn.active {
            background: #3182F6;
            border-color: #3182F6;
            color: white;
        }

        @media (max-width: 1024px) {
            .options-grid,
            .services-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px 16px 32px;
            }

            .question-card {
                padding: 24px 20px;
                border-radius: 20px;
            }

            .question-title {
                font-size: 20px;
            }

            .options-grid,
            .services-grid {
                grid-template-columns: 1fr;
            }

            .option-btn,
            .service-item {
                min-height: auto;
                padding: 20px;
            }

            .option-btn .option-title,
            .service-item .title {
                font-size: 15px;
            }

            .nav-section {
                flex-direction: column-reverse;
                gap: 12px;
            }

            .nav-btn {
                width: 100%;
                text-align: center;
            }

            .category-filter {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 8px;
            }

            .category-btn {
                flex-shrink: 0;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="header-title">Service Navigator</h1>
        </div>
    </div>

    <div class="container">
        <div class="progress-section">
            <div class="progress-text" id="progressText">Step 1 of 3</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
        </div>

        <div class="question-card" id="questionSection">
            <h2 class="question-title" id="questionTitle"></h2>
            <p class="question-subtitle" id="questionSubtitle"></p>
            <div class="options-grid" id="optionsGrid"></div>
            <div class="nav-section">
                <button class="nav-btn secondary" id="prevBtn" onclick="prevStep()" disabled>
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="nav-btn secondary" onclick="restart()">
                    Start Over
                </button>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="question-card">
                <div class="result-header">
                    <h2 class="result-title">Recommended Services</h2>
                    <p class="result-subtitle">Based on your selections, here are the available services:</p>
                </div>
                <div class="category-filter" id="categoryFilter"></div>
                <div class="services-grid" id="servicesGrid"></div>
                <button class="restart-btn" onclick="restart()">
                    <i class="fas fa-redo"></i> Start Over
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // 서비스 목록 (service-apply-general.html의 servicePricing과 동일)
        // ============================================================
        const allServices = {
            // Premium Services (2)
            'visa-prediagnosis': { name: 'Visa Pre-diagnosis', desc: 'Visa change, overstay risk, immigration law consultation', category: 'premium' },
            'emergency-legal': { name: 'Immigration Dispute Resolution', desc: 'Criminal investigation, deportation defense, visa denial appeals', category: 'premium' },

            // Education & Job Search (10)
            'd4-to-d2-change': { name: 'D-4→D-2 Student Visa Change', desc: 'Language course to degree program', category: 'education' },
            'd10-1-change': { name: 'D-10-1 Job Seeker Visa Change', desc: 'General job seeking visa', category: 'education' },
            'd10-2-change': { name: 'D-10-2 Tech Startup Job Seeker', desc: 'Startup preparation visa', category: 'education' },
            'd10-3-change': { name: 'D-10-3 High-tech Intern Visa', desc: 'Advanced technology internship', category: 'education' },
            'd10-t-change': { name: 'D-10-T Top Talent Job Seeker', desc: 'Elite university graduate visa', category: 'education' },
            'd2-d4-extension': { name: 'D-2, D-4 Visa Extension', desc: 'Student visa renewal', category: 'education' },
            'd10-extension': { name: 'D-10 Visa Extension', desc: 'Job seeker visa renewal', category: 'education' },
            'parttime-permit': { name: 'Part-time Work Permit', desc: 'D-2, D-4 part-time employment', category: 'education' },
            'intern-report': { name: 'Internship Start/Change Report', desc: 'D-10 internship notification', category: 'education' },
            'parent-invite': { name: 'Student Parent Invitation', desc: 'Excellent student parent visa', category: 'education' },

            // Employment (18)
            'e7-4-change': { name: 'E-7-4 Skilled Worker Visa', desc: 'E-9/H-2 skilled transition', category: 'employment' },
            'e7-4r-change': { name: 'E-7-4R Regional Skilled Worker', desc: 'Depopulated area skilled worker', category: 'employment' },
            'e7-change': { name: 'E-7 Professional Visa Change', desc: 'Professional employment visa', category: 'employment' },
            'f2-7-change': { name: 'F-2-7 Points-based Residence', desc: 'Outstanding talent residence', category: 'employment' },
            'f2-r-change': { name: 'F-2-R Regional Residence Visa', desc: 'Depopulated area residence', category: 'employment' },
            'e7-st-change': { name: 'E-7-S/T Elite Professional', desc: 'High-tech/high-income talent', category: 'employment' },
            'e1-e6-change': { name: 'E-1~E-6 Professional Change', desc: 'Professor, researcher, specialist', category: 'employment' },
            'e7-extension': { name: 'E-7 Visa Extension', desc: 'Professional visa renewal', category: 'employment' },
            'e9-workplace-change': { name: 'E-9 Workplace Change', desc: 'E-9 employer change', category: 'employment' },
            'workplace-change-permit': { name: 'Workplace Change Permit', desc: 'Job transfer pre-approval', category: 'employment' },
            'outside-activity': { name: 'Additional Activity Permit', desc: 'Activities beyond visa scope', category: 'employment' },
            'h2-work-start': { name: 'H-2 Employment Start Report', desc: 'Working visit job notification', category: 'employment' },
            'workplace-change-report': { name: 'Workplace Change Report', desc: 'Job transfer post-notification', category: 'employment' },
            'employment-info-change': { name: 'Employment Info Update', desc: 'Workplace/salary change report', category: 'employment' },
            'dispatch-report': { name: 'Dispatch Work Report', desc: 'Subsidiary assignment report', category: 'employment' },
            'income-report': { name: 'Annual Income Report', desc: 'Job and income notification', category: 'employment' },
            'foreign-worker-change': { name: 'Foreign Worker Status Report', desc: 'Resignation/departure report', category: 'employment' },

            // Business & Investment (12)
            'd8-1-change': { name: 'D-8-1 Corporate Investment', desc: 'Corporate establishment visa', category: 'business' },
            'd8-2-change': { name: 'D-8-2 Venture Investment', desc: 'Venture company investment', category: 'business' },
            'd8-3-change': { name: 'D-8-3 Individual Investment', desc: 'Sole proprietor investment', category: 'business' },
            'd8-4-change': { name: 'D-8-4 Tech Startup Visa', desc: 'Student entrepreneur visa', category: 'business' },
            'd9-1-change': { name: 'D-9-1 Trade Business', desc: 'Trading business visa', category: 'business' },
            'd9-2-change': { name: 'D-9-2 Export Equipment', desc: 'Export facility management', category: 'business' },
            'd9-3-change': { name: 'D-9-3 Shipbuilding Supervisor', desc: 'Ship/equipment supervision', category: 'business' },
            'd9-4-change': { name: 'D-9-4 Commercial Business', desc: 'Individual commercial visa', category: 'business' },
            'd9-5-change': { name: 'D-9-5 Graduate Entrepreneur', desc: 'Former student business', category: 'business' },
            'business-extension': { name: 'D-8, D-9 Business Extension', desc: 'Investment visa renewal', category: 'business' },
            'fic-registration': { name: 'Foreign Investment Registration', desc: 'FIC certificate issuance', category: 'business' },
            'fi-report': { name: 'Foreign Investment Report', desc: 'Investment pre-notification', category: 'business' },

            // Ethnic Korean & Family (13)
            'h2-to-f4-change': { name: 'H-2→F-4 Overseas Korean', desc: 'Working visit to overseas Korean', category: 'family' },
            'f4-change': { name: 'F-4 Overseas Korean Visa', desc: 'Overseas Korean status', category: 'family' },
            'f4-registration': { name: 'F-4 Residence Registration', desc: 'F-4 residence card issuance', category: 'family' },
            'f4-extension': { name: 'F-4 Visa Extension', desc: 'F-4 residence renewal', category: 'family' },
            'h2-extension': { name: 'H-2 Visa Extension', desc: 'Working visit renewal', category: 'family' },
            'f6-change': { name: 'F-6 Marriage Immigration', desc: 'Spouse visa acquisition', category: 'family' },
            'f6-extension': { name: 'F-6 Visa Extension', desc: 'Marriage visa renewal', category: 'family' },
            'f3-change': { name: 'F-3 Dependent Family Visa', desc: 'Spouse/child accompanying', category: 'family' },
            'f1-change': { name: 'F-1 Family Visit Visa', desc: 'Relative long-term stay', category: 'family' },
            'visa-grant-child': { name: 'Child Birth Visa Grant', desc: 'Newborn child visa', category: 'family' },
            'visa-grant-f6-child': { name: 'F-6 Child Visa Grant', desc: 'Marriage immigrant child', category: 'family' },
            'family-invite': { name: 'Family Invitation Visa', desc: 'Overseas family invitation', category: 'family' },
            'housework-report': { name: 'Domestic Work Report', desc: 'Household help notification', category: 'family' },

            // Residence & Citizenship (11)
            'f5-change': { name: 'F-5 Permanent Residence', desc: 'Korea permanent residency', category: 'residence' },
            'f5-reissue': { name: 'F-5 Card Renewal (10yr)', desc: 'Permanent residence card', category: 'residence' },
            'f2-extension': { name: 'F-2 Residence Extension', desc: 'Residence visa renewal', category: 'residence' },
            'naturalization': { name: 'Naturalization Application', desc: 'Korean citizenship', category: 'residence' },
            'nationality-recovery': { name: 'Nationality Recovery', desc: 'Former Korean citizenship', category: 'residence' },
            'nationality-selection': { name: 'Nationality Selection', desc: 'Dual citizen selection', category: 'residence' },
            'nationality-renounce': { name: 'Nationality Renunciation', desc: 'Korean citizenship waiver', category: 'residence' },
            'nationality-loss': { name: 'Nationality Loss Report', desc: 'Foreign citizenship report', category: 'residence' },
            'nationality-retention': { name: 'Nationality Retention', desc: 'Citizenship retention intent', category: 'residence' },
            'nationality-acquisition': { name: 'Nationality Acquisition', desc: 'Recognition-based citizenship', category: 'residence' },
            'nationality-judgment': { name: 'Nationality Determination', desc: 'Nationality status inquiry', category: 'residence' },

            // General Registration & Certificates (13)
            'arc-registration': { name: 'Alien Registration', desc: 'Required within 90 days', category: 'registration' },
            'arc-reissue': { name: 'ARC Reissue', desc: 'Lost/damaged card replacement', category: 'registration' },
            'address-change': { name: 'Address Change Report', desc: 'Moving address update', category: 'registration' },
            'f4-address-change': { name: 'F-4 Address Change', desc: 'Overseas Korean address', category: 'registration' },
            'passport-change': { name: 'Passport/Info Change', desc: 'Passport/name update', category: 'registration' },
            'reentry-permit-multiple': { name: 'Multiple Re-entry Permit', desc: 'Multiple border crossings', category: 'registration' },
            'reentry-permit-single': { name: 'Single Re-entry Permit', desc: 'One-time border crossing', category: 'registration' },
            'cert-entry-exit': { name: 'Entry/Exit Certificate', desc: 'Travel history record', category: 'registration' },
            'cert-arc': { name: 'ARC Certificate', desc: 'Registration proof', category: 'registration' },
            'cert-residence': { name: 'Residence Certificate', desc: 'F-4 residence proof', category: 'registration' },
            'cert-realestate': { name: 'Real Estate Registration ID', desc: 'Property transaction', category: 'registration' },
            'cert-arc-number-change': { name: 'ARC Number Change Cert', desc: 'Number change confirmation', category: 'registration' },
            'cert-nationality': { name: 'Nationality Certificate', desc: 'Nationality status proof', category: 'registration' }
        };

        // 카테고리 이름
        const categoryNames = {
            'all': 'All Services',
            'premium': 'Premium',
            'education': 'Education & Job',
            'employment': 'Employment',
            'business': 'Business',
            'family': 'Family & Korean',
            'residence': 'Residence & Citizenship',
            'registration': 'Registration & Certs'
        };

        // ============================================================
        // 질문 흐름 정의
        // ============================================================
        const questions = {
            step1: {
                title: "What would you like to do?",
                subtitle: "Select your primary purpose",
                options: [
                    { id: "change_visa", title: "Change Visa Type", desc: "Switch to a different visa category" },
                    { id: "extend_visa", title: "Extend Current Visa", desc: "Renew before expiration" },
                    { id: "register_report", title: "Registration & Reports", desc: "ARC, address, workplace changes" },
                    { id: "get_certificate", title: "Get Certificates", desc: "Official documents & permits" },
                    { id: "residence_citizenship", title: "Residence & Citizenship", desc: "F-5, F-2, naturalization" },
                    { id: "need_consultation", title: "Need Consultation", desc: "Not sure what I need" }
                ]
            },
            step2: {
                change_visa: {
                    title: "What type of visa do you want?",
                    subtitle: "Select your target visa category",
                    options: [
                        { id: "visa_work", title: "Work Visa", desc: "E-7, E-1~E-6 employment" },
                        { id: "visa_skilled", title: "Skilled Worker (E-7-4)", desc: "E-9/H-2 transition" },
                        { id: "visa_business", title: "Business/Investment", desc: "D-8, D-9 investor visa" },
                        { id: "visa_student", title: "Student Visa", desc: "D-2, D-4 study visa" },
                        { id: "visa_jobseeker", title: "Job Seeker (D-10)", desc: "After graduation" },
                        { id: "visa_family", title: "Family/Marriage", desc: "F-1, F-3, F-6 family visa" },
                        { id: "visa_korean", title: "Overseas Korean (F-4)", desc: "Ethnic Korean status" },
                        { id: "visa_residence", title: "Residence (F-2)", desc: "Points-based residence" }
                    ]
                },
                extend_visa: {
                    title: "Which visa do you need to extend?",
                    subtitle: "Select your current visa type",
                    options: [
                        { id: "ext_student", title: "Student (D-2, D-4)", desc: "Student visa renewal" },
                        { id: "ext_jobseeker", title: "Job Seeker (D-10)", desc: "D-10 extension" },
                        { id: "ext_work", title: "Work Visa (E-7)", desc: "E-7 professional visa" },
                        { id: "ext_business", title: "Business (D-8, D-9)", desc: "Investment visa renewal" },
                        { id: "ext_family", title: "Family (F-1, F-3, F-6)", desc: "Family visa renewal" },
                        { id: "ext_korean", title: "Overseas Korean (F-4, H-2)", desc: "F-4 or H-2 renewal" },
                        { id: "ext_residence", title: "Residence (F-2)", desc: "F-2 extension" }
                    ]
                },
                register_report: {
                    title: "What do you need to register or report?",
                    subtitle: "Select the type of registration",
                    options: [
                        { id: "reg_arc", title: "Alien Registration", desc: "New ARC or reissue" },
                        { id: "reg_address", title: "Address Change", desc: "Moving notification" },
                        { id: "reg_passport", title: "Passport/Info Change", desc: "Update personal info" },
                        { id: "reg_workplace", title: "Workplace Changes", desc: "Job change reports" },
                        { id: "reg_employment", title: "Employment Reports", desc: "Income, dispatch, etc." },
                        { id: "reg_student", title: "Student Work/Intern", desc: "Part-time, internship" },
                        { id: "reg_family", title: "Family Reports", desc: "Housework, F-4 address" },
                        { id: "reg_investment", title: "Investment Reports", desc: "FIC, foreign investment" }
                    ]
                },
                get_certificate: {
                    title: "What certificate do you need?",
                    subtitle: "Select the document type",
                    options: [
                        { id: "cert_arc", title: "ARC Certificate", desc: "Registration proof" },
                        { id: "cert_travel", title: "Entry/Exit Records", desc: "Travel history" },
                        { id: "cert_reentry", title: "Re-entry Permit", desc: "Border crossing permit" },
                        { id: "cert_residence", title: "Residence Certificate", desc: "F-4 residence proof" },
                        { id: "cert_other", title: "Other Certificates", desc: "Real estate, nationality, etc." }
                    ]
                },
                residence_citizenship: {
                    title: "What are you applying for?",
                    subtitle: "Select your goal",
                    options: [
                        { id: "res_f5", title: "Permanent Residence (F-5)", desc: "Korea permanent residency" },
                        { id: "res_f2", title: "F-2 Residence Visa", desc: "Points-based or regional" },
                        { id: "res_naturalize", title: "Naturalization", desc: "Korean citizenship" },
                        { id: "res_nationality", title: "Nationality Services", desc: "Recovery, selection, etc." },
                        { id: "res_f5_renew", title: "F-5 Card Renewal", desc: "10-year card renewal" }
                    ]
                },
                need_consultation: {
                    title: "What is your situation?",
                    subtitle: "We'll help you find the right service",
                    options: [
                        { id: "consult_diagnosis", title: "Visa Pre-diagnosis", desc: "Expert consultation on options" },
                        { id: "consult_emergency", title: "Urgent/Legal Issue", desc: "Deportation, overstay, denial" },
                        { id: "consult_browse", title: "Browse All Services", desc: "See complete service list" }
                    ]
                }
            }
        };

        // ============================================================
        // 서비스 매핑 (각 선택에 해당하는 서비스 ID 배열)
        // ============================================================
        const serviceMapping = {
            // Step 2: Change Visa
            visa_work: ['e7-change', 'e1-e6-change', 'e7-st-change'],
            visa_skilled: ['e7-4-change', 'e7-4r-change'],
            visa_business: ['d8-1-change', 'd8-2-change', 'd8-3-change', 'd8-4-change', 'd9-1-change', 'd9-2-change', 'd9-3-change', 'd9-4-change', 'd9-5-change'],
            visa_student: ['d4-to-d2-change', 'd2-d4-extension'],
            visa_jobseeker: ['d10-1-change', 'd10-2-change', 'd10-3-change', 'd10-t-change'],
            visa_family: ['f6-change', 'f3-change', 'f1-change', 'family-invite', 'visa-grant-child', 'visa-grant-f6-child'],
            visa_korean: ['f4-change', 'h2-to-f4-change'],
            visa_residence: ['f2-7-change', 'f2-r-change'],

            // Step 2: Extend Visa
            ext_student: ['d2-d4-extension'],
            ext_jobseeker: ['d10-extension'],
            ext_work: ['e7-extension'],
            ext_business: ['business-extension'],
            ext_family: ['f6-extension', 'f1-change', 'f3-change'],
            ext_korean: ['f4-extension', 'h2-extension'],
            ext_residence: ['f2-extension'],

            // Step 2: Registration & Reports
            reg_arc: ['arc-registration', 'arc-reissue'],
            reg_address: ['address-change', 'f4-address-change'],
            reg_passport: ['passport-change'],
            reg_workplace: ['workplace-change-permit', 'workplace-change-report', 'e9-workplace-change', 'outside-activity'],
            reg_employment: ['employment-info-change', 'dispatch-report', 'income-report', 'foreign-worker-change', 'h2-work-start'],
            reg_student: ['parttime-permit', 'intern-report', 'parent-invite'],
            reg_family: ['housework-report', 'f4-address-change', 'f4-registration'],
            reg_investment: ['fic-registration', 'fi-report'],

            // Step 2: Certificates
            cert_arc: ['cert-arc', 'cert-arc-number-change'],
            cert_travel: ['cert-entry-exit'],
            cert_reentry: ['reentry-permit-multiple', 'reentry-permit-single'],
            cert_residence: ['cert-residence'],
            cert_other: ['cert-realestate', 'cert-nationality'],

            // Step 2: Residence & Citizenship
            res_f5: ['f5-change'],
            res_f2: ['f2-7-change', 'f2-r-change', 'f2-extension'],
            res_naturalize: ['naturalization'],
            res_nationality: ['nationality-recovery', 'nationality-selection', 'nationality-renounce', 'nationality-loss', 'nationality-retention', 'nationality-acquisition', 'nationality-judgment'],
            res_f5_renew: ['f5-reissue'],

            // Step 2: Consultation
            consult_diagnosis: ['visa-prediagnosis'],
            consult_emergency: ['emergency-legal', 'visa-prediagnosis'],
            consult_browse: Object.keys(allServices) // 전체 서비스
        };

        // ============================================================
        // 상태 관리
        // ============================================================
        let currentStep = 1;
        let selections = [];
        let history = [];

        // 초기화
        function init() {
            renderStep();
        }

        // 현재 단계 렌더링
        function renderStep() {
            const questionSection = document.getElementById('questionSection');
            const resultSection = document.getElementById('resultSection');

            questionSection.classList.remove('hidden');
            resultSection.style.display = 'none';

            let stepData;
            if (currentStep === 1) {
                stepData = questions.step1;
            } else if (currentStep === 2) {
                stepData = questions.step2[selections[0]];
            }

            if (!stepData) {
                showResults();
                return;
            }

            // 진행률 업데이트
            document.getElementById('progressText').textContent = `Step ${currentStep} of 3`;
            document.getElementById('progressFill').style.width = `${currentStep * 33}%`;

            // 질문 업데이트
            document.getElementById('questionTitle').textContent = stepData.title;
            document.getElementById('questionSubtitle').textContent = stepData.subtitle;

            // 옵션 렌더링
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = stepData.options.map(opt => `
                <button class="option-btn" onclick="selectOption('${opt.id}')">
                    <div class="option-title">${opt.title}</div>
                    ${opt.desc ? `<div class="option-desc">${opt.desc}</div>` : ''}
                </button>
            `).join('');

            // 뒤로가기 버튼
            document.getElementById('prevBtn').disabled = currentStep === 1;
        }

        // 옵션 선택
        function selectOption(optionId) {
            history.push({ step: currentStep, selections: [...selections] });
            selections[currentStep - 1] = optionId;
            currentStep++;

            if (currentStep > 2 || !questions.step2[selections[0]]) {
                showResults();
            } else {
                renderStep();
            }
        }

        // 결과 표시
        function showResults() {
            document.getElementById('questionSection').classList.add('hidden');
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';

            document.getElementById('progressText').textContent = 'Results';
            document.getElementById('progressFill').style.width = '100%';

            // 마지막 선택에 해당하는 서비스 가져오기
            const lastSelection = selections[selections.length - 1];
            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);

            // 카테고리 필터 생성
            const categories = new Set(['all']);
            serviceIds.forEach(id => {
                if (allServices[id]) {
                    categories.add(allServices[id].category);
                }
            });

            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = Array.from(categories).map(cat => `
                <button class="category-btn ${cat === 'all' ? 'active' : ''}" onclick="filterCategory('${cat}', '${lastSelection}')">
                    ${categoryNames[cat] || cat}
                </button>
            `).join('');

            renderServices(serviceIds, 'all');
        }

        // 서비스 렌더링
        function renderServices(serviceIds, category) {
            const servicesContainer = document.getElementById('servicesGrid');

            let filteredIds = serviceIds;
            if (category !== 'all') {
                filteredIds = serviceIds.filter(id => allServices[id] && allServices[id].category === category);
            }

            servicesContainer.innerHTML = filteredIds.map(id => {
                const svc = allServices[id];
                if (!svc) return '';

                return `
                    <div class="service-item" onclick="applyService('${id}')">
                        <div class="title">${svc.name}</div>
                        <div class="desc">${svc.desc}</div>
                    </div>
                `;
            }).join('');
        }

        // 카테고리 필터
        function filterCategory(category, lastSelection) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === (categoryNames[category] || category)) {
                    btn.classList.add('active');
                }
            });

            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);
            renderServices(serviceIds, category);
        }

        // 서비스 신청
        function applyService(code) {
            window.location.href = `service-apply-general.html?service=${code}`;
        }

        // 이전 단계
        function prevStep() {
            if (history.length > 0) {
                const prev = history.pop();
                currentStep = prev.step;
                selections = prev.selections;
                renderStep();
            }
        }

        // 뒤로가기
        function goBack() {
            if (currentStep > 1) {
                prevStep();
            } else {
                window.location.href = 'index.html';
            }
        }

        // 다시 시작
        function restart() {
            currentStep = 1;
            selections = [];
            history = [];
            renderStep();
        }

        // 초기화 실행
        init();
    </script>

    <!-- i18n 다국어 지원 -->
    <script src="js/translations.js?v=20250128"></script>
    <script src="js/i18n.js?v=20250128"></script>
</body>
</html>
