<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Navigator - Lawyeon Visa & Immigration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F5F6F8;
            min-height: 100vh;
            color: #191F28;
        }

        /* Header - matching index.html */
        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 100%);
            padding: 20px 25px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 3px solid #3182F6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px 40px;
        }

        /* Progress Bar */
        .progress-section {
            margin-bottom: 24px;
        }

        .progress-text {
            font-size: 14px;
            color: #8B95A1;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .progress-bar {
            height: 6px;
            background: #E5E8EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182F6, #1B64DA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Question Card - matching index.html style */
        .question-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid #E2E8F0;
        }

        .question-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
            line-height: 1.4;
            letter-spacing: -0.5px;
        }

        .question-subtitle {
            font-size: 15px;
            color: #8B95A1;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        /* Options Grid - matching service-grid style */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .option-btn {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }

        .option-btn:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .option-btn:active {
            transform: translateY(-2px);
        }

        .option-btn .option-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .option-btn .option-title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .option-btn .option-desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.4;
        }

        /* Navigation */
        .nav-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #F2F4F6;
        }

        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.secondary {
            background: #F2F4F6;
            border: none;
            color: #4E5968;
        }

        .nav-btn.secondary:hover {
            background: #E5E8EB;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Result Section */
        .result-section {
            display: none;
        }

        .result-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .result-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #3182F6 0%, #1B64DA 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
            color: white;
        }

        .result-title {
            font-size: 26px;
            font-weight: 800;
            color: #191F28;
            margin-bottom: 8px;
        }

        .result-subtitle {
            font-size: 15px;
            color: #8B95A1;
        }

        /* Services Grid - matching index.html service-grid */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .service-item {
            background: #F9FAFB;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 110px;
        }

        .service-item:hover {
            border-color: #3182F6;
            background: #EBF4FF;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.12);
        }

        .service-item .service-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .service-item .title {
            font-size: 16px;
            font-weight: 700;
            color: #191F28;
            line-height: 1.4;
        }

        .service-item .desc {
            font-size: 13px;
            color: #6B7684;
            line-height: 1.5;
        }

        .service-item .price {
            font-size: 14px;
            font-weight: 700;
            color: #3182F6;
            margin-top: auto;
        }

        .restart-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 32px;
            background: #F2F4F6;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: #E5E8EB;
        }

        /* Category Filter for Results */
        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 18px;
            border: 2px solid #E5E8EB;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #4E5968;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover {
            border-color: #3182F6;
            color: #3182F6;
        }

        .category-btn.active {
            background: #3182F6;
            border-color: #3182F6;
            color: white;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .options-grid,
            .services-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px 16px 32px;
            }

            .question-card {
                padding: 24px 20px;
                border-radius: 20px;
            }

            .question-title {
                font-size: 20px;
            }

            .options-grid,
            .services-grid {
                grid-template-columns: 1fr;
            }

            .option-btn,
            .service-item {
                min-height: auto;
                padding: 20px;
            }

            .option-btn .option-title,
            .service-item .title {
                font-size: 15px;
            }

            .nav-section {
                flex-direction: column-reverse;
                gap: 12px;
            }

            .nav-btn {
                width: 100%;
                text-align: center;
            }

            .category-filter {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 8px;
            }

            .category-btn {
                flex-shrink: 0;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="header-title">Service Navigator</h1>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Progress -->
        <div class="progress-section">
            <div class="progress-text" id="progressText">Step 1 of 3</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
        </div>

        <!-- Question Section -->
        <div class="question-card" id="questionSection">
            <h2 class="question-title" id="questionTitle">What is your current status?</h2>
            <p class="question-subtitle" id="questionSubtitle">Select the option that best describes your situation</p>

            <div class="options-grid" id="optionsGrid">
                <!-- Options will be populated by JavaScript -->
            </div>

            <div class="nav-section">
                <button class="nav-btn secondary" id="prevBtn" onclick="prevStep()" disabled>
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="nav-btn secondary" onclick="restart()">
                    Start Over
                </button>
            </div>
        </div>

        <!-- Result Section -->
        <div class="result-section" id="resultSection">
            <div class="question-card">
                <div class="result-header">
                    <div class="result-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="result-title">Recommended Services</h2>
                    <p class="result-subtitle">Based on your selections, here are the available services:</p>
                </div>

                <div class="category-filter" id="categoryFilter">
                    <!-- Category buttons will be populated -->
                </div>

                <div class="services-grid" id="servicesGrid">
                    <!-- Services will be populated by JavaScript -->
                </div>

                <button class="restart-btn" onclick="restart()">
                    <i class="fas fa-redo"></i> Start Over
                </button>
            </div>
        </div>
    </div>

    <script>
        // All available services from servicePricing (service-apply-general.html)
        const allServices = {
            // Premium Services
            'visa-prediagnosis': { name: 'Visa Pre-diagnosis', price: 55000, desc: 'Visa change, overstay risk, immigration consultation', icon: 'ðŸ”', category: 'premium' },
            'emergency-legal': { name: 'Immigration Dispute Resolution', price: 0, desc: 'Deportation defense, visa denial appeals', icon: 'âš–ï¸', category: 'premium', consulting: true },

            // Education & Job Search
            'd4-to-d2-change': { name: 'D-4â†’D-2 Student Visa Change', price: 110000, desc: 'Language course to degree program', icon: 'ðŸŽ“', category: 'education' },
            'd10-1-change': { name: 'D-10-1 Job Seeker Visa', price: 220000, desc: 'General job seeking visa', icon: 'ðŸ”', category: 'education' },
            'd10-2-change': { name: 'D-10-2 Tech Startup Job Seeker', price: 330000, desc: 'Startup preparation visa', icon: 'ðŸ’¡', category: 'education' },
            'd10-3-change': { name: 'D-10-3 High-tech Intern', price: 330000, desc: 'Advanced technology internship', icon: 'ðŸ”¬', category: 'education' },
            'd10-t-change': { name: 'D-10-T Top Talent Job Seeker', price: 330000, desc: 'Elite university graduate visa', icon: 'ðŸ†', category: 'education' },
            'd2-d4-extension': { name: 'D-2, D-4 Visa Extension', price: 110000, desc: 'Student visa renewal', icon: 'ðŸ“–', category: 'education' },
            'd10-extension': { name: 'D-10 Visa Extension', price: 110000, desc: 'Job seeker visa renewal', icon: 'â³', category: 'education' },
            'parttime-permit': { name: 'Part-time Work Permit', price: 33000, desc: 'D-2, D-4 part-time employment', icon: 'â°', category: 'education' },
            'intern-report': { name: 'Internship Start/Change Report', price: 110000, desc: 'D-10 internship notification', icon: 'ðŸ“', category: 'education' },
            'parent-invite': { name: 'Student Parent Invitation', price: 330000, desc: 'Excellent student parent visa', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', category: 'education' },

            // Employment
            'e7-4-change': { name: 'E-7-4 Skilled Worker Visa', price: 550000, desc: 'E-9/H-2 skilled transition', icon: 'ðŸ”§', category: 'employment' },
            'e7-4r-change': { name: 'E-7-4R Regional Skilled Worker', price: 550000, desc: 'Depopulated area skilled worker', icon: 'ðŸ˜ï¸', category: 'employment' },
            'e7-change': { name: 'E-7 Professional Visa', price: 550000, desc: 'Professional employment visa', icon: 'ðŸ’¼', category: 'employment' },
            'f2-7-change': { name: 'F-2-7 Points-based Residence', price: 550000, desc: 'Outstanding talent residence', icon: 'â­', category: 'employment' },
            'f2-r-change': { name: 'F-2-R Regional Residence', price: 550000, desc: 'Depopulated area residence', icon: 'ðŸ¡', category: 'employment' },
            'e7-st-change': { name: 'E-7-S/T Elite Professional', price: 550000, desc: 'High-tech/high-income talent', icon: 'ðŸ†', category: 'employment' },
            'e1-e6-change': { name: 'E-1~E-6 Professional Visa', price: 550000, desc: 'Professor, researcher, specialist', icon: 'ðŸŽ“', category: 'employment' },
            'e7-extension': { name: 'E-7 Visa Extension', price: 110000, desc: 'Professional visa renewal', icon: 'ðŸ“…', category: 'employment' },
            'e9-workplace-change': { name: 'E-9 Workplace Change', price: 220000, desc: 'E-9 employer change', icon: 'ðŸ­', category: 'employment' },
            'workplace-change-permit': { name: 'Workplace Change Permit', price: 220000, desc: 'Job transfer pre-approval', icon: 'ðŸ¢', category: 'employment' },
            'outside-activity': { name: 'Additional Activity Permit', price: 220000, desc: 'Activities beyond visa scope', icon: 'ðŸ”“', category: 'employment' },
            'h2-work-start': { name: 'H-2 Employment Start Report', price: 55000, desc: 'Working visit job notification', icon: 'ðŸ“‹', category: 'employment' },
            'workplace-change-report': { name: 'Workplace Change Report', price: 110000, desc: 'Job transfer notification', icon: 'ðŸ“', category: 'employment' },
            'employment-info-change': { name: 'Employment Info Update', price: 55000, desc: 'Workplace/salary change report', icon: 'ðŸ’°', category: 'employment' },
            'dispatch-report': { name: 'Dispatch Work Report', price: 110000, desc: 'Subsidiary assignment report', icon: 'ðŸ”„', category: 'employment' },
            'income-report': { name: 'Annual Income Report', price: 55000, desc: 'Job and income notification', icon: 'ðŸ’µ', category: 'employment' },
            'foreign-worker-change': { name: 'Foreign Worker Status Report', price: 55000, desc: 'Resignation/departure report', icon: 'ðŸ“Š', category: 'employment' },

            // Business & Investment
            'd8-1-change': { name: 'D-8-1 Corporate Investment', price: 1100000, desc: 'Corporate establishment visa', icon: 'ðŸ¢', category: 'business' },
            'd8-2-change': { name: 'D-8-2 Venture Investment', price: 1100000, desc: 'Venture company investment', icon: 'ðŸš€', category: 'business' },
            'd8-3-change': { name: 'D-8-3 Individual Investment', price: 1100000, desc: 'Sole proprietor investment', icon: 'ðŸ’¼', category: 'business' },
            'd8-4-change': { name: 'D-8-4 Tech Startup Visa', price: 550000, desc: 'Student entrepreneur visa', icon: 'ðŸ’¡', category: 'business' },
            'd9-1-change': { name: 'D-9-1 Trade Business', price: 1100000, desc: 'Trading business visa', icon: 'ðŸŒ', category: 'business' },
            'd9-2-change': { name: 'D-9-2 Export Equipment', price: 1100000, desc: 'Export facility management', icon: 'ðŸ­', category: 'business' },
            'd9-3-change': { name: 'D-9-3 Shipbuilding Supervisor', price: 1100000, desc: 'Ship/equipment supervision', icon: 'âš“', category: 'business' },
            'd9-4-change': { name: 'D-9-4 Commercial Business', price: 1100000, desc: 'Individual commercial visa', icon: 'ðŸ“Š', category: 'business' },
            'd9-5-change': { name: 'D-9-5 Graduate Entrepreneur', price: 550000, desc: 'Former student business', icon: 'ðŸŽ“', category: 'business' },
            'business-extension': { name: 'D-8, D-9 Business Extension', price: 220000, desc: 'Investment visa renewal', icon: 'ðŸ“…', category: 'business' },
            'fic-registration': { name: 'Foreign Investment Registration', price: 330000, desc: 'FIC certificate issuance', icon: 'ðŸ“‹', category: 'business' },
            'fi-report': { name: 'Foreign Investment Report', price: 220000, desc: 'Investment pre-notification', icon: 'ðŸ“', category: 'business' },

            // Ethnic Korean & Family
            'h2-to-f4-change': { name: 'H-2â†’F-4 Overseas Korean', price: 220000, desc: 'Working visit to overseas Korean', icon: 'ðŸ‡°ðŸ‡·', category: 'family' },
            'f4-change': { name: 'F-4 Overseas Korean Visa', price: 220000, desc: 'Overseas Korean status', icon: 'ðŸŽŒ', category: 'family' },
            'f4-registration': { name: 'F-4 Residence Registration', price: 110000, desc: 'F-4 residence card issuance', icon: 'ðŸ“', category: 'family' },
            'f4-extension': { name: 'F-4 Visa Extension', price: 110000, desc: 'F-4 residence renewal', icon: 'ðŸ“…', category: 'family' },
            'h2-extension': { name: 'H-2 Visa Extension', price: 110000, desc: 'Working visit renewal', icon: 'ðŸ›¬', category: 'family' },
            'f6-change': { name: 'F-6 Marriage Immigration', price: 1100000, desc: 'Spouse visa acquisition', icon: 'ðŸ’', category: 'family' },
            'f6-extension': { name: 'F-6 Visa Extension', price: 110000, desc: 'Marriage visa renewal', icon: 'ðŸ’’', category: 'family' },
            'f3-change': { name: 'F-3 Dependent Family Visa', price: 330000, desc: 'Spouse/child accompanying', icon: 'ðŸ‘ª', category: 'family' },
            'f1-change': { name: 'F-1 Family Visit Visa', price: 330000, desc: 'Relative long-term stay', icon: 'ðŸ ', category: 'family' },
            'visa-grant-child': { name: 'Child Birth Visa Grant', price: 220000, desc: 'Newborn child visa', icon: 'ðŸ‘¶', category: 'family' },
            'visa-grant-f6-child': { name: 'F-6 Child Visa Grant', price: 220000, desc: 'Marriage immigrant child', icon: 'ðŸ‘¶', category: 'family' },
            'family-invite': { name: 'Family Invitation Visa', price: 550000, desc: 'Overseas family invitation', icon: 'âœˆï¸', category: 'family' },
            'housework-report': { name: 'Domestic Work Report', price: 55000, desc: 'Household help notification', icon: 'ðŸ¡', category: 'family' },

            // Residence & Citizenship
            'f5-change': { name: 'F-5 Permanent Residence', price: 1100000, desc: 'Korea permanent residency', icon: 'ðŸ ', category: 'residence' },
            'f5-reissue': { name: 'F-5 Card Renewal (10yr)', price: 110000, desc: 'Permanent residence card', icon: 'ðŸ”„', category: 'residence' },
            'f2-extension': { name: 'F-2 Residence Extension', price: 110000, desc: 'Residence visa renewal', icon: 'ðŸ¡', category: 'residence' },
            'naturalization': { name: 'Naturalization Application', price: 1100000, desc: 'Korean citizenship', icon: 'ðŸ›ï¸', category: 'residence' },
            'nationality-recovery': { name: 'Nationality Recovery', price: 550000, desc: 'Former Korean citizenship', icon: 'ðŸ”™', category: 'residence' },
            'nationality-selection': { name: 'Nationality Selection', price: 110000, desc: 'Dual citizen selection', icon: 'ðŸŒ', category: 'residence' },
            'nationality-renounce': { name: 'Nationality Renunciation', price: 110000, desc: 'Korean citizenship waiver', icon: 'ðŸ“„', category: 'residence' },
            'nationality-loss': { name: 'Nationality Loss Report', price: 110000, desc: 'Foreign citizenship report', icon: 'ðŸ“‹', category: 'residence' },
            'nationality-retention': { name: 'Nationality Retention', price: 110000, desc: 'Citizenship retention intent', icon: 'âœï¸', category: 'residence' },
            'nationality-acquisition': { name: 'Nationality Acquisition', price: 110000, desc: 'Recognition-based citizenship', icon: 'ðŸ“œ', category: 'residence' },
            'nationality-judgment': { name: 'Nationality Determination', price: 110000, desc: 'Nationality status inquiry', icon: 'âš–ï¸', category: 'residence' },

            // General Registration & Certificates
            'arc-registration': { name: 'Alien Registration', price: 110000, desc: 'Required within 90 days', icon: 'ðŸ†”', category: 'registration' },
            'arc-reissue': { name: 'ARC Reissue', price: 110000, desc: 'Lost/damaged card replacement', icon: 'ðŸ”„', category: 'registration' },
            'address-change': { name: 'Address Change Report', price: 33000, desc: 'Moving address update', icon: 'ðŸ ', category: 'registration' },
            'f4-address-change': { name: 'F-4 Address Change', price: 33000, desc: 'Overseas Korean address', icon: 'ðŸ‡°ðŸ‡·', category: 'registration' },
            'passport-change': { name: 'Passport/Info Change', price: 33000, desc: 'Passport/name update', icon: 'ðŸ“', category: 'registration' },
            'reentry-permit-multiple': { name: 'Multiple Re-entry Permit', price: 55000, desc: 'Multiple border crossings', icon: 'ðŸ”', category: 'registration' },
            'reentry-permit-single': { name: 'Single Re-entry Permit', price: 55000, desc: 'One-time border crossing', icon: 'ðŸ”™', category: 'registration' },
            'cert-entry-exit': { name: 'Entry/Exit Certificate', price: 22000, desc: 'Travel history record', icon: 'ðŸ“‹', category: 'registration' },
            'cert-arc': { name: 'ARC Certificate', price: 22000, desc: 'Registration proof', icon: 'ðŸ“„', category: 'registration' },
            'cert-residence': { name: 'Residence Certificate', price: 22000, desc: 'F-4 residence proof', icon: 'ðŸ ', category: 'registration' },
            'cert-realestate': { name: 'Real Estate Registration ID', price: 22000, desc: 'Property transaction', icon: 'ðŸ˜ï¸', category: 'registration' },
            'cert-arc-number-change': { name: 'ARC Number Change Cert', price: 22000, desc: 'Number change confirmation', icon: 'ðŸ“‹', category: 'registration' },
            'cert-nationality': { name: 'Nationality Certificate', price: 22000, desc: 'Nationality status proof', icon: 'ðŸ“œ', category: 'registration' }
        };

        // Category names for filter
        const categoryNames = {
            'all': 'All Services',
            'premium': 'Premium',
            'education': 'Education & Job',
            'employment': 'Employment',
            'business': 'Business',
            'family': 'Family & Korean',
            'residence': 'Residence & Citizenship',
            'registration': 'Registration & Certs'
        };

        // Decision Tree - 3 steps to narrow down services
        const decisionTree = {
            step1: {
                question: "What is your current status?",
                subtitle: "Select the option that best describes your situation",
                options: [
                    { id: "valid_visa", title: "In Korea with Valid Visa", desc: "Currently staying legally", icon: "âœ…" },
                    { id: "student", title: "Student in Korea", desc: "D-2, D-4 student visa holder", icon: "ðŸŽ“" },
                    { id: "worker", title: "Worker in Korea", desc: "E-7, E-9, H-2 work visa", icon: "ðŸ’¼" },
                    { id: "family_visa", title: "Family/Marriage Visa", desc: "F-1, F-3, F-6 visa holder", icon: "ðŸ‘ª" },
                    { id: "korean_ethnic", title: "Ethnic Korean Abroad", desc: "F-4, H-2 or applying", icon: "ðŸ‡°ðŸ‡·" },
                    { id: "business_owner", title: "Business/Investor", desc: "D-8, D-9 or planning", icon: "ðŸ¢" },
                    { id: "permanent_citizen", title: "Permanent Resident/Citizen", desc: "F-5, F-2 or citizenship", icon: "ðŸ " },
                    { id: "need_help", title: "Need Guidance", desc: "Not sure what I need", icon: "â“" }
                ]
            },
            step2: {
                valid_visa: {
                    question: "What do you need help with?",
                    subtitle: "Select your primary purpose",
                    options: [
                        { id: "extend_visa", title: "Extend My Visa", desc: "Stay longer in Korea", icon: "â³" },
                        { id: "change_visa", title: "Change Visa Type", desc: "Switch to different visa", icon: "ðŸ”„" },
                        { id: "report_changes", title: "Report Changes", desc: "Address, passport, etc.", icon: "ðŸ“" },
                        { id: "get_documents", title: "Get Documents", desc: "Certificates & permits", icon: "ðŸ“„" },
                        { id: "upgrade_status", title: "Upgrade Status", desc: "F-2, F-5, citizenship", icon: "â¬†ï¸" }
                    ]
                },
                student: {
                    question: "What do you need?",
                    subtitle: "Select your student service",
                    options: [
                        { id: "student_extend", title: "Extend Student Visa", desc: "D-2, D-4 renewal", icon: "ðŸ“–" },
                        { id: "student_change", title: "Change Visa Type", desc: "D-4â†’D-2, or work visa", icon: "ðŸ”„" },
                        { id: "student_work", title: "Part-time/Internship", desc: "Work permits & reports", icon: "â°" },
                        { id: "student_graduate", title: "After Graduation", desc: "D-10 job seeker visa", icon: "ðŸŽ“" },
                        { id: "student_family", title: "Invite Family", desc: "Parent invitation", icon: "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§" }
                    ]
                },
                worker: {
                    question: "What do you need?",
                    subtitle: "Select your employment service",
                    options: [
                        { id: "work_extend", title: "Extend Work Visa", desc: "E-7 visa renewal", icon: "ðŸ“…" },
                        { id: "work_change_job", title: "Change Workplace", desc: "New employer", icon: "ðŸ¢" },
                        { id: "work_upgrade", title: "Upgrade to E-7-4", desc: "Skilled worker visa", icon: "ðŸ”§" },
                        { id: "work_residence", title: "Get Residence Visa", desc: "F-2-7 points-based", icon: "â­" },
                        { id: "work_reports", title: "Employment Reports", desc: "Various notifications", icon: "ðŸ“" }
                    ]
                },
                family_visa: {
                    question: "What do you need?",
                    subtitle: "Select your family service",
                    options: [
                        { id: "family_extend", title: "Extend Family Visa", desc: "F-1, F-3, F-6 renewal", icon: "ðŸ“…" },
                        { id: "family_marriage", title: "Marriage Visa (F-6)", desc: "Spouse of Korean", icon: "ðŸ’" },
                        { id: "family_children", title: "Children's Visa", desc: "Child birth visa", icon: "ðŸ‘¶" },
                        { id: "family_invite", title: "Invite Family", desc: "From overseas", icon: "âœˆï¸" },
                        { id: "family_permanent", title: "Permanent Residence", desc: "F-5 application", icon: "ðŸ " }
                    ]
                },
                korean_ethnic: {
                    question: "What do you need?",
                    subtitle: "Select your service",
                    options: [
                        { id: "ethnic_f4", title: "F-4 Overseas Korean", desc: "Get or extend F-4", icon: "ðŸŽŒ" },
                        { id: "ethnic_h2", title: "H-2 Working Visit", desc: "Extend H-2 visa", icon: "ðŸ›¬" },
                        { id: "ethnic_upgrade", title: "H-2 â†’ F-4 Change", desc: "Upgrade to F-4", icon: "â¬†ï¸" },
                        { id: "ethnic_register", title: "Registration/Docs", desc: "F-4 registration", icon: "ðŸ“" }
                    ]
                },
                business_owner: {
                    question: "What type of business?",
                    subtitle: "Select your business service",
                    options: [
                        { id: "biz_startup", title: "Start a Business", desc: "D-8 corporate visa", icon: "ðŸš€" },
                        { id: "biz_trade", title: "Trade/Commerce", desc: "D-9 trade visa", icon: "ðŸŒ" },
                        { id: "biz_extend", title: "Extend Business Visa", desc: "D-8, D-9 renewal", icon: "ðŸ“…" },
                        { id: "biz_invest_report", title: "Investment Reports", desc: "FIC, notifications", icon: "ðŸ“‹" }
                    ]
                },
                permanent_citizen: {
                    question: "What do you need?",
                    subtitle: "Select your service",
                    options: [
                        { id: "perm_f2_extend", title: "Extend F-2 Visa", desc: "F-2 renewal", icon: "ðŸ¡" },
                        { id: "perm_f5_apply", title: "Apply for F-5", desc: "Permanent residence", icon: "ðŸ " },
                        { id: "perm_f5_renew", title: "Renew F-5 Card", desc: "10-year renewal", icon: "ðŸ”„" },
                        { id: "perm_naturalize", title: "Naturalization", desc: "Korean citizenship", icon: "ðŸ›ï¸" },
                        { id: "perm_nationality", title: "Nationality Services", desc: "Recovery, selection, etc.", icon: "ðŸŒ" }
                    ]
                },
                need_help: {
                    question: "What is your situation?",
                    subtitle: "Let us help you find the right service",
                    options: [
                        { id: "help_diagnosis", title: "Visa Pre-diagnosis", desc: "Expert consultation", icon: "ðŸ”" },
                        { id: "help_emergency", title: "Urgent/Legal Issue", desc: "Deportation, overstay", icon: "âš–ï¸" },
                        { id: "help_documents", title: "Need Documents", desc: "Certificates & proofs", icon: "ðŸ“„" },
                        { id: "help_all", title: "Browse All Services", desc: "See complete list", icon: "ðŸ“‹" }
                    ]
                }
            }
        };

        // Service mappings for each final selection
        const serviceMapping = {
            // Valid visa paths
            extend_visa: ['d2-d4-extension', 'd10-extension', 'e7-extension', 'f2-extension', 'f4-extension', 'f6-extension', 'h2-extension', 'business-extension'],
            change_visa: ['e7-change', 'e7-4-change', 'f2-7-change', 'f6-change', 'f4-change', 'd8-1-change', 'd9-1-change'],
            report_changes: ['address-change', 'f4-address-change', 'passport-change', 'workplace-change-report', 'employment-info-change'],
            get_documents: ['arc-registration', 'arc-reissue', 'reentry-permit-multiple', 'reentry-permit-single', 'cert-entry-exit', 'cert-arc', 'cert-residence', 'cert-realestate', 'cert-arc-number-change', 'cert-nationality'],
            upgrade_status: ['f2-7-change', 'f5-change', 'naturalization'],

            // Student paths
            student_extend: ['d2-d4-extension'],
            student_change: ['d4-to-d2-change', 'e7-change', 'd10-1-change'],
            student_work: ['parttime-permit', 'intern-report'],
            student_graduate: ['d10-1-change', 'd10-2-change', 'd10-3-change', 'd10-t-change', 'd10-extension'],
            student_family: ['parent-invite'],

            // Worker paths
            work_extend: ['e7-extension'],
            work_change_job: ['workplace-change-permit', 'workplace-change-report', 'e9-workplace-change'],
            work_upgrade: ['e7-4-change', 'e7-4r-change', 'e7-st-change'],
            work_residence: ['f2-7-change', 'f2-r-change', 'f5-change'],
            work_reports: ['employment-info-change', 'dispatch-report', 'income-report', 'foreign-worker-change', 'h2-work-start', 'outside-activity'],

            // Family paths
            family_extend: ['f1-change', 'f3-change', 'f6-extension'],
            family_marriage: ['f6-change'],
            family_children: ['visa-grant-child', 'visa-grant-f6-child'],
            family_invite: ['family-invite'],
            family_permanent: ['f5-change', 'naturalization'],

            // Ethnic Korean paths
            ethnic_f4: ['f4-change', 'f4-extension'],
            ethnic_h2: ['h2-extension'],
            ethnic_upgrade: ['h2-to-f4-change'],
            ethnic_register: ['f4-registration', 'f4-address-change'],

            // Business paths
            biz_startup: ['d8-1-change', 'd8-2-change', 'd8-3-change', 'd8-4-change'],
            biz_trade: ['d9-1-change', 'd9-2-change', 'd9-3-change', 'd9-4-change', 'd9-5-change'],
            biz_extend: ['business-extension'],
            biz_invest_report: ['fic-registration', 'fi-report'],

            // Permanent/Citizen paths
            perm_f2_extend: ['f2-extension'],
            perm_f5_apply: ['f5-change'],
            perm_f5_renew: ['f5-reissue'],
            perm_naturalize: ['naturalization'],
            perm_nationality: ['nationality-recovery', 'nationality-selection', 'nationality-renounce', 'nationality-loss', 'nationality-retention', 'nationality-acquisition', 'nationality-judgment'],

            // Help paths
            help_diagnosis: ['visa-prediagnosis'],
            help_emergency: ['emergency-legal', 'visa-prediagnosis'],
            help_documents: ['cert-entry-exit', 'cert-arc', 'cert-residence', 'cert-realestate', 'cert-nationality', 'arc-registration', 'arc-reissue'],
            help_all: Object.keys(allServices) // All services
        };

        // State
        let currentStep = 1;
        let selections = [];
        let history = [];
        let currentCategory = 'all';

        // Initialize
        function init() {
            renderStep();
        }

        // Render current step
        function renderStep() {
            const questionSection = document.getElementById('questionSection');
            const resultSection = document.getElementById('resultSection');

            questionSection.classList.remove('hidden');
            resultSection.style.display = 'none';

            let stepData;

            if (currentStep === 1) {
                stepData = decisionTree.step1;
            } else if (currentStep === 2) {
                const prevSelection = selections[0];
                stepData = decisionTree.step2[prevSelection];
            }

            if (!stepData) {
                showResults();
                return;
            }

            // Update progress
            document.getElementById('progressText').textContent = `Step ${currentStep} of 3`;
            document.getElementById('progressFill').style.width = `${currentStep * 33}%`;

            // Update question
            document.getElementById('questionTitle').textContent = stepData.question;
            document.getElementById('questionSubtitle').textContent = stepData.subtitle;

            // Render options
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = stepData.options.map(opt => `
                <button class="option-btn" onclick="selectOption('${opt.id}')">
                    <div class="option-icon">${opt.icon || ''}</div>
                    <div class="option-title">${opt.title}</div>
                    ${opt.desc ? `<div class="option-desc">${opt.desc}</div>` : ''}
                </button>
            `).join('');

            // Update back button
            document.getElementById('prevBtn').disabled = currentStep === 1;
        }

        // Select option
        function selectOption(optionId) {
            history.push({ step: currentStep, selections: [...selections] });
            selections[currentStep - 1] = optionId;
            currentStep++;

            if (currentStep > 2 || !getNextStepData()) {
                showResults();
            } else {
                renderStep();
            }
        }

        // Get next step data
        function getNextStepData() {
            if (currentStep === 2) {
                return decisionTree.step2[selections[0]];
            }
            return null;
        }

        // Show results
        function showResults() {
            document.getElementById('questionSection').classList.add('hidden');
            const resultSection = document.getElementById('resultSection');
            resultSection.style.display = 'block';

            // Update progress
            document.getElementById('progressText').textContent = 'Results';
            document.getElementById('progressFill').style.width = '100%';

            // Get service IDs based on last selection
            const lastSelection = selections[selections.length - 1];
            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);

            // Build category filter
            const categories = new Set(['all']);
            serviceIds.forEach(id => {
                if (allServices[id]) {
                    categories.add(allServices[id].category);
                }
            });

            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = Array.from(categories).map(cat => `
                <button class="category-btn ${cat === 'all' ? 'active' : ''}" onclick="filterCategory('${cat}', '${lastSelection}')">
                    ${categoryNames[cat] || cat}
                </button>
            `).join('');

            // Render services
            renderServices(serviceIds, 'all');
        }

        // Render services with filter
        function renderServices(serviceIds, category) {
            currentCategory = category;
            const servicesContainer = document.getElementById('servicesGrid');

            let filteredIds = serviceIds;
            if (category !== 'all') {
                filteredIds = serviceIds.filter(id => allServices[id] && allServices[id].category === category);
            }

            servicesContainer.innerHTML = filteredIds.map(id => {
                const svc = allServices[id];
                if (!svc) return '';

                return `
                    <div class="service-item" onclick="applyService('${id}')">
                        <div class="service-icon">${svc.icon}</div>
                        <div class="title">${svc.name}</div>
                        <div class="desc">${svc.desc}</div>
                    </div>
                `;
            }).join('');
        }

        // Filter by category
        function filterCategory(category, lastSelection) {
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === (categoryNames[category] || category)) {
                    btn.classList.add('active');
                }
            });

            const serviceIds = serviceMapping[lastSelection] || Object.keys(allServices);
            renderServices(serviceIds, category);
        }

        // Apply for service
        function applyService(code) {
            window.location.href = `service-apply-general.html?service=${code}`;
        }

        // Previous step
        function prevStep() {
            if (history.length > 0) {
                const prev = history.pop();
                currentStep = prev.step;
                selections = prev.selections;
                renderStep();
            }
        }

        // Go back (header button)
        function goBack() {
            if (currentStep > 1) {
                prevStep();
            } else {
                window.location.href = 'index.html';
            }
        }

        // Restart
        function restart() {
            currentStep = 1;
            selections = [];
            history = [];
            currentCategory = 'all';
            renderStep();
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
