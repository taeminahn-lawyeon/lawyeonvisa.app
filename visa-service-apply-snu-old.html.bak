<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서비스 신청 - 법무법인 로연 x 서울대학교</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/ui-components.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            /* 전남대학교 메인 컬러: Pantone 356C (녹색) */
            background: linear-gradient(135deg, #1D2088 0%, #151A66 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: white;
            color: #1D2088;
        }

        .apply-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .apply-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .apply-header h1 {
            font-size: 26px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .apply-header p {
            color: #6b7280;
            font-size: 15px;
        }

        .service-summary {
            background: #e8f4f0;
            border: 2px solid #007A33;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .service-summary h3 {
            font-size: 18px;
            color: #1D2088;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .summary-label {
            font-size: 12px;
            color: #6b7280;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-group label .required {
            color: #ef4444;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1D2088;
            box-shadow: 0 0 0 3px rgba(0, 122, 51, 0.1);
        }

        .form-group input:disabled {
            background: #f9fafb;
            color: #6b7280;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .file-upload {
            border: 2px dashed #e5e7eb;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #1D2088;
            background: #f9fafb;
        }

        .file-upload i {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 15px;
        }

        .file-upload p {
            color: #6b7280;
            font-size: 14px;
        }

        .price-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .price-section h3 {
            font-size: 18px;
            color: #78350f;
            margin-bottom: 15px;
        }

        .price-breakdown {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            color: #374151;
        }

        .price-row.total {
            padding-top: 15px;
            border-top: 2px solid #fbbf24;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
        }

        .btn-submit {
            background: linear-gradient(135deg, #1D2088 0%, #151A66 100%);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 122, 51, 0.4);
        }

        @media (max-width: 768px) {
            .apply-container {
                padding: 30px 20px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column-reverse;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="history.back()">
            <i class="fas fa-arrow-left"></i> 돌아가기
        </button>

        <div class="apply-container">
            <div class="apply-header">
                <h1>서비스 신청</h1>
                <p>법무법인 로연 출입국이민지원센터</p>
            </div>

            <div class="service-summary">
                <h3><i class="fas fa-file-alt"></i> 신청 서비스</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">서비스명</div>
                        <div class="summary-value" id="serviceName">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">신청자</div>
                        <div class="summary-value" id="applicantName">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">소속</div>
                        <div class="summary-value">전남대학교</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">현재 체류자격</div>
                        <div class="summary-value" id="currentVisa">-</div>
                    </div>
                </div>
            </div>

            <form id="applyForm">
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> 신청 정보</h3>
                    
                    <div class="form-group">
                        <label>연락처 <span class="required">*</span></label>
                        <input type="tel" id="phone" placeholder="010-1234-5678" required>
                        <div class="help-text">진행 상황을 안내받을 연락처를 입력하세요</div>
                    </div>

                    <div class="form-group">
                        <label>이메일</label>
                        <input type="email" id="email" disabled>
                    </div>

                    <div class="form-group">
                        <label>추가 요청사항</label>
                        <textarea id="additionalRequest" placeholder="서비스 신청과 관련하여 추가로 전달하실 내용이 있으시면 작성해주세요"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-paperclip"></i> 서류 첨부</h3>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>클릭하여 파일 업로드</strong></p>
                        <p style="font-size: 12px; margin-top: 5px;">여권 사본, 외국인등록증 등 필요 서류를 첨부하세요</p>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileUpload(event)">
                    <div id="fileList" style="margin-top: 15px;"></div>
                </div>

                <div class="price-section">
                    <h3><i class="fas fa-tag"></i> 서비스 금액</h3>
                    <div class="price-breakdown">
                        <div class="price-row">
                            <span>대행료</span>
                            <span id="serviceFee">-</span>
                        </div>
                        <div class="price-row">
                            <span>정부수수료</span>
                            <span id="govFee">-</span>
                        </div>
                        <div class="price-row total">
                            <span>총 결제금액</span>
                            <span id="totalAmount">-</span>
                        </div>
                    </div>
                    <div class="help-text" style="text-align: center;">
                        결제는 서비스 신청 후 센터 담당자와 상담을 통해 진행됩니다
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-cancel" onclick="history.back()">
                        취소
                    </button>
                    <button type="submit" class="btn btn-submit">
                        <i class="fas fa-paper-plane"></i> 신청하기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/ui-components.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const serviceId = urlParams.get('service');
        let uploadedFiles = [];

        // 서비스 데이터 (Compact ver. - 대학 단체 접수 기준)
        const serviceData = {
            // 생활 신고 & 발급
            'address-change': { name: '체류지(주소) 변경 신고', serviceFee: 44000, govFee: 0 },
            'passport-change': { name: '여권 정보 변경 신고', serviceFee: 22000, govFee: 0 },
            'cert-issue': { name: '사실증명 발급 대행', serviceFee: 22000, govFee: 1000 },
            'arc-reissue': { name: '등록증 재발급 신청', serviceFee: 55000, govFee: 30000 },
            // 비자 연장 & 시간제 취업
            'stay-extension-normal': { name: '체류기간 연장 (일반)', serviceFee: 140000, govFee: 60000 },
            'stay-extension-poor': { name: '체류기간 연장 (성적미달)', serviceFee: 220000, govFee: 60000 },
            'part-time-normal': { name: '시간제취업 허가 (알바)', serviceFee: 55000, govFee: 0 },
            'part-time-manufacture': { name: '제조업 예외 허가', serviceFee: 110000, govFee: 0 },
            // 체류 자격 변경
            'change-d2': { name: '진학/편입 변경 (D-2)', serviceFee: 280000, govFee: 100000 },
            'change-d10': { name: '구직 비자 변경 (D-10)', serviceFee: 220000, govFee: 100000 },
            'change-e7': { name: '취업 비자 변경 (E-7)', serviceFee: 1650000, govFee: 200000 },
            'change-family': { name: '가족 초청 비자 (F-1/F-3)', serviceFee: 330000, govFee: 100000 },
            // 위기 관리 & 구제
            'investigation-support': { name: '출입국 사범심사 동행', serviceFee: null, govFee: 0, consultRequired: true },
            'deportation-lawsuit': { name: '출국명령 취소소송', serviceFee: null, govFee: 0, consultRequired: true },
            'visa-rejection-lawsuit': { name: '체류자격 연장·변경 불허처분 취소소송', serviceFee: null, govFee: 0, consultRequired: true },
            'fine-lawsuit': { name: '범칙금부과처분 취소소송', serviceFee: null, govFee: 0, consultRequired: true }
        };

        window.addEventListener('DOMContentLoaded', function() {
            const studentProfile = JSON.parse(localStorage.getItem('studentProfile'));
            if (!studentProfile) {
                window.location.href = 'visa-login-snu.html';
                return;
            }

            // 동의 확인
            const lastConsent = JSON.parse(localStorage.getItem('lastConsent'));
            if (!lastConsent || lastConsent.service_id !== serviceId) {
                showToast('정보제공 동의가 필요합니다.', 'warning', 2000);
                setTimeout(() => {
                    history.back();
                }, 2000);
                return;
            }

            // 서비스 정보 로드
            const service = serviceData[serviceId];
            if (!service) {
                showToast('서비스 정보를 찾을 수 없습니다.', 'error');
                return;
            }

            document.getElementById('serviceName').textContent = service.name;
            document.getElementById('applicantName').textContent = studentProfile.full_name;
            document.getElementById('currentVisa').textContent = studentProfile.current_visa;
            document.getElementById('email').value = studentProfile.email;

            // 상담 필요 서비스 처리
            if (service.consultRequired) {
                document.getElementById('serviceFee').textContent = '상담 신청';
                document.getElementById('govFee').parentElement.style.display = 'none';
                document.getElementById('totalAmount').textContent = '상담 후 안내';
            } else {
                const total = service.serviceFee + service.govFee;
                document.getElementById('serviceFee').textContent = service.serviceFee.toLocaleString() + '원 (VAT포함)';
                
                // 정부수수료가 0원이면 해당 항목 숨기기
                const govFeeRow = document.getElementById('govFee').parentElement;
                if (service.govFee === 0) {
                    govFeeRow.style.display = 'none';
                    document.getElementById('totalAmount').textContent = service.serviceFee.toLocaleString() + '원 (VAT포함)';
                } else {
                    govFeeRow.style.display = 'flex';
                    document.getElementById('govFee').textContent = service.govFee.toLocaleString() + '원';
                    document.getElementById('totalAmount').textContent = total.toLocaleString() + '원 (VAT포함)';
                }
            }
        });

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            uploadedFiles = uploadedFiles.concat(files);

            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'background: #f3f4f6; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';
                fileItem.innerHTML = `
                    <span style="font-size: 13px;"><i class="fas fa-file"></i> ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button onclick="removeFile(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">삭제</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            document.getElementById('fileInput').value = '';
            
            const dataTransfer = new DataTransfer();
            uploadedFiles.forEach(file => dataTransfer.items.add(file));
            document.getElementById('fileInput').files = dataTransfer.files;

            handleFileUpload({ target: { files: uploadedFiles } });
        }

        document.getElementById('applyForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const phone = document.getElementById('phone').value;
            if (!phone) {
                showToast('연락처를 입력해주세요.', 'warning');
                return;
            }

            const loadingBtn = new LoadingButton(event.target.querySelector('.btn-submit'));
            loadingBtn.setLoading('신청 중...');

            const studentProfile = JSON.parse(localStorage.getItem('studentProfile'));
            const service = serviceData[serviceId];
            const total = service.serviceFee + service.govFee;

            const applicationData = {
                id: 'APP_' + Date.now(),
                student_id: studentProfile.id,
                service_id: serviceId,
                service_name: service.name,
                application_type: '출입국민원',
                amount: total,
                status: 'processing',
                thread_id: 'THREAD_' + Date.now(),
                application_date: new Date().toLocaleDateString('ko-KR'),
                phone: phone,
                additional_request: document.getElementById('additionalRequest').value,
                files: uploadedFiles.map(f => f.name)
            };

            setTimeout(() => {
                const applications = JSON.parse(localStorage.getItem('applications') || '[]');
                applications.push(applicationData);
                localStorage.setItem('applications', JSON.stringify(applications));

                loadingBtn.setSuccess('완료!');
                showToast('신청이 완료되었습니다!', 'success', 2000);

                setTimeout(() => {
                    window.location.href = `visa-thread-jnu.html?id=${applicationData.thread_id}`;
                }, 2000);
            }, 1500);
        });

        // 전화번호 자동 포맷팅
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 3 && value.length <= 7) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
                value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
            e.target.value = value;
        });
    </script>
</body>
</html>
