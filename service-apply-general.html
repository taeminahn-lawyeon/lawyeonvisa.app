<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png?v=3">
    <title>Apply for Service - Lawyeon Visa Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- Toss Payments SDK v2 -->
    <script src="https://js.tosspayments.com/v2/standard"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F8FAFC;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 100%);
            padding: 20px 0;
            border-bottom: 3px solid #3182F6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .btn-back {
            color: white;
            text-decoration: none;
            font-size: 15px;
            font-weight: 600;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back:hover {
            opacity: 1;
        }

        /* Main Container - 2 Column Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            align-items: start;
        }

        /* Left Column - Service Info & Steps */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Service Header */
        .service-header {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .service-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #EBF4FF;
            color: #3182F6;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .service-header h1 {
            font-size: 28px;
            font-weight: 800;
            color: #1E293B;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            line-height: 1.3;
        }

        .service-header p {
            font-size: 16px;
            color: #64748B;
            font-weight: 500;
            line-height: 1.5;
        }

        /* Price Card */
        .price-card {
            background: white;
            border-radius: 20px;
            padding: 28px 32px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .price-card h2 {
            font-size: 16px;
            font-weight: 700;
            color: #64748B;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #F1F5F9;
        }

        .price-row:last-of-type {
            border-bottom: none;
        }

        .price-label {
            font-size: 15px;
            color: #475569;
            font-weight: 500;
        }

        .price-value {
            font-size: 16px;
            color: #1E293B;
            font-weight: 700;
        }

        .price-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            margin-top: 8px;
            border-top: 2px solid #E2E8F0;
        }

        .price-total .label {
            font-size: 17px;
            color: #1E293B;
            font-weight: 800;
        }

        .price-total .value {
            font-size: 32px;
            color: #3182F6;
            font-weight: 900;
            letter-spacing: -1px;
        }

        /* Government Fee Notice */
        .govt-notice {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            background: #FEF9C3;
            border: 1px solid #FDE047;
            border-radius: 12px;
            padding: 14px 16px;
            margin-top: 16px;
        }

        .govt-notice i {
            color: #CA8A04;
            font-size: 16px;
            margin-top: 2px;
        }

        .govt-notice-text {
            font-size: 13px;
            color: #854D0E;
            font-weight: 600;
            line-height: 1.5;
        }

        /* Process Steps */
        .process-steps {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .process-steps h2 {
            font-size: 20px;
            font-weight: 800;
            color: #1E293B;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .process-steps h2 i {
            color: #3182F6;
        }

        .step-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid #F1F5F9;
        }

        .step-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h3 {
            font-size: 15px;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 4px;
        }

        .step-content p {
            font-size: 14px;
            color: #64748B;
            font-weight: 500;
            line-height: 1.4;
        }

        /* CTA Button */
        .cta-section {
            margin-top: 8px;
        }

        .btn-primary {
            width: 100%;
            height: 56px;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 16px rgba(49, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(49, 130, 246, 0.4);
        }

        .btn-primary:disabled {
            background: #CBD5E1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary.loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Right Column - Thread Preview */
        .right-column {
            position: sticky;
            top: 100px;
        }

        .thread-preview {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            border: 1px solid #E2E8F0;
        }

        .thread-preview-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #F1F5F9;
        }

        .thread-preview-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .thread-preview-title {
            flex: 1;
        }

        .thread-preview-title h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 2px;
        }

        .thread-preview-title p {
            font-size: 13px;
            color: #64748B;
            font-weight: 500;
        }

        .thread-preview-image {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
        }

        .thread-preview-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Thread mockup placeholder */
        .thread-mockup {
            background: linear-gradient(180deg, #F8FAFC 0%, #EFF6FF 100%);
            padding: 20px;
            min-height: 400px;
        }

        .mockup-message {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .mockup-message.admin {
            background: #EBF4FF;
            border-left: 3px solid #3182F6;
        }

        .mockup-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .mockup-avatar {
            width: 28px;
            height: 28px;
            background: #3182F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        .mockup-avatar.user {
            background: #10B981;
        }

        .mockup-name {
            font-size: 13px;
            font-weight: 600;
            color: #1E293B;
        }

        .mockup-time {
            font-size: 11px;
            color: #94A3B8;
            margin-left: auto;
        }

        .mockup-text {
            font-size: 14px;
            color: #475569;
            line-height: 1.5;
        }

        .thread-preview-caption {
            text-align: center;
            padding: 16px;
            color: #64748B;
            font-size: 14px;
            font-weight: 500;
        }

        .thread-preview-caption strong {
            color: #3182F6;
            font-weight: 700;
        }

        /* Security Badge */
        .security-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #F0FDF4;
            border: 1px solid #86EFAC;
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 16px;
        }

        .security-badge i {
            color: #22C55E;
            font-size: 18px;
        }

        .security-badge-text {
            font-size: 13px;
            color: #166534;
            font-weight: 600;
        }

        /* Loading State */
        .loading-container {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E5E7EB;
            border-top-color: #3182F6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        .loading-text {
            font-size: 15px;
            color: #6B7280;
            font-weight: 600;
        }

        /* Mobile Responsive */
        @media (max-width: 968px) {
            .two-column-layout {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .right-column {
                position: static;
                order: -1;
            }

            .thread-preview {
                display: none;
            }

            .main-container {
                padding: 24px 16px;
            }

            .service-header,
            .price-card,
            .process-steps {
                padding: 24px 20px;
                border-radius: 16px;
            }

            .service-header h1 {
                font-size: 22px;
            }

            .price-total .value {
                font-size: 26px;
            }

            .step-item {
                gap: 12px;
            }

            .step-number {
                width: 28px;
                height: 28px;
                font-size: 13px;
            }
        }

        /* Consulting Mode Styles */
        .consulting-badge {
            background: #FEF3C7;
            color: #D97706;
        }

        .consulting-notice {
            background: linear-gradient(135deg, #FEF3C7 0%, #FFFBEB 100%);
            border: 1px solid #FCD34D;
            border-radius: 16px;
            padding: 20px 24px;
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }

        .consulting-notice i {
            color: #D97706;
            font-size: 22px;
            margin-top: 2px;
        }

        .consulting-notice-content h3 {
            font-size: 17px;
            font-weight: 800;
            color: #92400E;
            margin-bottom: 6px;
        }

        .consulting-notice-content p {
            font-size: 14px;
            color: #78350F;
            font-weight: 600;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-inner">
            <div class="header-title">Apply for Service</div>
            <a href="javascript:void(0)" onclick="goBack()" class="btn-back">
                <i class="fas fa-times"></i>
            </a>
        </div>
    </div>

    <!-- Loading State -->
    <div class="main-container">
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Loading service information...</div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="two-column-layout" style="display: none;">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Service Header -->
                <div class="service-header">
                    <div class="service-badge" id="service-badge">
                        <i class="fas fa-file-alt"></i>
                        <span>Visa Service</span>
                    </div>
                    <h1 id="service-name">Visa Extension</h1>
                    <p id="service-desc">Extension of your current residence status</p>
                </div>

                <!-- Price Card (for payment services) -->
                <div class="price-card" id="price-card">
                    <h2>Price Details</h2>
                    <div class="price-row">
                        <span class="price-label">Agency Fee</span>
                        <span class="price-value" id="agency-fee">â‚©550,000</span>
                    </div>
                    <div class="price-row" id="govt-fee-row" style="display: none;">
                        <span class="price-label">Immigration Fee</span>
                        <span class="price-value" id="govt-fee">â‚©50,000</span>
                    </div>
                    <div class="price-total">
                        <span class="label">Total</span>
                        <span class="value" id="total-price">â‚©600,000</span>
                    </div>
                    <div class="govt-notice" id="govt-notice" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <span class="govt-notice-text">Immigration fee is included and paid by our center on your behalf.</span>
                    </div>
                </div>

                <!-- Consulting Notice (for consulting services) -->
                <div class="consulting-notice" id="consulting-notice" style="display: none;">
                    <i class="fas fa-star"></i>
                    <div class="consulting-notice-content">
                        <h3>Get a Custom Quote</h3>
                        <p>Every case is different. We'll provide an accurate quote after understanding your situation.</p>
                    </div>
                </div>

                <!-- Process Steps -->
                <div class="process-steps">
                    <h2><i class="fas fa-list-check"></i> How It Works</h2>

                    <div class="step-item">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Submit Application</h3>
                            <p>A dedicated thread will be created instantly</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Specialist Assigned</h3>
                            <p>We'll contact you within 30 minutes</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Document Review</h3>
                            <p>We'll guide you through required documents</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Service Complete</h3>
                            <p>We'll handle everything until completion</p>
                        </div>
                    </div>
                </div>

                <!-- CTA Button -->
                <div class="cta-section">
                    <button class="btn-primary" id="payBtn" onclick="processPayment()">
                        <i class="fas fa-credit-card"></i>
                        <span id="btn-text">Proceed to Payment</span>
                    </button>

                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span class="security-badge-text">Secured by Toss Payments Â· PCI DSS Certified</span>
                    </div>
                </div>
            </div>

            <!-- Right Column - Thread Preview -->
            <div class="right-column">
                <div class="thread-preview">
                    <div class="thread-preview-header">
                        <div class="thread-preview-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="thread-preview-title">
                            <h3>Your Dedicated Thread</h3>
                            <p>Real-time communication with our team</p>
                        </div>
                    </div>

                    <div class="thread-preview-image">
                        <img src="images/thread-preview.png" alt="Thread Preview" style="width: 100%; height: auto; display: block;">
                    </div>

                    <div class="thread-preview-caption">
                        <strong>Track your progress</strong> in real-time through your dedicated thread
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Immigration Fees (Based on Immigration Control Act)
        const govtFees = {
            'visa-extension': 50000,
            'visa-change': 119000,
            'visa-grant': 80000,
            'workplace-change': 99000,
            'outside-activity': 120000,
            'arc-application': 30000,
            'arc-reissue': 30000,
            'arc-change': 30000,
            'f4-residence': 30000,
            'naturalization': 300000,
            'nationality-recovery': 200000,
            'nationality-acquisition': 20000,
            'nationality-selection': 20000,
            'nationality-loss': 20000,
            'nationality-retention': 20000,
            'cert-entry-exit': 2000,
            'cert-arc': 2000,
            'cert-residence': 2000,
            'cert-realestate': 2000,
            'cert-number-change': 2000,
            'cert-nationality': 2000
        };

        // Service Pricing (Agency fee, VAT included)
        const servicePricing = {
            // Premium Services
            'visa-prediagnosis': { name: 'Visa Pre-diagnosis', price: 110000, govFee: 0, desc: 'Visa change, overstay risk, immigration law consultation', icon: 'ðŸ”' },
            'emergency-legal': { name: 'Immigration Dispute Resolution', price: 0, govFee: 0, desc: 'Criminal investigation, deportation defense, visa denial appeals', icon: 'âš–ï¸', consulting: true },

            // Education & Job Search
            'd4-to-d2-change': { name: 'D-4â†’D-2 Student Visa Change', price: 110000, govFee: 119000, desc: 'Language course to degree program', icon: 'ðŸŽ“' },
            'd10-1-change': { name: 'D-10-1 Job Seeker Visa Change', price: 220000, govFee: 100000, desc: 'General job seeking visa', icon: 'ðŸ”' },
            'd10-2-change': { name: 'D-10-2 Tech Startup Job Seeker', price: 330000, govFee: 100000, desc: 'Startup preparation visa', icon: 'ðŸ’¡' },
            'd10-3-change': { name: 'D-10-3 High-tech Intern Visa', price: 330000, govFee: 100000, desc: 'Advanced technology internship', icon: 'ðŸ”¬' },
            'd10-t-change': { name: 'D-10-T Top Talent Job Seeker', price: 330000, govFee: 100000, desc: 'Elite university graduate visa', icon: 'ðŸ†' },
            'd2-d4-extension': { name: 'D-2, D-4 Visa Extension', price: 110000, govFee: 50000, desc: 'Student visa renewal', icon: 'ðŸ“–' },
            'd10-extension': { name: 'D-10 Visa Extension', price: 110000, govFee: 50000, desc: 'Job seeker visa renewal', icon: 'â³' },
            'parttime-permit': { name: 'Part-time Work Permit', price: 33000, govFee: 0, desc: 'D-2, D-4 part-time employment', icon: 'â°' },
            'intern-report': { name: 'Internship Start/Change Report', price: 110000, govFee: 0, desc: 'D-10 internship notification', icon: 'ðŸ“' },
            'parent-invite': { name: 'Student Parent Invitation', price: 330000, govFee: 60000, desc: 'Excellent student parent visa', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§' },

            // Employment
            'e7-4-change': { name: 'E-7-4 Skilled Worker Visa', price: 550000, govFee: 119000, desc: 'E-9/H-2 skilled transition', icon: 'ðŸ”§' },
            'e7-4r-change': { name: 'E-7-4R Regional Skilled Worker', price: 550000, govFee: 119000, desc: 'Depopulated area skilled worker', icon: 'ðŸ˜ï¸' },
            'e7-change': { name: 'E-7 Professional Visa Change', price: 550000, govFee: 100000, desc: 'Professional employment visa', icon: 'ðŸ’¼' },
            'f2-7-change': { name: 'F-2-7 Points-based Residence', price: 550000, govFee: 100000, desc: 'Outstanding talent residence', icon: 'â­' },
            'f2-r-change': { name: 'F-2-R Regional Residence Visa', price: 550000, govFee: 100000, desc: 'Depopulated area residence', icon: 'ðŸ¡' },
            'e7-st-change': { name: 'E-7-S/T Elite Professional', price: 550000, govFee: 100000, desc: 'High-tech/high-income talent', icon: 'ðŸ†' },
            'e1-e6-change': { name: 'E-1~E-6 Professional Change', price: 550000, govFee: 100000, desc: 'Professor, researcher, specialist', icon: 'ðŸŽ“' },
            'e7-extension': { name: 'E-7 Visa Extension', price: 110000, govFee: 60000, desc: 'Professional visa renewal', icon: 'ðŸ“…' },
            'e9-workplace-change': { name: 'E-9 Workplace Change', price: 220000, govFee: 99000, desc: 'E-9 employer change', icon: 'ðŸ­' },
            'workplace-change-permit': { name: 'Workplace Change Permit', price: 220000, govFee: 120000, desc: 'Job transfer pre-approval', icon: 'ðŸ¢' },
            'outside-activity': { name: 'Additional Activity Permit', price: 220000, govFee: 120000, desc: 'Activities beyond visa scope', icon: 'ðŸ”“' },
            'h2-work-start': { name: 'H-2 Employment Start Report', price: 55000, govFee: 0, desc: 'Working visit job notification', icon: 'ðŸ“‹' },
            'workplace-change-report': { name: 'Workplace Change Report', price: 110000, govFee: 0, desc: 'Job transfer post-notification', icon: 'ðŸ“' },
            'employment-info-change': { name: 'Employment Info Update', price: 55000, govFee: 0, desc: 'Workplace/salary change report', icon: 'ðŸ’°' },
            'dispatch-report': { name: 'Dispatch Work Report', price: 110000, govFee: 0, desc: 'Subsidiary assignment report', icon: 'ðŸ”„' },
            'income-report': { name: 'Annual Income Report', price: 55000, govFee: 0, desc: 'Job and income notification', icon: 'ðŸ’µ' },
            'foreign-worker-change': { name: 'Foreign Worker Status Report', price: 55000, govFee: 0, desc: 'Resignation/departure report', icon: 'ðŸ“Š' },

            // Business & Investment
            'd8-1-change': { name: 'D-8-1 Corporate Investment', price: 1100000, govFee: 100000, desc: 'Corporate establishment visa', icon: 'ðŸ¢' },
            'd8-2-change': { name: 'D-8-2 Venture Investment', price: 1100000, govFee: 100000, desc: 'Venture company investment', icon: 'ðŸš€' },
            'd8-3-change': { name: 'D-8-3 Individual Investment', price: 1100000, govFee: 100000, desc: 'Sole proprietor investment', icon: 'ðŸ’¼' },
            'd8-4-change': { name: 'D-8-4 Tech Startup Visa', price: 550000, govFee: 100000, desc: 'Student entrepreneur visa', icon: 'ðŸ’¡' },
            'd9-1-change': { name: 'D-9-1 Trade Business', price: 1100000, govFee: 100000, desc: 'Trading business visa', icon: 'ðŸŒ' },
            'd9-2-change': { name: 'D-9-2 Export Equipment', price: 1100000, govFee: 100000, desc: 'Export facility management', icon: 'ðŸ­' },
            'd9-3-change': { name: 'D-9-3 Shipbuilding Supervisor', price: 1100000, govFee: 100000, desc: 'Ship/equipment supervision', icon: 'âš“' },
            'd9-4-change': { name: 'D-9-4 Commercial Business', price: 1100000, govFee: 100000, desc: 'Individual commercial visa', icon: 'ðŸ“Š' },
            'd9-5-change': { name: 'D-9-5 Graduate Entrepreneur', price: 550000, govFee: 100000, desc: 'Former student business', icon: 'ðŸŽ“' },
            'business-extension': { name: 'D-8, D-9 Business Extension', price: 220000, govFee: 60000, desc: 'Investment visa renewal', icon: 'ðŸ“…' },
            'fic-registration': { name: 'Foreign Investment Registration', price: 330000, govFee: 0, desc: 'FIC certificate issuance', icon: 'ðŸ“‹' },
            'fi-report': { name: 'Foreign Investment Report', price: 220000, govFee: 0, desc: 'Investment pre-notification', icon: 'ðŸ“' },

            // Ethnic Korean & Family
            'h2-to-f4-change': { name: 'H-2â†’F-4 Overseas Korean', price: 220000, govFee: 119000, desc: 'Working visit to overseas Korean', icon: 'ðŸ‡°ðŸ‡·' },
            'f4-change': { name: 'F-4 Overseas Korean Visa', price: 220000, govFee: 100000, desc: 'Overseas Korean status', icon: 'ðŸŽŒ' },
            'f4-registration': { name: 'F-4 Residence Registration', price: 110000, govFee: 35000, desc: 'F-4 residence card issuance', icon: 'ðŸ“' },
            'f4-extension': { name: 'F-4 Visa Extension', price: 110000, govFee: 50000, desc: 'F-4 residence renewal', icon: 'ðŸ“…' },
            'h2-extension': { name: 'H-2 Visa Extension', price: 110000, govFee: 50000, desc: 'Working visit renewal', icon: 'ðŸ›¬' },
            'f6-change': { name: 'F-6 Marriage Immigration', price: 1100000, govFee: 100000, desc: 'Spouse visa acquisition', icon: 'ðŸ’' },
            'f6-extension': { name: 'F-6 Visa Extension', price: 110000, govFee: 30000, desc: 'Marriage visa renewal', icon: 'ðŸ’’' },
            'f3-change': { name: 'F-3 Dependent Family Visa', price: 330000, govFee: 100000, desc: 'Spouse/child accompanying', icon: 'ðŸ‘ª' },
            'f1-change': { name: 'F-1 Family Visit Visa', price: 330000, govFee: 100000, desc: 'Relative long-term stay', icon: 'ðŸ ' },
            'visa-grant-child': { name: 'Child Birth Visa Grant', price: 220000, govFee: 80000, desc: 'Newborn child visa', icon: 'ðŸ‘¶' },
            'visa-grant-f6-child': { name: 'F-6 Child Visa Grant', price: 220000, govFee: 40000, desc: 'Marriage immigrant child', icon: 'ðŸ‘¶' },
            'family-invite': { name: 'Family Invitation Visa', price: 550000, govFee: 60000, desc: 'Overseas family invitation', icon: 'âœˆï¸' },
            'housework-report': { name: 'Domestic Work Report', price: 55000, govFee: 0, desc: 'Household help notification', icon: 'ðŸ¡' },

            // Residence & Citizenship
            'f5-change': { name: 'F-5 Permanent Residence', price: 1100000, govFee: 200000, desc: 'Korea permanent residency', icon: 'ðŸ ' },
            'f5-reissue': { name: 'F-5 Card Renewal (10yr)', price: 110000, govFee: 35000, desc: 'Permanent residence card', icon: 'ðŸ”„' },
            'f2-extension': { name: 'F-2 Residence Extension', price: 110000, govFee: 60000, desc: 'Residence visa renewal', icon: 'ðŸ¡' },
            'naturalization': { name: 'Naturalization Application', price: 1100000, govFee: 300000, desc: 'Korean citizenship', icon: 'ðŸ›ï¸' },
            'nationality-recovery': { name: 'Nationality Recovery', price: 550000, govFee: 200000, desc: 'Former Korean citizenship', icon: 'ðŸ”™' },
            'nationality-selection': { name: 'Nationality Selection', price: 110000, govFee: 20000, desc: 'Dual citizen selection', icon: 'ðŸŒ' },
            'nationality-renounce': { name: 'Nationality Renunciation', price: 110000, govFee: 20000, desc: 'Korean citizenship waiver', icon: 'ðŸ“„' },
            'nationality-loss': { name: 'Nationality Loss Report', price: 110000, govFee: 0, desc: 'Foreign citizenship report', icon: 'ðŸ“‹' },
            'nationality-retention': { name: 'Nationality Retention', price: 110000, govFee: 20000, desc: 'Citizenship retention intent', icon: 'âœï¸' },
            'nationality-acquisition': { name: 'Nationality Acquisition', price: 110000, govFee: 20000, desc: 'Recognition-based citizenship', icon: 'ðŸ“œ' },
            'nationality-judgment': { name: 'Nationality Determination', price: 110000, govFee: 30000, desc: 'Nationality status inquiry', icon: 'âš–ï¸' },

            // General Registration & Certificates
            'arc-registration': { name: 'Alien Registration', price: 110000, govFee: 35000, desc: 'Required within 90 days', icon: 'ðŸ†”' },
            'arc-reissue': { name: 'ARC Reissue', price: 110000, govFee: 35000, desc: 'Lost/damaged card replacement', icon: 'ðŸ”„' },
            'address-change': { name: 'Address Change Report', price: 33000, govFee: 0, desc: 'Moving address update', icon: 'ðŸ ' },
            'f4-address-change': { name: 'F-4 Address Change', price: 33000, govFee: 0, desc: 'Overseas Korean address', icon: 'ðŸ‡°ðŸ‡·' },
            'passport-change': { name: 'Passport/Info Change', price: 33000, govFee: 0, desc: 'Passport/name update', icon: 'ðŸ“' },
            'reentry-permit-multiple': { name: 'Multiple Re-entry Permit', price: 55000, govFee: 41300, desc: 'Multiple border crossings', icon: 'ðŸ”' },
            'reentry-permit-single': { name: 'Single Re-entry Permit', price: 55000, govFee: 28300, desc: 'One-time border crossing', icon: 'ðŸ”™' },
            'cert-entry-exit': { name: 'Entry/Exit Certificate', price: 22000, govFee: 2000, desc: 'Travel history record', icon: 'ðŸ“‹' },
            'cert-arc': { name: 'ARC Certificate', price: 22000, govFee: 2000, desc: 'Registration proof', icon: 'ðŸ“„' },
            'cert-residence': { name: 'Residence Certificate', price: 22000, govFee: 2000, desc: 'F-4 residence proof', icon: 'ðŸ ' },
            'cert-realestate': { name: 'Real Estate Registration ID', price: 22000, govFee: 2000, desc: 'Property transaction', icon: 'ðŸ˜ï¸' },
            'cert-arc-number-change': { name: 'ARC Number Change Cert', price: 22000, govFee: 2000, desc: 'Number change confirmation', icon: 'ðŸ“‹' },
            'cert-nationality': { name: 'Nationality Certificate', price: 22000, govFee: 2000, desc: 'Nationality status proof', icon: 'ðŸ“œ' }
        };

        let selectedService = null;
        let selectedPaymentMethod = 'card';

        function goBack() {
            const referrer = document.referrer;
            if (referrer && referrer.includes(window.location.host)) {
                window.location.href = referrer;
            } else {
                window.location.href = 'index.html';
            }
        }

        window.isAdminLoggedIn = function() {
            return sessionStorage.getItem('adminLoggedIn') === 'true';
        };

        window.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdminMode = urlParams.get('admin') === 'true' || window.isAdminLoggedIn();

            if (isAdminMode) {
                console.log('âœ… Admin mode - skipping session check');

                try {
                    const tossPaymentsInstance = TossPayments(clientKey);
                    tossPayments = tossPaymentsInstance.payment({
                        customerKey: 'admin_' + Date.now()
                    });
                } catch (error) {
                    console.error('âŒ Toss Payments init failed:', error);
                }

                const serviceId = urlParams.get('service');
                if (!serviceId || !servicePricing[serviceId]) {
                    alert('Invalid service.');
                    window.location.href = 'index.html';
                    return;
                }

                selectedService = servicePricing[serviceId];
                document.getElementById('loading').style.display = 'none';
                showContent(serviceId);
                return;
            }

            let session = await checkSession();

            if (!session || !session.user) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                session = await checkSession();
            }

            if (!session || !session.user) {
                const currentUrl = window.location.href;
                localStorage.setItem('redirectAfterLogin', currentUrl);

                if (confirm('Login required.\n\nSign in with Google?')) {
                    await signInWithGoogle();
                }
                return;
            }

            try {
                const tossPaymentsInstance = TossPayments(clientKey);
                tossPayments = tossPaymentsInstance.payment({
                    customerKey: session.user.id
                });
            } catch (error) {
                console.error('âŒ Toss Payments init failed:', error);
            }

            const serviceId = urlParams.get('service');

            if (!serviceId || !servicePricing[serviceId]) {
                alert('Invalid access.');
                window.history.back();
                return;
            }

            selectedService = servicePricing[serviceId];

            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                showContent(serviceId);
            }, 500);
        });

        function showContent(serviceId) {
            document.getElementById('service-name').textContent = selectedService.name;
            document.getElementById('service-desc').textContent = selectedService.desc;

            if (selectedService.consulting) {
                // Consulting mode
                document.getElementById('price-card').style.display = 'none';
                document.getElementById('consulting-notice').style.display = 'flex';
                document.getElementById('service-badge').innerHTML = '<i class="fas fa-comments"></i><span>Consultation</span>';
                document.getElementById('service-badge').classList.add('consulting-badge');
                document.getElementById('btn-text').textContent = 'Request Quote';
                document.getElementById('payBtn').onclick = applyForConsulting;

                // Hide payment icon, show message icon
                document.querySelector('#payBtn i').className = 'fas fa-paper-plane';
            } else {
                // Payment mode
                const agencyFee = selectedService.price;
                const govtFee = selectedService.govFee || 0;
                const totalPrice = agencyFee + govtFee;

                document.getElementById('agency-fee').textContent = 'â‚©' + agencyFee.toLocaleString();

                if (govtFee > 0) {
                    document.getElementById('govt-fee-row').style.display = 'flex';
                    document.getElementById('govt-fee').textContent = 'â‚©' + govtFee.toLocaleString();
                    document.getElementById('govt-notice').style.display = 'flex';
                }

                document.getElementById('total-price').textContent = 'â‚©' + totalPrice.toLocaleString();

                selectedService.totalPrice = totalPrice;
                selectedService.agencyFee = agencyFee;
                selectedService.govtFee = govtFee;
            }

            document.getElementById('main-content').style.display = 'grid';
        }

        const clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq';
        let tossPayments = null;

        async function processPayment() {
            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner"></i> Processing...';

            try {
                let profile = null;
                let session = null;

                const isAdminMode = window.isAdminLoggedIn && window.isAdminLoggedIn();

                if (isAdminMode) {
                    profile = {
                        name: 'Admin Test',
                        email: 'admin@lawyeon.com',
                        phone: '010-0000-0000'
                    };
                    session = { user: { id: 'admin_' + Date.now(), email: 'admin@lawyeon.com' } };
                } else {
                    session = await checkSession();
                    if (!session || !session.user) {
                        alert('Login required.');
                        window.location.href = 'index.html';
                        return;
                    }

                    const profileResult = await getUserProfile(session.user.id);
                    if (profileResult.success && profileResult.data) {
                        profile = profileResult.data;
                    } else {
                        profile = {
                            name: session.user.email.split('@')[0],
                            email: session.user.email,
                            phone: ''
                        };
                    }
                }

                const orderInfo = {
                    orderId: 'ORD' + Date.now(),
                    orderName: selectedService.name,
                    amount: selectedService.totalPrice,
                    agencyFee: selectedService.agencyFee,
                    govtFee: selectedService.govtFee,
                    customerName: profile.name || session.user.email,
                    customerEmail: profile.email || session.user.email,
                    customerPhone: profile.phone || '',
                    paymentMethod: selectedPaymentMethod,
                    timestamp: new Date().toISOString()
                };

                sessionStorage.setItem('pendingPayment', JSON.stringify({
                    orderId: orderInfo.orderId,
                    serviceName: orderInfo.orderName,
                    amount: orderInfo.amount,
                    agencyFee: orderInfo.agencyFee,
                    govtFee: orderInfo.govtFee,
                    paymentMethod: orderInfo.paymentMethod,
                    customerName: orderInfo.customerName,
                    customerEmail: orderInfo.customerEmail
                }));

                if (!tossPayments) {
                    throw new Error('Payment system not initialized');
                }

                const currentUrl = window.location.origin;

                const paymentRequest = {
                    method: 'CARD',
                    amount: {
                        currency: 'KRW',
                        value: orderInfo.amount
                    },
                    orderId: orderInfo.orderId,
                    orderName: orderInfo.orderName,
                    successUrl: currentUrl + '/payment-success.html',
                    failUrl: currentUrl + '/payment-fail.html',
                    customerEmail: orderInfo.customerEmail,
                    customerName: orderInfo.customerName,
                    card: {
                        useEscrow: false,
                        flowMode: 'DEFAULT',
                        useCardPoint: false,
                        useAppCardOnly: false
                    }
                };

                if (orderInfo.customerPhone && orderInfo.customerPhone.trim()) {
                    paymentRequest.customerMobilePhone = orderInfo.customerPhone.replace(/-/g, '');
                }

                await tossPayments.requestPayment(paymentRequest);

            } catch (error) {
                console.error('Payment error:', error);
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';

                if (error.code === 'PAY_PROCESS_CANCELED') {
                    return;
                }

                alert('Payment processing error. Please try again.');
            }
        }

        async function applyForConsulting() {
            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner"></i> Submitting...';

            try {
                const session = await checkSession();
                if (!session || !session.user) {
                    alert('Login required.');
                    window.location.href = 'index.html';
                    return;
                }

                const threadResult = await createThread({
                    service_name: selectedService.name + ' (Quote Request)',
                    status: 'document',
                    amount: 0,
                    order_id: 'CONSULT-' + Date.now(),
                    is_consulting: true,
                    organization: 'general'
                });

                if (!threadResult.success) {
                    throw new Error('Thread creation failed');
                }

                alert('Quote request submitted!\n\nOur specialist will contact you shortly through your dedicated thread.');
                window.location.href = `thread-general-v2.html?id=${threadResult.data.id}`;
            } catch (error) {
                console.error('Consultation request error:', error);
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Request Quote';
                alert('An error occurred. Please try again.');
            }
        }
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js?v=20250119"></script>
</body>
</html>
