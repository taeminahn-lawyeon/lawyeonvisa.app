<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ì“°ë ˆë“œ - ë²•ë¬´ë²•ì¸ ë¡œì—°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/ui-components.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .thread-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            background: white;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }

        /* Thread Header */
        .thread-header {
            padding: 20px 24px;
            border-bottom: 2px solid #f3f4f6;
            background: white;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #f3f4f6;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #e5e7eb;
        }

        .thread-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .service-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .service-meta {
            color: #6b7280;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Thread Main */
        .thread-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            flex-shrink: 0;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            line-height: 1.6;
            color: #1f2937;
            font-size: 15px;
            word-break: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
            align-self: flex-start;
        }

        .message-file {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 280px;
        }

        .message-file:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .file-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 13px;
            color: #1f2937;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* System Message */
        .system-message {
            text-align: center;
            margin: 30px 0;
        }

        .system-message-content {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: white;
            border-top: 2px solid #f3f4f6;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-controls {
            display: flex;
            gap: 8px;
        }

        .input-btn {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .input-btn:hover {
            background: #f3f4f6;
            border-color: #3182F6;
            color: #3182F6;
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #3182F6;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            transform: none;
        }

        /* Sidebar */
        .thread-sidebar {
            width: 320px;
            background: #f9fafb;
            border-left: 2px solid #f3f4f6;
            overflow-y: auto;
            padding: 24px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-size: 15px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .document-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            border-color: #3182F6;
            background: #f0f4ff;
        }

        .document-icon {
            width: 36px;
            height: 36px;
            background: #3182F6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .document-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 968px) {
            body {
                overflow-y: auto;
                height: auto;
            }

            .thread-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                max-width: 100%;
            }

            .thread-sidebar {
                display: none;
                width: 100%;
                border-left: none;
                border-top: 2px solid #f3f4f6;
                padding: 16px;
            }

            .thread-sidebar.mobile-show {
                display: block;
            }

            .thread-header {
                padding: 16px;
            }

            .header-top {
                flex-wrap: wrap;
                gap: 10px;
            }

            .back-btn {
                padding: 8px 12px;
                font-size: 14px;
            }

            .service-title {
                font-size: 18px;
            }

            .service-meta {
                font-size: 13px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .status-badge {
                padding: 5px 12px;
                font-size: 12px;
            }

            .messages-area {
                padding: 16px 12px;
                min-height: 50vh;
            }

            .message {
                gap: 8px;
                margin-bottom: 20px;
            }

            .message-content {
                max-width: 75%;
            }

            .message-bubble {
                padding: 10px 14px;
                font-size: 14px;
                border-radius: 16px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .message-sender {
                font-size: 11px;
            }

            .message-time {
                font-size: 10px;
            }

            .input-area {
                padding: 12px 16px !important;
                position: sticky;
                bottom: 0;
                background: white;
                z-index: 10;
            }

            .input-wrapper {
                gap: 8px !important;
            }

            .input-controls {
                flex-direction: column;
                gap: 6px !important;
            }

            .input-btn {
                width: 38px !important;
                height: 38px !important;
                font-size: 16px;
            }

            .message-input {
                font-size: 14px;
                padding: 10px 12px !important;
                min-height: 38px !important;
            }

            .send-btn {
                width: 38px !important;
                height: 38px !important;
                font-size: 16px;
            }

            .message-file {
                padding: 10px;
            }

            .file-icon {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .file-name {
                font-size: 13px;
            }

            .file-size {
                font-size: 11px;
            }

            .system-message {
                margin: 20px 0;
            }

            .system-message-content {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* ì´ˆì†Œí˜• ëª¨ë°”ì¼ (iPhone SE ë“±) */
        @media (max-width: 375px) {
            .thread-header {
                padding: 12px;
            }

            .service-title {
                font-size: 16px;
            }

            .service-meta {
                font-size: 12px;
            }

            .messages-area {
                padding: 12px 10px;
            }

            .message {
                gap: 6px;
                margin-bottom: 16px;
            }

            .message-content {
                max-width: 78%;
            }

            .message-bubble {
                padding: 9px 12px;
                font-size: 13px;
                border-radius: 14px;
            }

            .message-avatar {
                width: 30px;
                height: 30px;
                font-size: 11px;
            }

            .message-file {
                padding: 8px 10px;
                max-width: 240px;
            }

            .file-icon {
                width: 38px;
                height: 38px;
                font-size: 18px;
            }

            .input-area {
                padding: 10px 12px !important;
            }

            .input-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 14px;
            }

            .send-btn {
                width: 36px !important;
                height: 36px !important;
            }
        }
    </style>
</head>
<body>
    <div class="thread-container">
        <div class="thread-main">
            <div class="thread-header">
                <div class="header-top">
                    <button class="back-btn" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> ëŒì•„ê°€ê¸°
                    </button>
                    <div class="status-badge processing" id="statusBadge">ì§„í–‰ì¤‘</div>
                </div>
                <div class="thread-info">
                    <div>
                        <div class="service-title" id="serviceTitle">ë¡œë”© ì¤‘...</div>
                        <div class="service-meta">
                            <span><i class="fas fa-calendar"></i> <span id="threadDate">-</span></span>
                            <span><i class="fas fa-building"></i> ì„¼í„° ë‹´ë‹¹ì</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="system-message">
                    <div class="system-message-content">
                        <i class="fas fa-check-circle"></i> ìƒë‹´ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                </div>

                <!-- ë©”ì‹œì§€ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>

            <div class="input-area" style="padding: 20px 24px; background: white; border-top: 2px solid #f3f4f6;">
                <div class="input-wrapper" style="display: flex; gap: 12px; align-items: center;">
                    <div class="input-controls" style="display: flex; gap: 8px;">
                        <button class="input-btn" onclick="attachFile()" style="width: 42px; height: 42px; flex-shrink: 0;">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-btn" onclick="attachImage()" style="width: 42px; height: 42px; flex-shrink: 0;">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="message-input-wrapper" style="flex: 1;">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Shift+Enter: ì¤„ë°”ê¿ˆ, Enter: ì „ì†¡)"
                            rows="1"
                            style="width: 100%; min-height: 42px; max-height: 120px; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; font-family: 'Noto Sans KR', sans-serif; resize: none;"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" style="width: 42px; height: 42px; flex-shrink: 0;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
            </div>
        </div>

        <div class="thread-sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-info-circle"></i> ì‹ ì²­ ì •ë³´</h3>
                <div class="info-item">
                    <div class="info-label">ì‹ ì²­ ë²ˆí˜¸</div>
                    <div class="info-value" id="applicationId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì‹ ì²­ì¼</div>
                    <div class="info-value" id="applicationDate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê²°ì œ ê¸ˆì•¡</div>
                    <div class="info-value" id="amount">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì„¼í„° ë‹´ë‹¹ì</div>
                    <div class="info-value">ë²•ë¬´ë²•ì¸ ë¡œì—°</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-file-alt"></i> ì²¨ë¶€ ì„œë¥˜</h3>
                <div id="documentsList">
                    <p style="color: #6B7280; font-size: 14px; padding: 12px 0;">ì•„ì§ ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-clock"></i> ì§„í–‰ í˜„í™©</h3>
                <div class="info-item">
                    <div class="info-label">í˜„ì¬ ë‹¨ê³„</div>
                    <div class="info-value" id="currentStatus">ì ‘ìˆ˜ ì™„ë£Œ</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì˜ˆìƒ ì™„ë£Œì¼</div>
                    <div class="info-value" id="expectedDate">-</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

    <script src="js/ui-components.js?v=20251218"></script>
    <script>
        // Toast ì•Œë¦¼ í•¨ìˆ˜ (ui-components.js ë¡œë“œ ì‹¤íŒ¨ ëŒ€ë¹„)
        function showToast(message, type = 'info', duration = 3000) {
            // ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´ (ui-components.js ë¡œë“œ ì‹¤íŒ¨ ì‹œ)
            if (typeof ToastNotification === 'undefined') {
                console.log(`[Toast ${type}] ${message}`);
                return;
            }
            
            // ì‹¤ì œ Toast í‘œì‹œ
            const toast = new ToastNotification();
            toast.show(message, type, duration);
        }
        
        // í˜ì´ì§€ ë¡œë“œ
        let threadId = null;
        let currentUser = null;
        let messageChannel = null;  // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… ì±„ë„

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ” [ì“°ë ˆë“œ] í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            
            // Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
            if (typeof supabaseClient === 'undefined') {
                console.error('âŒ [ì“°ë ˆë“œ] supabaseClientê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }
            console.log('âœ… [ì“°ë ˆë“œ] supabaseClient í™•ì¸ë¨');
            
            const urlParams = new URLSearchParams(window.location.search);
            threadId = urlParams.get('thread_id') || urlParams.get('id');
            console.log('ğŸ” [ì“°ë ˆë“œ] URL íŒŒë¼ë¯¸í„°:', { thread_id: threadId });

            if (!threadId) {
                console.error('âŒ [ì“°ë ˆë“œ] ì“°ë ˆë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤');
                alert('ì“°ë ˆë“œ IDê°€ ì—†ìŠµë‹ˆë‹¤.\n\në©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            // Supabase ì„¸ì…˜ í™•ì¸
            console.log('ğŸ” [ì“°ë ˆë“œ] ì„¸ì…˜ í™•ì¸ ì¤‘...');
            let session;
            try {
                session = await checkSession();
                console.log('âœ… [ì“°ë ˆë“œ] ì„¸ì…˜ í™•ì¸ ì™„ë£Œ:', session ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨');
            } catch (error) {
                console.error('âŒ [ì“°ë ˆë“œ] ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = 'index.html';
                return;
            }
            
            if (!session || !session.user) {
                console.error('âŒ [ì“°ë ˆë“œ] ì„¸ì…˜ ì—†ìŒ');
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                window.location.href = 'index.html';
                return;
            }
            console.log('âœ… [ì“°ë ˆë“œ] ì‚¬ìš©ì ì´ë©”ì¼:', session.user.email);
            
            // í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const profileResult = await getUserProfile(session.user.id);
            if (profileResult.success && profileResult.data) {
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: profileResult.data.name || session.user.email
                };
            } else {
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.email
                };
            }

            loadThread();
            loadMessages();
            
            // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… ì‹œì‘
            subscribeToMessages();
            
            // ìë™ ë¦¬ì‚¬ì´ì¦ˆ
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        });

        // ============================================
        // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë… (Supabase Realtime)
        // ============================================
        function subscribeToMessages() {
            if (!threadId) {
                console.error('âŒ [Realtime] threadIdê°€ ì—†ì–´ êµ¬ë… ë¶ˆê°€');
                return;
            }
            
            console.log('ğŸ”” [Realtime] ë©”ì‹œì§€ êµ¬ë… ì‹œì‘, threadId:', threadId);
            
            if (messageChannel) {
                supabaseClient.removeChannel(messageChannel);
            }
            
            messageChannel = supabaseClient
                .channel(`thread-messages-${threadId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `thread_id=eq.${threadId}`
                }, (payload) => {
                    console.log('ğŸ“© [Realtime] ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', payload.new);
                    
                    const newMessage = payload.new;
                    
                    if (currentUser && newMessage.sender_id === currentUser.id) {
                        console.log('â­ï¸ [Realtime] ë³¸ì¸ ë©”ì‹œì§€ ìŠ¤í‚µ');
                        return;
                    }
                    
                    const messageTime = new Date(newMessage.created_at).toLocaleTimeString('ko-KR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // sender_type ë§¤í•‘: 'system', 'admin' -> 'admin'
                    const isAdmin = newMessage.sender_type === 'admin' || newMessage.sender_type === 'system';

                    const msg = {
                        sender: isAdmin ? 'admin' : 'user',
                        name: newMessage.sender_name || (isAdmin ? 'ë²•ë¬´ë²•ì¸ ë¡œì—°' : 'ìƒëŒ€ë°©'),
                        content: newMessage.content,
                        time: messageTime,
                        avatar: isAdmin ? 'ë¡œ' : 'ë‚˜',
                        file_url: newMessage.file_url,
                        file_name: newMessage.file_name,
                        file_type: newMessage.file_type
                    };
                    
                    appendMessage(msg);
                    scrollToBottom();
                    showToast('ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.', 'info', 3000);
                    
                    if (Notification.permission === 'granted') {
                        new Notification('ë²•ë¬´ë²•ì¸ ë¡œì—°', {
                            body: newMessage.content.substring(0, 50) + (newMessage.content.length > 50 ? '...' : ''),
                            icon: '/favicon.svg'
                        });
                    }
                })
                .subscribe((status) => {
                    console.log('ğŸ”” [Realtime] êµ¬ë… ìƒíƒœ:', status);
                });
        }
        
        window.addEventListener('beforeunload', () => {
            if (messageChannel) {
                supabaseClient.removeChannel(messageChannel);
            }
        });
        
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ì“°ë ˆë“œ ì •ë³´ ë¡œë“œ
        async function loadThread() {
            if (!threadId) {
                console.error('âŒ [loadThread] threadIdê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            console.log('ğŸ” [loadThread] ì“°ë ˆë“œ ë¡œë“œ ì‹œì‘, ID:', threadId);
            
            try {
                // í˜„ì¬ ì‚¬ìš©ì í”„ë¡œí•„ í™•ì¸ (ê´€ë¦¬ì ê¶Œí•œ ì²´í¬)
                console.log('ğŸ” [loadThread] í”„ë¡œí•„ í™•ì¸ ì¤‘...');
                const profileResult = await getUserProfile(currentUser.id);
                const isAdmin = profileResult.success && 
                               profileResult.data && 
                               (profileResult.data.role === 'super_admin' || profileResult.data.role === 'partner_admin');
                console.log('âœ… [loadThread] ê´€ë¦¬ì ê¶Œí•œ:', isAdmin);
                
                // Supabaseì—ì„œ ì“°ë ˆë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                console.log('ğŸ” [loadThread] Supabaseì—ì„œ ì“°ë ˆë“œ ì¡°íšŒ ì¤‘...');
                let query = supabaseClient
                    .from('threads')
                    .select(`
                        *,
                        profiles!threads_user_id_fkey (
                            name,
                            email,
                            phone
                        )
                    `)
                    .eq('id', threadId);
                
                // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ user_id í•„í„° ì¶”ê°€ ë° archived ìƒíƒœ ì œì™¸
                if (!isAdmin) {
                    query = query
                        .eq('user_id', currentUser.id)
                        .neq('status', 'archived'); // ê³ ê°ì€ ë³´ê´€ëœ ì“°ë ˆë“œ ë³¼ ìˆ˜ ì—†ìŒ
                    console.log('ğŸ” [loadThread] ì¼ë°˜ ì‚¬ìš©ì í•„í„° ì ìš©');
                }
                
                const { data: thread, error } = await query.single();
                
                if (error || !thread) {
                    console.error('âŒ [loadThread] ì“°ë ˆë“œ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    console.error('âŒ [loadThread] ì—ëŸ¬ ìƒì„¸:', {
                        code: error?.code,
                        message: error?.message,
                        details: error?.details,
                        hint: error?.hint
                    });
                    console.error('âŒ [loadThread] ì¿¼ë¦¬ ì •ë³´:', {
                        threadId: threadId,
                        currentUserId: currentUser.id,
                        isAdmin: isAdmin
                    });
                    
                    let errorMessage = 'ì“°ë ˆë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n';
                    let redirectUrl = 'index.html';
                    
                    if (error?.code === 'PGRST116') {
                        errorMessage += 'ì´ìœ : ì“°ë ˆë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n';
                        errorMessage += 'â€¢ ì“°ë ˆë“œê°€ ì‚­ì œë˜ì—ˆê±°ë‚˜\n';
                        errorMessage += 'â€¢ ì˜ëª»ëœ ì“°ë ˆë“œ IDì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n';
                        errorMessage += 'ì‹ ì²­ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    } else if (error?.message) {
                        errorMessage += 'ì˜¤ë¥˜ ë‚´ìš©: ' + error.message + '\n\n';
                        errorMessage += 'ì‹ ì²­ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    } else {
                        errorMessage += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n';
                        errorMessage += 'ì‹ ì²­ ë‚´ì—­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    }
                    
                    alert(errorMessage);
                    
                    // ì¼ë°˜ ì‚¬ìš©ììš© index.htmlë¡œ ì´ë™
                    window.location.href = redirectUrl;
                    return;
                }
                
                console.log('âœ… [loadThread] ì“°ë ˆë“œ ì¡°íšŒ ì„±ê³µ:', thread);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('serviceTitle').textContent = thread.service_name || 'ì„œë¹„ìŠ¤ëª… ì—†ìŒ';
                document.getElementById('threadDate').textContent = new Date(thread.created_at).toLocaleDateString('ko-KR');
                document.getElementById('applicationId').textContent = thread.order_id || thread.id;
                document.getElementById('applicationDate').textContent = new Date(thread.created_at).toLocaleDateString('ko-KR');
                
                // ë¹„ì ì‚¬ì „ì§„ë‹¨ì˜ ê²½ìš° 55,000ì›ìœ¼ë¡œ ê³ ì • í‘œì‹œ
                if (thread.service_name && thread.service_name.includes('ë¹„ì ì‚¬ì „ì§„ë‹¨')) {
                    document.getElementById('amount').textContent = 'â‚©55,000';
                } else if (thread.amount > 0) {
                    document.getElementById('amount').textContent = 'â‚©' + thread.amount.toLocaleString();
                } else {
                    document.getElementById('amount').textContent = '-';
                }
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                const statusMap = {
                    'document': 'ì„œë¥˜ ëŒ€ê¸°',
                    'payment': 'ê²°ì œ ì™„ë£Œ',
                    'processing': 'ì§„í–‰ ì¤‘',
                    'completed': 'ì™„ë£Œ'
                };
                document.getElementById('currentStatus').textContent = statusMap[thread.status] || 'ì ‘ìˆ˜ ì™„ë£Œ';
                
                // ì˜ˆìƒ ì™„ë£Œì¼ ì œê±°
                const expectedDate = document.getElementById('expectedDate');
                if (expectedDate) {
                    expectedDate.textContent = '-';
                }
            
                // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
                const statusBadge = document.getElementById('statusBadge');
                const statusMapBadge = {
                    'payment': { text: 'ê²°ì œ ì™„ë£Œ', class: 'processing' },
                    'document': { text: 'ì„œë¥˜ ìˆ˜ì§‘ ì¤‘', class: 'pending' },
                    'processing': { text: 'ì‹ ì²­ ì§„í–‰ ì¤‘', class: 'processing' },
                    'completed': { text: 'ì²˜ë¦¬ ì™„ë£Œ', class: 'completed' },
                    'archived': { text: 'ì™„ë£Œ (ë³´ê´€)', class: 'completed' }
                };
                
                const status = statusMapBadge[thread.status] || { text: 'ì§„í–‰ ì¤‘', class: 'processing' };
                statusBadge.textContent = status.text;
                statusBadge.className = 'status-badge ' + status.class;
            } catch (error) {
                console.error('âŒ ì“°ë ˆë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì“°ë ˆë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'index.html';
            }
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages() {
            const messagesArea = document.getElementById('messagesArea');
            
            if (!threadId) return;
            
            try {
                // Supabaseì—ì„œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                const result = await getThreadMessages(threadId);
                
                if (result.success && result.data && result.data.length > 0) {
                    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œì™¸í•˜ê³  ë™ì  ë©”ì‹œì§€ë§Œ ì œê±°
                    const systemMessage = messagesArea.querySelector('.system-message');
                    messagesArea.innerHTML = '';
                    if (systemMessage) {
                        messagesArea.appendChild(systemMessage);
                    }
                    
                    // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€ (ì²« ë©”ì‹œì§€ë¡œ)
                    const welcomeMessage = {
                        sender: 'admin',
                        name: 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                        content: 'ì•ˆë…•í•˜ì„¸ìš”! ë²•ë¬´ë²•ì¸ ë¡œì—° ì¶œì…êµ­ì´ë¯¼ì§€ì›ì„¼í„°ì…ë‹ˆë‹¤.\n\nì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¼í„° ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                        time: new Date(result.data[0].created_at).toLocaleTimeString('ko-KR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        avatar: 'ë¡œ'
                    };
                    appendMessage(welcomeMessage);
                    
                    // ë‚˜ë¨¸ì§€ ë©”ì‹œì§€ í‘œì‹œ
                    result.data.forEach(msg => {
                        // sender_type ë§¤í•‘: 'system', 'admin' -> 'admin', 'user', 'customer' -> 'user'
                        let mappedSender = msg.sender_type;
                        if (msg.sender_type === 'system' || msg.sender_type === 'admin') {
                            mappedSender = 'admin';
                        } else if (msg.sender_type === 'customer') {
                            mappedSender = 'user';
                        }

                        const messageData = {
                            sender: mappedSender,
                            name: mappedSender === 'user' ? 'ë³¸ì¸' : (msg.sender_name || 'ë²•ë¬´ë²•ì¸ ë¡œì—°'),
                            content: msg.content,
                            time: new Date(msg.created_at).toLocaleTimeString('ko-KR', {
                                hour: '2-digit',
                                minute: '2-digit'
                            }),
                            avatar: mappedSender === 'user' ? 'ë‚˜' : 'ë¡œ',
                            file_url: msg.file_url,
                            file_name: msg.file_name,
                            file_type: msg.file_type
                        };
                        appendMessage(messageData);
                    });
                } else {
                    // ë©”ì‹œì§€ ì—†ì„ ë•Œë„ í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
                    const welcomeMessage = {
                        sender: 'admin',
                        name: 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                        content: 'ì•ˆë…•í•˜ì„¸ìš”! ë²•ë¬´ë²•ì¸ ë¡œì—° ì¶œì…êµ­ì´ë¯¼ì§€ì›ì„¼í„°ì…ë‹ˆë‹¤.\n\nì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¼í„° ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                        time: new Date().toLocaleTimeString('ko-KR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        avatar: 'ë¡œ'
                    };
                    appendMessage(welcomeMessage);
                }
                
                scrollToBottom();
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë’¤ë¡œ ê°€ê¸° í•¨ìˆ˜
        async function goBack() {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ from í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const from = urlParams.get('from');
            
            // from íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ê·¸ê³³ìœ¼ë¡œ ì´ë™
            if (from === 'admin') {
                window.location.href = 'admin-dashboard.html';
                return;
            }
            
            // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¼ë°˜ ì‚¬ìš©ì í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = 'index.html';
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function appendMessage(msg) {
            const messagesArea = document.getElementById('messagesArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender}`;
            
            // íŒŒì¼ ì²¨ë¶€ ì—¬ë¶€ í™•ì¸
            let fileHtml = '';
            if (msg.file_url && msg.file_name) {
                const fileIcon = getFileIcon(msg.file_type);
                fileHtml = `
                    <div class="message-file" onclick="downloadFile('${msg.file_url}', '${msg.file_name}')">
                        <div class="file-icon">${fileIcon}</div>
                        <div class="file-info">
                            <div class="file-name">${msg.file_name}</div>
                            <div class="file-size">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</div>
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${msg.avatar}</div>
                <div class="message-content">
                    <div class="message-sender">${msg.name}</div>
                    <div class="message-bubble">${msg.content}</div>
                    ${fileHtml}
                    <div class="message-time">${msg.time}</div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
        }
        
        // íŒŒì¼ íƒ€ì…ë³„ ì•„ì´ì½˜ ë°˜í™˜
        function getFileIcon(fileType) {
            if (!fileType) return 'ğŸ“„';
            
            if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (fileType.includes('pdf')) return 'ğŸ“•';
            if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“';
            if (fileType.includes('excel') || fileType.includes('sheet')) return 'ğŸ“Š';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'ğŸ“¦';
            
            return 'ğŸ“„';
        }
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadFile(fileUrl, fileName) {
            try {
                // ìƒˆ íƒ­ì—ì„œ íŒŒì¼ ì—´ê¸°
                window.open(fileUrl, '_blank');
                showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success', 2000);
            } catch (error) {
                console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 2000);
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                return;
            }

            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');

            try {
                // Supabaseì— ë©”ì‹œì§€ ì €ì¥
                const result = await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: content
                });
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // UIì— ë©”ì‹œì§€ ì¶”ê°€
                const message = {
                    sender: 'user',
                    name: 'ë³¸ì¸',
                    content: content,
                    time: time,
                    avatar: 'ë‚˜'
                };
                
                appendMessage(message);
                input.value = '';
                input.style.height = 'auto';
                scrollToBottom();
                
                showToast('ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 2000);
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                showToast('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 2000);
            }
        }

        // íŒŒì¼ ì²¨ë¶€
        function attachFile() {
            document.getElementById('fileInput').click();
        }

        function attachImage() {
            const input = document.getElementById('fileInput');
            input.accept = 'image/*';
            input.click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error', 3000);
                return;
            }
            
            showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info', 2000);
            
            try {
                // Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ
                const uploadResult = await uploadThreadDocument(threadId, file);
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error);
                }
                
                console.log('âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', uploadResult.data);
                
                // ë©”ì‹œì§€ë¡œ íŒŒì¼ ì •ë³´ ì „ì†¡
                const messageResult = await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: `íŒŒì¼ ì²¨ë¶€: ${file.name}`,
                    file_url: uploadResult.data.signedUrl,
                    file_name: file.name,
                    file_type: file.type
                });
                
                if (!messageResult.success) {
                    throw new Error(messageResult.error);
                }
                
                showToast(`${file.name} íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success', 3000);
                
                // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMessages();
                
                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                event.target.value = '';
                
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 3000);
            }
        }

        // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Enter í‚¤ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js?v=20250119"></script>
    
    <!-- ë‹¤êµ­ì–´ ì‹œìŠ¤í…œ -->
    <script src="js/translations.js"></script>
    <script src="js/i18n.js"></script>
</body>
</html>
