<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ì“°ë ˆë“œ - ë²•ë¬´ë²•ì¸ ë¡œì—°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/ui-components.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .thread-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            background: white;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }

        /* Thread Header */
        .thread-header {
            padding: 20px 24px;
            border-bottom: 2px solid #f3f4f6;
            background: white;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #f3f4f6;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #e5e7eb;
        }

        .thread-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .service-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .service-meta {
            color: #6b7280;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Thread Main */
        .thread-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
            font-size: 16px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .message-content {
            max-width: 65%;
        }

        .message-sender {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .message-bubble {
            background: white;
            padding: 14px 18px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            line-height: 1.6;
            color: #374151;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .message-file {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-file:hover {
            background: #e5e7eb;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #3182F6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .file-size {
            font-size: 12px;
            color: #9ca3af;
        }

        /* System Message */
        .system-message {
            text-align: center;
            margin: 30px 0;
        }

        .system-message-content {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: white;
            border-top: 2px solid #f3f4f6;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-controls {
            display: flex;
            gap: 8px;
        }

        .input-btn {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .input-btn:hover {
            background: #f3f4f6;
            border-color: #3182F6;
            color: #3182F6;
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #3182F6;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            transform: none;
        }

        /* Sidebar */
        .thread-sidebar {
            width: 320px;
            background: #f9fafb;
            border-left: 2px solid #f3f4f6;
            overflow-y: auto;
            padding: 24px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-size: 15px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .document-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            border-color: #3182F6;
            background: #f0f4ff;
        }

        .document-icon {
            width: 36px;
            height: 36px;
            background: #3182F6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .document-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        @media (max-width: 968px) {
            .thread-sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="thread-container">
        <div class="thread-main">
            <div class="thread-header">
                <div class="header-top">
                    <button class="back-btn" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i> ë©”ì¸ìœ¼ë¡œ
                    </button>
                    <div class="status-badge processing" id="statusBadge">ì§„í–‰ì¤‘</div>
                </div>
                <div class="thread-info">
                    <div>
                        <div class="service-title" id="serviceTitle">ë¡œë”© ì¤‘...</div>
                        <div class="service-meta">
                            <span><i class="fas fa-calendar"></i> <span id="threadDate">-</span></span>
                            <span><i class="fas fa-building"></i> ì„¼í„° ë‹´ë‹¹ì</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="system-message">
                    <div class="system-message-content">
                        <i class="fas fa-check-circle"></i> ìƒë‹´ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                </div>

                <!-- ë©”ì‹œì§€ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>

            <div class="input-area" style="border-top: 2px solid #f3f4f6; padding: 16px 24px; background: white;">
                <div class="input-wrapper" style="display: flex; align-items: flex-end; gap: 8px;">
                    <div class="input-controls" style="display: flex; gap: 4px;">
                        <button class="input-btn" onclick="attachFile()" style="width: 40px; height: 40px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; color: #6b7280; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-btn" onclick="attachImage()" style="width: 40px; height: 40px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; color: #6b7280; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="message-input-wrapper" style="flex: 1;">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Shift+Enter: ì¤„ë°”ê¿ˆ, Enter: ì „ì†¡)"
                            rows="1"
                            style="width: 100%; min-height: 40px; max-height: 120px; padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; font-family: 'Noto Sans KR', sans-serif; resize: none; outline: none;"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" style="width: 48px; height: 40px; border: none; background: linear-gradient(135deg, #3182F6 0%, #2563EB 100%); color: white; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
            </div>
        </div>

        <div class="thread-sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-info-circle"></i> ì‹ ì²­ ì •ë³´</h3>
                <div class="info-item">
                    <div class="info-label">ì‹ ì²­ ë²ˆí˜¸</div>
                    <div class="info-value" id="applicationId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì‹ ì²­ì¼</div>
                    <div class="info-value" id="applicationDate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê²°ì œ ê¸ˆì•¡</div>
                    <div class="info-value" id="amount">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì„¼í„° ë‹´ë‹¹ì</div>
                    <div class="info-value">ë²•ë¬´ë²•ì¸ ë¡œì—°</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-file-alt"></i> ì²¨ë¶€ ì„œë¥˜</h3>
                <div id="documentsList">
                    <p style="color: #6B7280; font-size: 14px; padding: 12px 0;">ì•„ì§ ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-clock"></i> ì§„í–‰ í˜„í™©</h3>
                <div class="info-item">
                    <div class="info-label">í˜„ì¬ ë‹¨ê³„</div>
                    <div class="info-value" id="currentStatus">ì ‘ìˆ˜ ì™„ë£Œ</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì˜ˆìƒ ì™„ë£Œì¼</div>
                    <div class="info-value" id="expectedDate">-</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

    <script src="js/ui-components.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ
        let threadId = null;
        let currentUser = null;

        window.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            threadId = urlParams.get('id');

            // Supabase ì„¸ì…˜ í™•ì¸
            const session = await checkSession();
            if (!session || !session.user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }
            
            // í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const profileResult = await getUserProfile(session.user.id);
            if (profileResult.success && profileResult.data) {
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: profileResult.data.name || session.user.email
                };
            } else {
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.email
                };
            }

            loadThread();
            loadMessages();
            
            // ìë™ ë¦¬ì‚¬ì´ì¦ˆ
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        });

        // ì“°ë ˆë“œ ì •ë³´ ë¡œë“œ
        async function loadThread() {
            if (!threadId) return;
            
            try {
                // Supabaseì—ì„œ ì“°ë ˆë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data: thread, error } = await supabase
                    .from('threads')
                    .select('*')
                    .eq('id', threadId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error || !thread) {
                    console.error('ì“°ë ˆë“œ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    alert('ì“°ë ˆë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('âœ… ì“°ë ˆë“œ ì •ë³´:', thread);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('serviceTitle').textContent = thread.service_name || 'ì„œë¹„ìŠ¤ëª… ì—†ìŒ';
                document.getElementById('threadDate').textContent = new Date(thread.created_at).toLocaleDateString('ko-KR');
                document.getElementById('applicationId').textContent = thread.order_id || thread.id;
                document.getElementById('applicationDate').textContent = new Date(thread.created_at).toLocaleDateString('ko-KR');
                
                if (thread.amount > 0) {
                    document.getElementById('amount').textContent = 'â‚©' + thread.amount.toLocaleString();
                } else {
                    document.getElementById('amount').textContent = 'ê²¬ì  í˜‘ì˜ ì¤‘';
                }
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                const statusMap = {
                    'document': 'ì„œë¥˜ ëŒ€ê¸°',
                    'payment': 'ê²°ì œ ì™„ë£Œ',
                    'processing': 'ì§„í–‰ ì¤‘',
                    'completed': 'ì™„ë£Œ'
                };
                document.getElementById('currentStatus').textContent = statusMap[thread.status] || 'ì ‘ìˆ˜ ì™„ë£Œ';
                
                // ì˜ˆìƒ ì™„ë£Œì¼ ì œê±°
                const expectedDate = document.getElementById('expectedDate');
                if (expectedDate) {
                    expectedDate.textContent = '-';
                }
            
            // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
            const statusBadge = document.getElementById('statusBadge');
            const statusMap = {
                'payment': { text: 'ê²°ì œ ì™„ë£Œ', class: 'processing' },
                'document': { text: 'ì„œë¥˜ ìˆ˜ì§‘ ì¤‘', class: 'pending' },
                'processing': { text: 'ì‹ ì²­ ì§„í–‰ ì¤‘', class: 'processing' },
                'completed': { text: 'ì²˜ë¦¬ ì™„ë£Œ', class: 'completed' },
                'archived': { text: 'ì™„ë£Œ (ë³´ê´€)', class: 'completed' }
            };
            
            const status = statusMap[thread.status] || { text: 'ì§„í–‰ ì¤‘', class: 'processing' };
            statusBadge.textContent = status.text;
            statusBadge.className = 'status-badge ' + status.class;
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages() {
            const messagesArea = document.getElementById('messagesArea');
            
            if (!threadId) return;
            
            try {
                // Supabaseì—ì„œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                const result = await getThreadMessages(threadId);
                
                if (result.success && result.data && result.data.length > 0) {
                    // ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
                    messagesArea.innerHTML = '';
                    
                    // ë©”ì‹œì§€ í‘œì‹œ
                    result.data.forEach(msg => {
                        const messageData = {
                            sender: msg.sender_type,
                            name: msg.sender_type === 'user' ? 'ë³¸ì¸' : 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                            content: msg.content,
                            time: new Date(msg.created_at).toLocaleTimeString('ko-KR', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            }),
                            avatar: msg.sender_type === 'user' ? 'ë‚˜' : 'ë¡œ',
                            file_url: msg.file_url,
                            file_name: msg.file_name,
                            file_type: msg.file_type
                        };
                        appendMessage(messageData);
                    });
                } else {
                    // ë©”ì‹œì§€ ì—†ì„ ë•Œ í™˜ì˜ ë©”ì‹œì§€
                    const welcomeMessage = {
                        sender: 'admin',
                        name: 'ë²•ë¬´ë²•ì¸ ë¡œì—°',
                        content: 'ì•ˆë…•í•˜ì„¸ìš”! ë²•ë¬´ë²•ì¸ ë¡œì—° ì¶œì…êµ­ì´ë¯¼ì§€ì›ì„¼í„°ì…ë‹ˆë‹¤.\n\nì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¼í„° ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                        time: new Date().toLocaleTimeString('ko-KR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        avatar: 'ë¡œ'
                    };
                    appendMessage(welcomeMessage);
                }
                
                scrollToBottom();
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function appendMessage(msg) {
            const messagesArea = document.getElementById('messagesArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender}`;
            
            // íŒŒì¼ ì²¨ë¶€ ì—¬ë¶€ í™•ì¸
            let fileHtml = '';
            if (msg.file_url && msg.file_name) {
                const fileIcon = getFileIcon(msg.file_type);
                fileHtml = `
                    <div class="message-file" onclick="downloadFile('${msg.file_url}', '${msg.file_name}')">
                        <div class="file-icon">${fileIcon}</div>
                        <div class="file-info">
                            <div class="file-name">${msg.file_name}</div>
                            <div class="file-size">í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</div>
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${msg.avatar}</div>
                <div class="message-content">
                    <div class="message-sender">${msg.name}</div>
                    <div class="message-bubble">${msg.content}</div>
                    ${fileHtml}
                    <div class="message-time">${msg.time}</div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
        }
        
        // íŒŒì¼ íƒ€ì…ë³„ ì•„ì´ì½˜ ë°˜í™˜
        function getFileIcon(fileType) {
            if (!fileType) return 'ğŸ“„';
            
            if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (fileType.includes('pdf')) return 'ğŸ“•';
            if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“';
            if (fileType.includes('excel') || fileType.includes('sheet')) return 'ğŸ“Š';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'ğŸ“¦';
            
            return 'ğŸ“„';
        }
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadFile(fileUrl, fileName) {
            try {
                // ìƒˆ íƒ­ì—ì„œ íŒŒì¼ ì—´ê¸°
                window.open(fileUrl, '_blank');
                showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success', 2000);
            } catch (error) {
                console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 2000);
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                return;
            }

            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');

            try {
                // Supabaseì— ë©”ì‹œì§€ ì €ì¥
                const result = await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: content
                });
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                // UIì— ë©”ì‹œì§€ ì¶”ê°€
                const message = {
                    sender: 'user',
                    name: 'ë³¸ì¸',
                    content: content,
                    time: time,
                    avatar: 'ë‚˜'
                };
                
                appendMessage(message);
                input.value = '';
                input.style.height = 'auto';
                scrollToBottom();
                
                showToast('ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 2000);
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                showToast('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 2000);
            }
        }

        // íŒŒì¼ ì²¨ë¶€
        function attachFile() {
            document.getElementById('fileInput').click();
        }

        function attachImage() {
            const input = document.getElementById('fileInput');
            input.accept = 'image/*';
            input.click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error', 3000);
                return;
            }
            
            showToast('íŒŒì¼ ì—…ë¡œë“œ ì¤‘...', 'info', 2000);
            
            try {
                // Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ
                const uploadResult = await uploadThreadDocument(threadId, file);
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error);
                }
                
                console.log('âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', uploadResult.data);
                
                // ë©”ì‹œì§€ë¡œ íŒŒì¼ ì •ë³´ ì „ì†¡
                const messageResult = await createMessage({
                    thread_id: threadId,
                    sender_type: 'user',
                    content: `íŒŒì¼ ì²¨ë¶€: ${file.name}`,
                    file_url: uploadResult.data.signedUrl,
                    file_name: file.name,
                    file_type: file.type
                });
                
                if (!messageResult.success) {
                    throw new Error(messageResult.error);
                }
                
                showToast(`${file.name} íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success', 3000);
                
                // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMessages();
                
                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                event.target.value = '';
                
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 3000);
            }
        }

        // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Enter í‚¤ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js?v=7"></script>
</body>
</html>
